!function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,i){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=127)}({1:function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});t.CubeError=function e(t,r){i(this,e),this.code=t,this.message=r}},127:function(e,t,r){"use strict";var i=r(23),n=r(77),o=r(76),a=(function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);t.default=e}(o),r(50));!function(e){e.CubeWhiteboardListener=i.WhiteboardListener,e.CubeWhiteboardServiceWorker=n.WhiteboardServiceWorker,e.CubeWhiteboard=a.Whiteboard,e.addEventListener("load",function(){for(var t=e.cube.services.values(),r=0;r<t.length;r++){var i=t[r];i instanceof CubeWhiteboardServiceWorker&&i.delegate.onReady(i)}},!1)}(window)},128:function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.WhiteboardService=function(e){function t(){return i(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),a(t,[{key:"setTransparency",value:function(e){}},{key:"adjustSize",value:function(){}},{key:"resize",value:function(e,t){}},{key:"shareWith",value:function(e){}},{key:"revokeSharing",value:function(e){}},{key:"setPermission",value:function(e){}},{key:"isSharing",value:function(e){}},{key:"queryRecords",value:function(e,t,r,i){}},{key:"querySharedRecords",value:function(e,t,r,i){}},{key:"loadRecordData",value:function(e,t){}},{key:"unselect",value:function(e){}},{key:"selectEntity",value:function(e){}},{key:"setOffline",value:function(e){}},{key:"isOffline",value:function(){}},{key:"undo",value:function(e){}},{key:"redo",value:function(e){}},{key:"erase",value:function(e,t){}},{key:"cleanup",value:function(e){}},{key:"getZoomRatio",value:function(){}},{key:"zoom",value:function(e){}},{key:"resetView",value:function(){}},{key:"numPaperElements",value:function(){}},{key:"getSlide",value:function(){}},{key:"shareAsSlide",value:function(e,t){}},{key:"workAsSlide",value:function(e,t){}},{key:"getExEntity",value:function(e){}},{key:"exportMessage",value:function(e){}},{key:"importMessage",value:function(e){}},{key:"exportContent",value:function(e){}},{key:"importContent",value:function(e){}},{key:"getRecorder",value:function(){}},{key:"getPlayer",value:function(){}},{key:"querySharedList",value:function(e,t){}},{key:"searchSharedFile",value:function(e,t,r){}},{key:"deleteSharedFile",value:function(e,t,r){}},{key:"setBackgroundImage",value:function(e,t){}},{key:"setBackgroundColor",value:function(e){}},{key:"createWhiteboard",value:function(e,t,r){}},{key:"inviteWhiteboard",value:function(e,t){}},{key:"rejectWhiteboard",value:function(e){}},{key:"removeWhiteboard",value:function(e){}},{key:"queryById",value:function(e){}}]),t}(CubeService)},129:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Action={UploadFile:"/sharing/uploadfile",FileProcess:"/sharing/uploadprocess",ConvertProcess:"/sharing/convertprocess"}},23:function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.WhiteboardListener=function(e){function t(){return i(this,t),n(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),a(t,[{key:"onReady",value:function(e){}},{key:"onShared",value:function(e,t){}},{key:"onPassiveShared",value:function(e,t){}},{key:"onRevoked",value:function(e,t){}},{key:"onFileProgress",value:function(e,t){}},{key:"onFileShared",value:function(e,t){}},{key:"onSlide",value:function(e,t){}},{key:"onCleanup",value:function(e){}},{key:"onFailed",value:function(e,t){}},{key:"onCreate",value:function(e){}},{key:"onWhiteboardInviteResponded",value:function(e,t,r){}},{key:"onWhiteboardInvite",value:function(e,t){}},{key:"onReject",value:function(e,t){}},{key:"onRemove",value:function(e){}},{key:"onQueryById",value:function(e){}}]),t}(CubeListener)},50:function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Whiteboard=void 0;var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();r(23),t.Whiteboard=function(){function e(t,r,n,o,a){var s=this;i(this,e),this.whiteboardId="string"==typeof o?o:e.generateSerialNumber().toString(),this.name=r,this.shares=[],this.isShared=!1,this.view=[],this.delay=0,this.core=new CubeWhiteboardCoreServiceWorker(n,this.whiteboardId,t.session.name),this.core.setResourcePath(t.resourcePath+"/whiteboard"),this.core.setListener({onSlideOpened:function(e){a.delegate.onFileShared(a,e.file),console.log("FileShared success")},onSlideChanged:function(e){a.delegate.onSlide(a,e),console.log("handle Slide success")},onCleanup:function(){a.delegate.onCleanup(a),console.log("Clear success")},onChange:function(e){if(!a.offline){var r=new ActionDialect,i=CubeConst.ActionRestrain;if(e.command)i=CubeConst.ActionVGCmd,e.from=t.session.name;else if(null===s.sharedList)return;r.setAction(i),r.appendParam("param",e);var n=function(){nucleus.talkService.talk(CELLET.Whiteboard,r)||(a.delegate.onFailed(a,CubeStateCode.RequestTimeout),console.log("Network error , code: "+CubeStateCode.RequestTimeout))};s.delay>0?setTimeout(n,s.delay):n()}},onFailed:function(e){a.delegate.onFailed(a,e),console.log("onFailed code is "+e)}})}return n(e,[{key:"getWhiteboardId",value:function(){return this.whiteboardId}},{key:"getName",value:function(){return this.name}},{key:"getShares",value:function(){return this.shares}},{key:"setDelay",value:function(e){this.delay=e}}],[{key:"generateSerialNumber",value:function(){(null==this.gCounts||this.gCounts>=99)&&(this.gCounts=0),++this.gCounts;var e=[],t=new Date,r=t.getDate(),i=t.getHours(),n=t.getMinutes(),o=t.getSeconds();e.push(window.cube._cube_token),e.push(r>9?r:"0"+r),e.push(i>9?i:"0"+i),e.push(n>9?n:"0"+n),e.push(o>9?o:"0"+o),e.push(this.gCounts>9?this.gCounts:"0"+this.gCounts);var a=e.join("");return e.splice(0,e.length),e=null,a=Number(a)}}]),e}()},76:function(e,t,r){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,i){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=16)}([function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.GraphicsEntity=void 0;var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=r(1);t.GraphicsEntity=function(){function e(t){i(this,e),this.name=t,this.board=null,this.exclusive=!1}return n(e,[{key:"setColor",value:function(e){this.color=e}},{key:"setBorderColor",value:function(e){this.borderColor=e}},{key:"setLineWeight",value:function(e){this.weight=e}},{key:"setBorderWidth",value:function(e){this.borderWidth=e}},{key:"dispose",value:function(){this.board=null}},{key:"getCursorPos",value:function(e){var t=o.Utils.getCursorPosition(e),r=t.x,i=t.y,n=this.board.paperDom.createSVGPoint();return n.x=r,n.y=i,n=n.matrixTransform(this.board.paperDom.getScreenCTM().inverse()),r=n.x,i=n.y,{x:r,y:i}}},{key:"onDraw",value:function(e){}},{key:"onResize",value:function(e,t){}},{key:"onClick",value:function(e){}},{key:"onMouseMove",value:function(e){}},{key:"onMouseDown",value:function(e){}},{key:"onMouseUp",value:function(e){}},{key:"onTouchMove",value:function(e){}},{key:"onTouchStart",value:function(e){}},{key:"onTouchEnd",value:function(e){}},{key:"onKeyPress",value:function(e){}}]),e}()},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=navigator.userAgent.toLowerCase();t.Utils={isIPhone:"iphone os"==i.match(/iphone os/i),isAndroid:"android"==i.match(/android/i),getElementChildren:function(e){if(e.children)return e.children;for(var t=[],r=e.childNodes,i=0;i<r.length;++i)1===r[i].nodeType&&t.push(r[i]);return t},getCursorPosition:function(e){return void 0===e.touches?{x:e.clientX||e.pageX,y:e.clientY||e.pageY}:e.touches.length>0?{x:e.touches[0].pageX||e.touches[0].clientX||e.clientX,y:e.touches[0].pageY||e.touches[0].clientY||e.clientY}:{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}},getDrawPosition:function(e,t){var r=void 0===t.touches?this.getMousePos(t):this.getTouchPos(t),i=this.getX(e),n=this.getY(e);return{x:r.x-i,y:r.y-n}},getMousePos:function(e){var t=e||window.event,r=document.documentElement.scrollLeft||document.body.scrollLeft,i=document.documentElement.scrollTop||document.body.scrollTop;return{x:t.pageX||t.clientX+r,y:t.pageY||t.clientY+i}},getTouchPos:function(e){var t=e||window.event,r=document.documentElement.scrollLeft||document.body.scrollLeft,i=document.documentElement.scrollTop||document.body.scrollTop;return{x:t.touches[0].pageX||t.clientX+r,y:t.touches[0].pageY||t.clientY+i}},getX:function(e){for(var t=e.offsetLeft,r=e;null!=(r=r.offsetParent);)t+=r.offsetLeft;return t},getY:function(e){for(var t=e.offsetTop,r=e;null!=(r=r.offsetParent);)t+=r.offsetTop;return t},fixNumber:function(e){var t=new Number(e);return Number(t.toFixed(2))},fixNumberToString:function(e){return new Number(e).toFixed(2)},unselectable:function(e){e.setAttribute("unselectable","on"),e.onmousedown=function(){return!1};var t=e.style;t.userSelect="none",t.webkitUserSelect="none",t.MozUserSelect="-moz-none"}}},function(e,t,r){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":i(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":i(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.SlideEntity=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(0),l=r(6);t.SlideEntity=function(e){function t(e,r,i){n(this,t);var a=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.Name));return a.file=null,a.obscure=!1,a.from=null,a.group=null,a.cursor=0,a.presentedImage=null,a.presentedWidth=0,a.presentedHeight=0,a.scale=1,a.prevImage=null,a.prevWidth=0,a.prevHeight=0,a.nextImage=null,a.nextWidth=0,a.nextHeight=0,a.pageLock=!1,a.loadedImageList=[],a.loadedImageSizes=[],a.changedCallback=null,a.notes=null,a.restore=!0,a.isFirstSharing=!1,a.exclusive=!1,a.file=e,a.obscure=void 0!==r&&r,void 0!==i&&(a.cursor=i-1),a}return a(t,e),s(t,null,[{key:"Name",get:function(){return"slide"}}]),s(t,[{key:"getSize",value:function(){return{width:this.presentedWidth,height:this.presentedHeight}}},{key:"getPosition",value:function(){if(null!=this.presentedImage&&null!=this.presentedImage.node)return{x:parseInt(this.presentedImage.node.getAttribute("x")),y:parseInt(this.presentedImage.node.getAttribute("y"))}}},{key:"getDocName",value:function(){return this.file.origin}},{key:"currentPage",value:function(){return this.cursor+1}},{key:"numPages",value:function(){return this.file.urls.length}},{key:"prevPage",value:function(){if(0!=this.cursor&&!this.pageLock){this.pageLock=!0,this.board.erase(!0,!1),this.board.showMask();var e=this,t=e.cursor-1;null==e.prevImage?e._loadImage(e.board.paper,e.file.urls[t],function(t,r,i){e._backupImage(t,r,i),e.prevImage=t,e.prevWidth=r,e.prevHeight=i,e._page(e.prevImage,function(){e.cursor-=1,e._preparePrev(),e.restore&&e.restoreNote(e.cursor+1),e.pageLock=!1,e.board.hideMask()})},function(t){e.board.delegate.onFailed(e.board,CubeErrorCode.LoadFileFailed),e.pageLock=!1,e.board.hideMask()}):e._page(e.prevImage,function(){e.cursor-=1,e._preparePrev(),e.restore&&e.restoreNote(e.cursor+1),e.pageLock=!1,e.board.hideMask()})}}},{key:"nextPage",value:function(){if(!(this.cursor>=this.file.urls.length-1||this.pageLock)){this.pageLock=!0,this.board.erase(!0,!1),this.board.showMask();var e=this,t=e.cursor+1;null==e.nextImage?e._loadImage(e.board.paper,e.file.urls[t],function(t,r,i){e._backupImage(t,r,i),e.nextImage=t,e.nextWidth=r,e.nextHeight=i,e._page(e.nextImage,function(){e.cursor+=1,e._prepareNext(),e.restore&&e.restoreNote(e.cursor+1),e.pageLock=!1,e.board.hideMask()})},function(t){e.board.delegate.onFailed(e.board,CubeErrorCode.LoadFileFailed),e.pageLock=!1,e.board.hideMask()}):e._page(e.nextImage,function(){e.cursor+=1,e._prepareNext(),e.restore&&e.restoreNote(e.cursor+1),e.pageLock=!1,e.board.hideMask()})}}},{key:"gotoPage",value:function(e){var t=e-1;if(!(t==this.cursor||t<0||t>this.file.urls.length-1)){this.board.erase(!0,!1),this.board.showMask();var r=this,i=function(){if(null!=r.prevImage&&r.prevImage.remove(),null!=r.nextImage&&r.nextImage.remove(),null!=r.presentedImage&&r.presentedImage.remove(),r._loadImage(r.board.paper,r.file.urls[t],function(e,t,i){r._presentImage(e,t,i),r.board.hideMask()},function(e){r.board.delegate.onFailed(r.board,CubeErrorCode.LoadFileFailed),r.board.hideMask()}),t>0&&r._loadImage(r.board.paper,r.file.urls[t-1],function(e,t,i){r._backupImage(e,t,i),r.prevImage=e,r.prevWidth=t,r.prevHeight=i}),t<r.file.urls.length-1&&r._loadImage(r.board.paper,r.file.urls[t+1],function(e,t,i){r._backupImage(e,t,i),r.nextImage=e,r.nextWidth=t,r.nextHeight=i}),r.cursor=t,r.restore&&r.restoreNote(r.cursor+1),r.pageLock=!1,null!=r.changedCallback&&r.changedCallback.call(r.board,r,"="),!r.obscure){var e={whiteboardId:r.board.name,from:r.board.sessionName,command:{name:"slide",param:r.file,attr:{cursor:r.cursor,page:"="}}};this.board.triggerChange(e)}};this.pageLock?setTimeout(function(){r.pageLock=!0,i()},200):i()}}},{key:"reload",value:function(){var e=this;e.board.showMask(),e._loadImage(e.board.paper,e.file.urls[e.cursor],function(t,r,i){e._presentImage(t,r,i),e.board.hideMask()},function(t){e.board.delegate.onFailed(e.board,CubeErrorCode.LoadFileFailed),e.board.hideMask()})}},{key:"dispose",value:function(){this.board.hideMask(),null!=this.presentedImage&&(this.presentedImage.remove(),this.presentedImage=null),null!=this.nextImage&&(this.nextImage.remove(),this.nextImage=null),null!=this.prevImage&&(this.prevImage.remove(),this.prevImage=null),this.board.dom.style.overflow="hidden",this.board.viewport.reset(),this.faultListener=null,u.GraphicsEntity.prototype.dispose.call(this)}},{key:"appendNote",value:function(e){var t=this.cursor+1;if(void 0!==e.page&&null!=e.page&&(t=e.page),null==this.notes){this.notes=new HashMap;var r=new l.SlideNote(t);r.append(e),this.notes.put(t,r)}else{var r=this.notes.get(t);null==r?(r=new l.SlideNote(t),r.append(e),this.notes.put(t,r)):r.append(e)}}},{key:"popNote",value:function(){if(null==this.notes)return null;var e=this.cursor+1,t=this.notes.get(e);return null==t?null:t.pop()}},{key:"clearNote",value:function(){if(null!=this.notes){var e=this.cursor+1,t=this.notes.get(e);null!=t&&(this.notes.remove(e),t.clear())}}},{key:"restoreNote",value:function(e){if(null!=this.notes){this.board.erase(!0,!1);var t=this.notes.get(e);if(null!=t)for(var r=t.records,i=0;i<r.length;++i)this.board._replayRecord(r[i])}}},{key:"exportPage",value:function(e){var t=this;if(0==e||e-1>=t.file.urls.length)return null;var r=null;null!=t.notes&&(r=t.notes.get(e));var i={page:e,url:t.file.urls[e-1]};if(null!=r){i.notes=[];for(var n=0;n<r.records.length;++n){var o=r.records[n],a={sn:o.sn,type:o.type,raw:o.raw,time:o.time};i.notes.push(a)}}return i}},{key:"onDraw",value:function(e){var r=this,i=r.board.getExEntity(t.Name);null!=i&&i.dispose(),r.changedCallback=r.board.onSlideChanged,r.board.showMask(),r._loadImage(e,r.file.urls[r.cursor],function(e,t,i){if(r._presentImage(e,t,i),!r.obscure){var n={whiteboardId:r.board.name,from:r.board.sessionName,command:{name:"slide",param:r.file,attr:{cursor:r.cursor,page:"*"}}};r.isFirstSharing&&(n.command.upload=!0,r.isFirstSharing=!1),r.board.triggerChange(n)}r.changedCallback.call(r.board,r,"*"),r.board.hideMask()},function(e){r.board.delegate.onFailed(r.board,CubeErrorCode.LoadFileFailed),r.board.hideMask()}),r.file.urls.length>1&&r.cursor+1<r.file.urls.length&&r._loadImage(e,r.file.urls[r.cursor+1],function(e,t,i){r._backupImage(e,t,i),r.nextImage=e,r.nextWidth=t,r.nextHeight=i})}},{key:"onResize",value:function(e,t){this._adjustImagePos(this.presentedImage,this.presentedWidth,this.presentedHeight,e,t),this._adjustImagePos(this.prevImage,this.prevWidth,this.prevHeight,e,t),this._adjustImagePos(this.nextImage,this.nextWidth,this.nextHeight,e,t)}},{key:"onClick",value:function(e){}},{key:"onKeyPress",value:function(e){if(!this.obscure){var t=e.which||e.keyCode;39==t||93==t?this.nextPage():37!=t&&91!=t||this.prevPage()}}},{key:"_presentImage",value:function(e,t,r){var i=this;i.presentedImage=e,i.presentedWidth=t,i.presentedHeight=r,null==e.node?setTimeout(function(){i._adjustImagePos(e,t,r,i.board.width,i.board.height)},40):i._adjustImagePos(e,t,r,i.board.width,i.board.height),e.attr("opacity",1),e.toBack(),null!=i.prevImage&&i.prevImage.toBack(),null!=i.nextImage&&i.nextImage.toBack()}},{key:"_backupImage",value:function(e,t,r){var i=this;null==e.node?setTimeout(function(){i._adjustImagePos(e,t,r,i.board.width,i.board.height)},40):i._adjustImagePos(e,t,r,i.board.width,i.board.height),e.attr("opacity",0),e.toBack()}},{key:"_preparePrev",value:function(){var e=this;if(!e.obscure){var t={whiteboardId:e.board.name,from:e.board.sessionName,command:{name:"slide",param:e.file,attr:{cursor:e.cursor,page:"<"}}};this.board.triggerChange(t)}if(null!=this.nextImage&&this.nextImage.remove(),this.nextImage=this.presentedImage,this.presentedImage=this.prevImage,0==this.cursor)return this.prevImage=null,void(null!=this.changedCallback&&this.changedCallback.call(this.board,this,"<"));e._loadImage(e.board.paper,e.file.urls[e.cursor-1],function(t,r,i){e._backupImage(t,r,i),e.prevImage=t,e.prevWidth=r,e.prevHeight=i,null!=e.changedCallback&&e.changedCallback.call(e.board,e,"<")})}},{key:"_prepareNext",value:function(){var e=this;if(!e.obscure){var t={whiteboardId:e.board.name,from:e.board.sessionName,command:{name:"slide",param:e.file,attr:{cursor:e.cursor,page:">"}}};this.board.triggerChange(t)}if(null!=this.prevImage&&this.prevImage.remove(),this.prevImage=this.presentedImage,this.presentedImage=this.nextImage,this.cursor+1>=this.file.urls.length-1)return this.nextImage=null,void(null!=this.changedCallback&&this.changedCallback.call(this.board,this,">"));e._loadImage(e.board.paper,e.file.urls[e.cursor+1],function(t,r,i){e._backupImage(t,r,i),e.nextImage=t,e.nextWidth=r,e.nextHeight=i,null!=e.changedCallback&&e.changedCallback.call(e.board,e,">")})}},{key:"_page",value:function(e,t){null!=this.presentedImage&&(this.presentedImage.animate({opacity:0},300,"linear"),e.animate({opacity:1},300,"linear",function(){t.call(null)}))}},{key:"_loadImage",value:function(e,t,r,i){var n=this.loadedImageList.indexOf(t);if(n>=0){var o=this.loadedImageSizes[n],a=e.image(t,0,0,o.width,o.height);a.node.setAttribute("unselectable","on"),a.node.onmousedown=function(){return!1};var s=a.node.style;return s.userSelect="none",s.webkitUserSelect="none",s.MozUserSelect="-moz-none",void r.call(null,a,o.width,o.height)}var u=this,l=new Image;l.onload=function(i){var n=l.width,o=l.height;u.loadedImageList.push(t.toString()),u.loadedImageSizes.push({width:n,height:o});var a=e.image(t,0,0,n,o);a.node.setAttribute("unselectable","on"),a.node.onmousedown=function(){return!1};var s=a.node.style;s.userSelect="none",s.webkitUserSelect="none",s.MozUserSelect="-moz-none",r.call(null,a,n,o)},void 0!==i&&(l.onerror=function(e){i.call(null,t)}),l.src=t}},{key:"_adjustImagePos",value:function(e,t,r,i,n){if(null!=e&&null!=e.node){var o=.5*(this.board.paperWidth-t),a=.5*(this.board.paperHeight-r);e.node.setAttribute("x",parseInt(o)),e.node.setAttribute("y",parseInt(a))}}}]),t}(u.GraphicsEntity)},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.WhiteboardCoreListener=function(){function e(){i(this,e)}return n(e,[{key:"onSlideOpened",value:function(e){}},{key:"onSlideChanged",value:function(e){}},{key:"onCleanup",value:function(){}},{key:"onChange",value:function(e){}},{key:"onFailed",value:function(e){}}]),e}()},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardPlayer=void 0;var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=r(2);t.WhiteboardPlayer=function(){function e(t){i(this,e),this.board=t,this.data=null,this.listener=null,this.tickTimer=0,this.timestamp=0,this.timeDelta=0,this.timeCursor=0,this.timeline=null}return n(e,[{key:"setListener",value:function(e){this.listener=e}},{key:"play",value:function(){if(this.isPlaying()||null==this.data)return!1;if(null!=this.board.recorder&&this.board.recorder.isRecording())return!1;if(this.board.cleanup(!0),void 0!==this.data.slideFile){var e=new o.SlideEntity(this.data.slideFile,!0,this.data.beginPage);this.board.selectEntity(e)}var t=this;this.tickTimer=setTimeout(function(){if(null!=t.listener&&t.listener.onStarted(t),void 0!==t.data.currents)for(var e=0;e<t.data.currents.length;++e)t.board._replayRecord(t.data.currents[e],!0);t._tick()},200),this.timestamp=Date.now(),this.timeCursor=0;for(var r=0;r<this.data.timeline.length;++r)this.timeline.push(this.data.timeline[r]);return!0}},{key:"stop",value:function(){this.tickTimer>0&&(clearTimeout(this.tickTimer),this.tickTimer=0),this._stop()}},{key:"pause",value:function(){null!=this.data&&0!=this.timeline.length&&(this.tickTimer>0&&(clearTimeout(this.tickTimer),this.tickTimer=0),this.timeDelta=Date.now()-this.timeCursor,null!=this.listener&&this.listener.onPaused(this))}},{key:"resume",value:function(){if(!(this.tickTimer>0||null==this.data||0==this.timeline.length)){this.timestamp=Date.now()+this.timeDelta;var e=this;setTimeout(function(){e._tick()},30),null!=this.listener&&this.listener.onResumed(this)}}},{key:"isPlaying",value:function(){return this.tickTimer>0}},{key:"importData",value:function(e){this.data=e,this.timeline=new Array}},{key:"_stop",value:function(){null!=this.listener&&this.listener.onStopped(this)}},{key:"_fetchAndPresent",value:function(){var e=Date.now(),t=this.timeline[0];if(t.time-this.data.start<=e-this.timestamp)if(this.timeline.shift(),"vg"==t.category)this.board._replayRecord(t,!0,{dur:400});else if("opt"==t.category)if("undo"==t.name)this.board.undo(!0);else if("redo"==t.name)this.board.redo(!0);else if("erase"==t.name)this.board.erase(!0);else if("slide"==t.name){var r=this.board.getSlide();null!=r&&r.currentPage()!=t.page&&r.gotoPage(t.page)}return this.timeCursor=e,0!=this.timeline.length}},{key:"_tick",value:function(){if(this.tickTimer>0&&(clearTimeout(this.tickTimer),this.tickTimer=0),!this._fetchAndPresent())return void this._stop();var e=this;this.tickTimer=setTimeout(function(){e._tick()},300)}}]),e}()},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.WhiteboardRecorder=function(){function e(t){i(this,e),this.board=t,this.timeline=[],this.recording=!1,this.listener=null,this.start=0,this.currents=null,this.slide=null,this.beginPage=-1,this.pauseRecorder=!1,this._pauseRecorder=null,this._resumeRecorder=null}return n(e,[{key:"setListener",value:function(e){this.listener=e}},{key:"startRecording",value:function(){var e=this;if(this.recording)return!1;if(null!=this.board.player&&this.board.player.isPlaying())return!1;if(this.recording=!0,this._pauseRecorder=function(){if(e.pauseRecorder)return!1;e.pauseRecorder=!0,e.recording=!1,null!=e.listener&&e.listener.onPaused(e)},this._resumeRecorder=function(){if(!e.pauseRecorder)return!1;e.recording=!0,e.pauseRecorder=!1,null!=e.listener&&e.listener.onResumed(e)},this.slide=this.board.getSlide(),null!=this.slide?this.beginPage=this.slide.currentPage():this.beginPage=-1,this.pauseRecorder)return!1;var t=this.board.pastRecords.length;if(t>0){this.currents=[];for(var r=0;r<t;++r)this._notifyRecord(this.board.pastRecords[r],this.currents)}else this.currents=null;return this.timeline.splice(0,this.timeline.length),this.start=Date.now(),null!=this.listener&&this.listener.onStarted(this),!0}},{key:"pauseRecording",value:function(){return void 0!==this._pauseRecorder&&"function"==typeof this._pauseRecorder&&this._pauseRecorder()}},{key:"resumeRecording",value:function(){return void 0!==this._resumeRecorder&&"function"==typeof this._resumeRecorder&&this._resumeRecorder()}},{key:"stopRecording",value:function(){return!!this.recording&&(this.recording=!1,this.pauseRecorder=!1,null!=this.listener&&this.listener.onStopped(this),!0)}},{key:"isRecording",value:function(){return this.recording}},{key:"exportData",value:function(e){if(this.recording||this.pauseRecorder)return null;var t=this,r=0;void 0!==e&&(r=e-t.start);var i={start:t.start,delta:r,timeline:t.timeline};return null!=this.currents&&(i.currents=this.currents),null!=this.slide&&(i.slideFile=this.slide.file,i.beginPage=this.beginPage),i}},{key:"_notifyOperation",value:function(e){this.recording&&!this.pauseRecorder&&(e.category="opt",this.timeline.push(e))}},{key:"_notifyRecord",value:function(e,t){if(this.recording&&!this.pauseRecorder){var r={category:"vg",sn:e.sn,type:e.type,raw:e.raw,time:e.time};void 0===t?this.timeline.push(r):t.push(r)}}}]),e}()},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.SlideNote=function(){function e(t){i(this,e),this.page=t,this.records=[]}return n(e,[{key:"append",value:function(e){this.records.push(e)}},{key:"pop",value:function(){return this.records.pop()}},{key:"clear",value:function(){0!==this.records.length&&this.records.splice(0,this.records.length)}}]),e}()},function(e,t,r){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":i(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":i(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.ArrowEntity=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(0),l=r(1);t.ArrowEntity=function(e){function t(e){n(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.Name));return r.weight=4,r.color="#FE0000",r.flag=!1,r.startPos=null,r.endPos=null,r.arrow=null,r.drawTimer=0,r.drawEl=null,r.exclusive=!0,void 0!==e&&(r.weight=(e.weight||2)+2,r.color=e.color||"#FE0000"),r}return a(t,e),s(t,null,[{key:"Name",get:function(){return"arrow"}}]),s(t,[{key:"setLineWeight",value:function(e){this.weight=e+2}},{key:"fireBegin",value:function(e){this.flag=!0,this.startPos=this.getCursorPos(e),this.drawTimer>0&&(clearTimeout(this.drawTimer),this.drawTimer=0),this.arrow="url("+this.board._matcheArrow(this.color)+")"}},{key:"fireEnd",value:function(e){if(this.flag=!1,this.drawTimer>0&&(clearTimeout(this.drawTimer),this.drawTimer=0),null!=this.drawEl&&this.drawEl.remove(),this.endPos=this.getCursorPos(e),this.drawEl=this.draw(this.startPos,this.endPos),null!=this.drawEl){var r=this.startPos.x,i=this.startPos.y,n=this.endPos.x,o=this.endPos.y,a=this,s={x1:l.Utils.fixNumber(r),y1:l.Utils.fixNumber(i),x2:l.Utils.fixNumber(n),y2:l.Utils.fixNumber(o)},u={stroke:a.color,strokeWidth:a.weight},h=a.board.record(t.Name,a.drawEl,{param:s,attr:u}),c={whiteboardId:a.board.name,command:{name:"arrow",sn:h,param:s,attr:u}},d=this.board.getSlide();null!=d&&(c.command.page=d.cursor+1),this.board.triggerChange(c),this.drawEl=null}}},{key:"fireMove",value:function(e){if(this.flag&&!(this.drawTimer>0)){var t=this;this.drawTimer=setTimeout(function(){clearTimeout(t.drawTimer),t.drawTimer=0,null!=t.drawEl&&t.drawEl.remove();var r=t.getCursorPos(e);t.drawEl=t.draw(t.startPos,r)},40)}}},{key:"dispose",value:function(){this.board.paperDom.style.cursor="auto",this.drawTimer>0&&(clearTimeout(this.drawTimer),this.drawTimer=0),u.GraphicsEntity.prototype.dispose.call(this)}},{key:"draw",value:function(e,r){return t._Draw(this.board,e,r,this.color,this.weight,this.arrow)}},{key:"onMouseMove",value:function(e){this.fireMove(e)}},{key:"onMouseDown",value:function(e){this.fireBegin(e)}},{key:"onMouseUp",value:function(e){this.fireEnd(e)}},{key:"onTouchMove",value:function(e){this.fireMove(e)}},{key:"onTouchStart",value:function(e){this.fireBegin(e)}},{key:"onTouchEnd",value:function(e){this.fireEnd(e)}}],[{key:"_Draw",value:function(e,t,r,i,n,o){var a=t.x,s=t.y,u=r.x,h=r.y;if(Math.abs(u-a)<3&&Math.abs(h-s)<3)return null;var c=l.Utils;if(o.length>20){e.paper.setStart();var d=e.paper.path("M"+c.fixNumberToString(a)+","+c.fixNumberToString(s)+" L"+c.fixNumberToString(u)+","+c.fixNumberToString(h));d.attr("stroke",i),d.attr("stroke-width",n),d.attr("stroke-linecap","round");var f=Math.sqrt(Math.pow(Math.abs(u-a),2)+Math.pow(Math.abs(h-s),2)),p=Math.abs(h-s)/f,m=Math.asin(p),v=(Math.PI,n+3),g=v+6,y=f-g,b={x:u,y:h},k={x:u-v,y:h+g},w={x:u+v,y:h+g},C=Math.atan(v/y),E=Math.sqrt(v*v+y*y);if(h<=s&&u>=a){var _=m+C;k.x=a+E*Math.cos(_),k.y=s-E*Math.sin(_),_=m-C,w.x=a+E*Math.cos(_),w.y=s-E*Math.sin(_)}else if(h>s&&u>=a){var _=m+C;k.x=a+E*Math.cos(_),k.y=s+E*Math.sin(_),_=m-C,w.x=a+E*Math.cos(_),w.y=s+E*Math.sin(_)}else if(h>s&&u<a){var _=m+C;k.x=a-E*Math.cos(_),k.y=s+E*Math.sin(_),_=m-C,w.x=a-E*Math.cos(_),w.y=s+E*Math.sin(_)}else{var _=m+C;k.x=a-E*Math.cos(_),k.y=s-E*Math.sin(_),_=m-C,w.x=a-E*Math.cos(_),w.y=s-E*Math.sin(_)}var S=e.paper.path("M"+c.fixNumberToString(b.x)+","+c.fixNumberToString(b.y)+" L"+c.fixNumberToString(k.x)+","+c.fixNumberToString(k.y)+" L"+c.fixNumberToString(w.x)+","+c.fixNumberToString(w.y)+" z");return S.attr("stroke",i),S.attr("stroke-width",n),S.attr("stroke-linecap","butt"),S.attr("fill",i),e.paper.setFinish()}var d=e.paper.path("M"+c.fixNumberToString(a)+","+c.fixNumberToString(s)+" L"+c.fixNumberToString(u)+","+c.fixNumberToString(h));return d.attr("stroke",i),d.attr("stroke-width",n),d.attr("stroke-linecap","round"),d.node.setAttribute("marker-end",o),d}},{key:"draw",value:function(e,r,i){var n="url("+i._matcheArrow(r.attr.stroke)+")",o={x:r.param.x1,y:r.param.y1},a={x:r.param.x2,y:r.param.y2};return t._Draw(i,o,a,r.attr.stroke,r.attr.strokeWidth,n)}},{key:"restore",value:function(e,r,i,n){var o=void 0!==n,a=r.raw.param,s="url("+i._matcheArrow(r.raw.attr.stroke)+")",u={x:a.x1,y:a.y1},l={x:a.x2,y:a.y2},h=t._Draw(i,u,l,r.raw.attr.stroke,o?0:r.raw.attr.strokeWidth,s);r.set=h,o&&h.animate({"stroke-width":r.raw.attr.strokeWidth},n.dur,"linear")}}]),t}(u.GraphicsEntity)},function(e,t,r){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":i(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":i(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.BackgroundImageEntity=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(0);t.BackgroundImageEntity=function(e){function t(e,r){n(this,t);var i=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.Name));return i.source=null,i.obscure=!1,i.domImage=null,i.img=null,i.rawWidth=0,i.rawHeight=0,i.exclusive=!1,i.source=void 0===e?null:e,i.obscure=void 0!==r&&r,i}return a(t,e),s(t,null,[{key:"Name",get:function(){return"bgimage"}}]),s(t,[{key:"dispose",value:function(){var e=this;null!=e.board.bgImage&&(e.board.bgImage.remove(),e.board.bgImage=null),u.GraphicsEntity.prototype.dispose.call(this)}},{key:"onDraw",value:function(){var e=this;if(null==e.source)return void(null!=e.board.bgImage&&(e.board.bgImage.remove(),e.board.bgImage=null));var t=new Image;if(t.onload=function(r){var i=t.width,n=t.height;e.rawWidth=i,e.rawHeight=n,Logger.i("BackgroundImageEntity","Image size: "+i+"x"+n),null!=e.board.bgImage&&(e.board.bgImage.remove(),e.board.bgImage=null),e.img=e.board.paper.image(e.source,0,0,i,n),e.board.bgImage=e.img,null==e.img.node?setTimeout(function(){e.onResize(e.board.width,e.board.height)},60):e.onResize(e.board.width,e.board.height),e.img.toBack(),e.board.bgImage.node.setAttribute("unselectable","on"),e.board.bgImage.node.onmousedown=function(){return!1};var o=e.board.bgImage.node.style;o.userSelect="none",o.webkitUserSelect="none",o.MozUserSelect="-moz-none"},t.src=e.source,!this.obscure){var r={whiteboardId:e.board.name,command:{name:"bgimage",param:e.source}};this.board.triggerChange(r)}}},{key:"onResize",value:function(e,t){if(null!=this.img&&null!=this.img.node){var r=this.rawWidth,i=this.rawHeight,n=e/r,o=t/i;n<o?(this.img.node.setAttribute("width",parseInt(n*r)),this.img.node.setAttribute("height",parseInt(n*i))):(this.img.node.setAttribute("width",parseInt(o*r)),this.img.node.setAttribute("height",parseInt(o*i)));var a=.5*(e-parseInt(this.img.node.getAttribute("width"))),s=.5*(t-parseInt(this.img.node.getAttribute("height")));this.img.node.setAttribute("x",parseInt(a)),this.img.node.setAttribute("y",parseInt(s))}}},{key:"getSource",value:function(){return this.source}}]),t}(u.GraphicsEntity)},function(e,t,r){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":i(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":i(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.EllipseEntity=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(0),l=r(1);t.EllipseEntity=function(e){function t(e){n(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.Name));return r.borderWidth=2,r.borderColor="#FE0000",r.flag=!1,r.startPos=null,r.endPos=null,r.drawTimer=0,r.drawEl=null,r.exclusive=!0,void 0!=e&&(r.borderWidth=e.borderWidth||2,r.borderColor=e.borderColor||"#FE0000"),r}return a(t,e),s(t,null,[{key:"Name",get:function(){return"ellipse"}}]),s(t,[{key:"fireBegin",value:function(e){this.flag=!0,this.startPos=this.getCursorPos(e),this.drawTimer>0&&(clearTimeout(this.drawTimer),this.drawTimer=0)}},{key:"fireEnd",value:function(e){this.flag=!1,this.drawTimer>0&&(clearTimeout(this.drawTimer),this.drawTimer=0),null!=this.drawEl&&this.drawEl.remove(),this.endPos=this.getCursorPos(e),this.draw(this.startPos,this.endPos);var r=this,i={x:r.drawEl.attr("cx"),y:r.drawEl.attr("cy"),rx:r.drawEl.attr("rx"),ry:r.drawEl.attr("ry")},n={stroke:r.borderColor,strokeWidth:r.borderWidth},o=r.board.record(t.Name,r.drawEl,{param:i,attr:n}),a={whiteboardId:r.board.name,command:{name:"ellipse",sn:o,param:i,attr:n}},s=this.board.getSlide();null!=s&&(a.command.page=s.cursor+1),this.board.triggerChange(a),this.drawEl=null}},{key:"fireMove",value:function(e){if(this.flag&&!(this.drawTimer>0)){var t=this;this.drawTimer=setTimeout(function(){clearTimeout(t.drawTimer),t.drawTimer=0,null!=t.drawEl&&t.drawEl.remove();var r=t.getCursorPos(e);t.draw(t.startPos,r)},40)}}},{key:"draw",value:function(e,t){var r=parseInt(.5*(t.x-e.x)),i=parseInt(.5*(t.y-e.y)),n=e.x+r,o=e.y+i;r<0&&(r=Math.abs(r)),i<0&&(i=Math.abs(i));var a=l.Utils;this.drawEl=this.board.paper.ellipse(a.fixNumber(n),a.fixNumber(o),a.fixNumber(r),a.fixNumber(i)),this.drawEl.attr("stroke",this.borderColor),this.drawEl.attr("stroke-width",this.borderWidth),this.drawEl.attr("stroke-linecap","round")}},{key:"onMouseMove",value:function(e){this.fireMove(e)}},{key:"onMouseDown",value:function(e){this.fireBegin(e)}},{key:"onMouseUp",value:function(e){this.fireEnd(e)}},{key:"onTouchMove",value:function(e){this.fireMove(e)}},{key:"onTouchStart",value:function(e){this.fireBegin(e)}},{key:"onTouchEnd",value:function(e){this.fireEnd(e)}}],[{key:"draw",value:function(e,t){var r=e.ellipse(t.param.x,t.param.y,t.param.rx,t.param.ry);return r.attr("stroke",t.attr.stroke),r.attr("stroke-width",t.attr.strokeWidth),r.attr("stroke-linecap","round"),r}},{key:"restore",value:function(e,t,r){var i=void 0!==r,n=e.ellipse(t.raw.param.x,t.raw.param.y,i?0:t.raw.param.rx,i?0:t.raw.param.ry);n.attr("stroke",t.raw.attr.stroke),n.attr("stroke-width",t.raw.attr.strokeWidth),n.attr("stroke-linecap","round"),t.set=n,i&&n.animate({rx:t.raw.param.rx,ry:t.raw.param.ry},r.dur,"linear")}}]),t}(u.GraphicsEntity)},function(e,t,r){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":i(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":i(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.PencilEntity=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(0),l=r(1);t.PencilEntity=function(e){function t(e){n(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.Name));return r.weight=2,r.color="#FE0000",r.lastX=-1,r.lastY=-1,r.lineX=[],r.lineY=[],r.flag=0,r.beginTime=0,r.timer=0,r.queue=[],r.queueTimer=0,r.vgCmdArray=null,r.exclusive=!0,void 0!==e&&(r.weight=e.weight||2,r.color=e.color||"#FE0000"),r}return a(t,e),s(t,null,[{key:"Name",get:function(){return"path"}}]),s(t,[{key:"onDraw",value:function(){this.board.paperDom.style.cursor="url("+this.board.resourcePath+"/cursor_pencil.png), default"}},{key:"onMouseMove",value:function(e){this.fireMove(e)}},{key:"onMouseDown",value:function(e){this.fireStart(e)}},{key:"onMouseUp",value:function(e){this.fireEnd(e)}},{key:"onTouchMove",value:function(e){this.fireMove(e)}},{key:"onTouchStart",value:function(e){this.fireStart(e)}},{key:"onTouchEnd",value:function(e){this.fireEnd(e)}},{key:"fireMove",value:function(e){if(1==this.flag){var t=this.getCursorPos(e);this.lineX.push(t.x),this.lineY.push(t.y)}}},{key:"fireStart",value:function(e){var t=this;this.lineX.splice(0,this.lineX.length),this.lineX.length=0,this.lineY.splice(0,this.lineY.length),this.lineY.length=0;var r=this.getCursorPos(e);this.lineX.push(r.x),this.lineY.push(r.y),this.flag=1,this.beginTime=Date.now(),this.board.paper.setStart(),this.vgCmdArray=[],this.timer>0&&clearTimeout(this.timer),this.timer=setTimeout(function(){clearTimeout(t.timer),t.timer=0,t.draw()},60)}},{key:"fireEnd",value:function(e){if(this.flag=0,this.timer>0&&(clearTimeout(this.timer),this.timer=0),null!=this.vgCmdArray){var r=Date.now(),i=this.vgCmdArray.join(" "),n=this.board.paper.setFinish();n.attr("stroke",this.color),n.attr("stroke-width",this.weight),n.attr("stroke-linecap","round");var o=this.board.record(t.Name,n,{param:i,attr:{stroke:this.color,strokeWidth:this.weight,begin:this.beginTime,end:r}}),a={whiteboardId:this.board.name,command:{name:"path",sn:o,param:i,attr:{stroke:this.color,strokeWidth:this.weight}}},s=this.board.getSlide();null!=s&&(a.command.page=s.currentPage()),this.queue.push(a),this.tick(),this.vgCmdArray.length=0,this.vgCmdArray=null}}},{key:"dispose",value:function(){this.board.paperDom.style.cursor="auto",this.timer>0&&(clearTimeout(this.timer),this.timer=0),u.GraphicsEntity.prototype.dispose.call(this)}},{key:"draw",value:function(){var e=this;if(this.timer>0&&clearTimeout(this.timer),this.lineX.length<=1)return void(this.timer=setTimeout(function(){e.draw()},60));var t=[],r=l.Utils;this.lastX=this.lineX[0],this.lastY=this.lineY[0],t.push("M"+r.fixNumberToString(this.lastX)+","+r.fixNumberToString(this.lastY));for(var i=1;i<this.lineX.length;++i){var n=this.lineX[i],o=this.lineY[i];t.push("L"+r.fixNumberToString(n)+","+r.fixNumberToString(o))}var a=t.join(" ");if(t.length>1){var s=this.board.paper.path(a);s.attr("stroke",this.color),s.attr("stroke-width",this.weight),s.attr("stroke-linecap","round")}t.splice(0,t.length),t=null,this.lastX=this.lineX[this.lineX.length-1],this.lastY=this.lineY[this.lineY.length-1],this.lineX.splice(0,this.lineX.length-1),this.lineY.splice(0,this.lineY.length-1),null==this.vgCmdArray&&(this.vgCmdArray=[]),this.vgCmdArray.push(a),this.timer=setTimeout(function(){e.draw()},60)}},{key:"tick",value:function(){var e=this;if(!(this.queueTimer>0)){if(this.queue.length>0){var t=this.queue.shift();this.board.triggerChange(t)}this.queueTimer=setTimeout(function(){clearTimeout(e.queueTimer),e.queueTimer=0,0!==e.queue.length&&e.tick()},300)}}}],[{key:"draw",value:function(e,t){var r=e.path(t.param);return r.attr("stroke",t.attr.stroke),r.attr("stroke-width",t.attr.strokeWidth),r.attr("stroke-linecap","round"),r}},{key:"restore",value:function(e,t,r){var i=void 0!==r,n=e.path(t.raw.param);n.attr("stroke",t.raw.attr.stroke),n.attr("stroke-width",i?0:t.raw.attr.strokeWidth),n.attr("stroke-linecap","round"),t.set=n,i&&n.animate({"stroke-width":t.raw.attr.strokeWidth},r.dur,"linear")}}]),t}(u.GraphicsEntity)},function(e,t,r){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":i(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":i(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RectEntity=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(0),l=r(1);t.RectEntity=function(e){function t(e){n(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.Name));return r.borderWidth=2,r.borderColor="#FE0000",r.flag=!1,r.startPos=null,r.endPos=null,r.beginTime=0,r.drawTimer=0,r.drawEl=null,r.exclusive=!0,void 0!==e&&(r.borderWidth=e.borderWidth||2,r.borderColor=e.borderColor||"#FE0000"),r}return a(t,e),s(t,null,[{key:"Name",get:function(){return"rect"}}]),s(t,[{key:"fireBegin",value:function(e){this.flag=!0,this.startPos=this.getCursorPos(e),this.drawTimer>0&&(clearTimeout(this.drawTimer),this.drawTimer=0)}},{key:"fireEnd",value:function(e){this.flag=!1,this.drawTimer>0&&(clearTimeout(this.drawTimer),this.drawTimer=0),null!=this.drawEl&&this.drawEl.remove(),this.endPos=this.getCursorPos(e),this.draw(this.startPos,this.endPos);var r=this,i={x:r.drawEl.attr("x"),y:r.drawEl.attr("y"),width:r.drawEl.attr("width"),height:r.drawEl.attr("height")},n={stroke:r.borderColor,strokeWidth:r.borderWidth},o=r.board.record(t.Name,r.drawEl,{param:i,attr:n}),a={whiteboardId:r.board.name,command:{name:"rect",sn:o,param:i,attr:n}},s=this.board.getSlide();null!=s&&(a.command.page=s.cursor+1),this.board.triggerChange(a),this.drawEl=null}},{key:"fireMove",value:function(e){if(this.flag&&!(this.drawTimer>0)){var t=this;this.drawTimer=setTimeout(function(){clearTimeout(t.drawTimer),t.drawTimer=0,null!=t.drawEl&&t.drawEl.remove();var r=t.getCursorPos(e);t.draw(t.startPos,r)},40)}}},{key:"draw",value:function(e,t){var r=e.x,i=e.y,n=t.x-e.x,o=t.y-e.y;n<0&&(r=t.x,n=Math.abs(n)),o<0&&(i=t.y,o=Math.abs(o));var a=l.Utils;this.drawEl=this.board.paper.rect(a.fixNumber(r),a.fixNumber(i),a.fixNumber(n),a.fixNumber(o)),this.drawEl.attr("stroke",this.borderColor),this.drawEl.attr("stroke-width",this.borderWidth),this.drawEl.attr("stroke-linecap","round")}},{key:"onMouseMove",value:function(e){this.fireMove(e)}},{key:"onMouseDown",value:function(e){this.fireBegin(e)}},{key:"onMouseUp",value:function(e){this.fireEnd(e)}},{key:"onTouchMove",value:function(e){this.fireMove(e)}},{key:"onTouchStart",value:function(e){this.fireBegin(e)}},{key:"onTouchEnd",value:function(e){this.fireEnd(e)}}],[{key:"draw",value:function(e,t){var r=e.rect(t.param.x,t.param.y,t.param.width,t.param.height);return r.attr("stroke",t.attr.stroke),r.attr("stroke-width",t.attr.strokeWidth),r.attr("stroke-linecap","round"),r}},{key:"restore",value:function(e,t,r){var i=void 0!==r,n=e.rect(t.raw.param.x,t.raw.param.y,i?0:t.raw.param.width,i?0:t.raw.param.height);n.attr("stroke",t.raw.attr.stroke),n.attr("stroke-width",t.raw.attr.strokeWidth),n.attr("stroke-linecap","round"),t.set=n,i&&n.animate({width:t.raw.param.width,height:t.raw.param.height},r.dur,"linear")}}]),t}(u.GraphicsEntity)},function(e,t,r){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":i(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":i(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.TextEntity=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(0),l=r(1);t.TextEntity=function(e){function t(e){n(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,t.Name));return r.inputDom=null,r.input=!1,r.paperEl=null,r.textPos=null,r.text=null,r.color="#FE0000",r.fontFamily="微软雅黑, 黑体",r.fontSize="16",r.exclusive=!0,void 0!==e&&(r.color=e.color||"#FE0000",r.fontFamily=e.fontFamily||'"Microsoft YaHei"',r.fontSize=e.fontSize||"16"),r}return a(t,e),s(t,null,[{key:"Name",get:function(){return"text"}}]),s(t,[{key:"dispose",value:function(){null!=this.inputDom&&(this.inputDom.remove(),this.inputDom.value=""),null!=this.paperEl&&(this.paperEl=null),this.input=!1,this.textPos=null,u.GraphicsEntity.prototype.dispose.call(this)}},{key:"onClick",value:function(e){if(null==this.inputDom&&(this.inputDom=this._createInputDom()),e.target!=this.inputDom)if(this.input){var r=this.inputDom.value;if(r.length>0){var i=l.Utils.fixNumber(this.textPos.x),n=l.Utils.fixNumber(this.textPos.y),o=this.board.paper.text(i,n,r);o.attr("fill",this.color),o.attr("font-family",this.fontFamily),o.attr("font-size",this.fontSize),this.paperEl=o;var a=this,s={x:i,y:n,text:r.toString()},u=a.board.record(t.Name,o,{param:s,attr:{color:a.color,fontFamily:a.fontFamily,fontSize:a.fontSize}});this.board.viewport.manage(u,o);var h={whiteboardId:a.board.name,command:{name:"text",sn:u,param:s,attr:{color:a.color,fontFamily:a.fontFamily,fontSize:a.fontSize}}},c=this.board.getSlide();null!=c&&(h.command.page=c.cursor+1),this.board.triggerChange(h)}this.inputDom.value="",this.inputDom.remove(),this.input=!1}else{this.textPos=this.getCursorPos(e);var d=l.Utils.getDrawPosition(this.board.dom,e);this.inputDom.style.left=d.x-84+"px",this.inputDom.style.top=d.y-0+"px",this.board.dom.appendChild(this.inputDom),this.inputDom.focus(),this.input=!0}}},{key:"_createInputDom",value:function(){var e=document.createElement("input");return e.setAttribute("type","text"),e.setAttribute("maxlength","128"),e.style.color=this.color,e.style.fontSize=this.fontSize+"px",e.style.fontFamily=this.fontFamily,e.style.position="absolute",e.style.cssFloat="left",e.style.styleFloat="left",e.style.padding="0px",e.style.margin="0px",e.style.width="200px",e.style.textAlign="center",e}}],[{key:"draw",value:function(e,t){var r=e.text(t.param.x,t.param.y,t.param.text);return r.attr("fill",t.attr.color),r.attr("font-family",t.attr.fontFamily),r.attr("font-size",t.attr.fontSize),r}},{key:"restore",value:function(e,t,r){var i=void 0!==r,n=e.text(t.raw.param.x,t.raw.param.y,t.raw.param.text);n.attr("fill",t.raw.attr.color),n.attr("font-family",t.raw.attr.fontFamily),n.attr("font-size",i?0:t.raw.attr.fontSize),t.set=n,i&&n.animate({"font-size":t.raw.attr.fontSize},r.dur,"linear")}}]),t}(u.GraphicsEntity)},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.WhiteboardPlayerListener=function(){function e(){i(this,e)}return n(e,[{key:"onStarted",value:function(e){}},{key:"onStopped",value:function(e){}},{key:"onPaused",value:function(e){}},{key:"onResumed",value:function(e){}}]),e}()},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.WhiteboardRecorderListener=function(){function e(){i(this,e)}return n(e,[{key:"onStarted",value:function(){}},{key:"onStopped",value:function(){}},{key:"onPaused",value:function(){}},{key:"onResumed",value:function(){}}]),e}()},function(e,t,r){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":i(t))&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":i(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardCoreServiceWorker=void 0;var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(17),l=r(19),h=r(20),c=r(7),d=r(8),f=r(9),p=r(10),m=r(11),v=r(2),g=r(12),y=r(1),b=r(5),k=r(4),w=r(3),C=r(18);t.WhiteboardCoreServiceWorker=function(e){function t(e,r,i){n(this,t);var a=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.listener=new w.WhiteboardCoreListener,a.name=r,a.curEntity=null,a.exMap=new h.HashMap,a.domId=e,a.dom=document.getElementById(e),a.viewport=new l.Viewport(a),a.pastRecords=[],a.undoRecords=[],a.remoteRecordMap=new h.HashMap,a.remoteHistoryMap=new h.HashMap,a.paper=null,a.paperDom=null,a.maskDom=null,a.arrowMarkerColors=["","","","",""],a.arrowMatchTimestamps=[0,0,0,0,0],a.bgDom=null,a.bgImage=null,a.transparent=!1,a.defaultColor=null,a.defaultWeight=-1,a.defaultBorderColor=null,a.defaultBorderWidth=-1,a.cmdSnCursor=0,a.remoteSlide=null,a.width=0,a.height=0,a.paperWidth=2048,a.paperHeight=2048,a.remoteWidth=-1,a.remoteHeight=-1,a.sessionName=i,a.recorder=null,a.player=null,a.resourcePath="./resource/images",a}return a(t,e),s(t,[{key:"setListener",value:function(e){this.listener=e}},{key:"setResourcePath",value:function(e){this.resourcePath=e}},{key:"load",value:function(e,t){void 0===e&&(e=this.dom.offsetWidth),void 0===t&&(t=this.dom.offsetHeight),this.dom.style.textAlign="left",this.dom.style.overflow="hidden",this.paper=Raphael(this.domId,Math.max(this.paperWidth,e),Math.max(this.paperHeight,t)),this.paperDom=this.dom.getElementsByTagName("svg")[0],this.transparent||(this.paperDom.style.backgroundColor="#fefefe"),this.paperDom.style.left=parseInt(.5*(e-this.paperWidth))+"px",this.paperDom.style.top=parseInt(.5*(t-this.paperHeight))+"px",this.width=e,this.height=t,this._buildEvents(),this.maskDom=document.createElement("div"),this.maskDom.style.position="absolute",this.maskDom.style.styleFloat="left",this.maskDom.style.cssFloat="left",this.maskDom.style.left="0px",this.maskDom.style.top="0px",this.maskDom.style.backgroundImage="url('"+this.resourcePath+"/loading.gif')",this.maskDom.style.backgroundRepeat="no-repeat",this.maskDom.style.backgroundPosition="center center",this.maskDom.style.width=e+"px",this.maskDom.style.height=t+"px",this.maskDom.style.display="none",this.dom.appendChild(this.maskDom),this.bgDom=document.createElement("div"),this.bgDom.style.position="absolute",this.bgDom.style.styleFloat="left",this.bgDom.style.cssFloat="left",this.transparent||(this.bgDom.style.backgroundColor="#efefef"),this.dom.insertBefore(this.bgDom,this.paperDom),this._fix()}},{key:"unload",value:function(){this.cleanup(!0),this.unselect(),this.maskDom&&(this.maskDom.parentNode.removeChild(this.maskDom),this.maskDom=null),this.bgDom&&(this.bgDom.parentNode.removeChild(this.bgDom),this.bgDom=null),this.paper&&(this.paper.remove(),this.paper=null,this.paperDom=null),this._destroyEvents()}},{key:"_buildEvents",value:function(){var e=this;this._onClick=function(t){e.onClick(t)},this._onMouseMove=function(t){e.onMouseMove(t)},this._onMouseDown=function(t){e.onMouseDown(t)},this._onMouseUp=function(t){e.onMouseUp(t)},this._onTouchMove=function(t){e.onTouchMove(t)},this._onTouchStart=function(t){e.onTouchStart(t)},this._onTouchEnd=function(t){e.onTouchEnd(t)},this._onKeyPress=function(t){e.onKeyPress(t)},this.dom.addEventListener("click",this._onClick,!1),this.dom.addEventListener("mousemove",this._onMouseMove,!1),this.dom.addEventListener("mousedown",this._onMouseDown,!1),this.dom.addEventListener("mouseup",this._onMouseUp,!1),this.dom.addEventListener("touchmove",this._onTouchMove,!1),this.dom.addEventListener("touchstart",this._onTouchStart,!1),this.dom.addEventListener("touchend",this._onTouchEnd,!1),this.dom.addEventListener("keypress",this._onKeyPress,!1)}},{key:"_destroyEvents",value:function(){this.dom.removeEventListener("click",this._onClick,!1),this.dom.removeEventListener("mousemove",this._onMouseMove,!1),this.dom.removeEventListener("mousedown",this._onMouseDown,!1),this.dom.removeEventListener("mouseup",this._onMouseUp,!1),this.dom.removeEventListener("touchmove",this._onTouchMove,!1),this.dom.removeEventListener("touchstart",this._onTouchStart,!1),this.dom.removeEventListener("touchend",this._onTouchEnd,!1),this.dom.removeEventListener("keypress",this._onKeyPress,!1)}},{key:"_fix",value:function(){var e=this.paperDom,t=e.getElementsByTagName("desc");null!==t&&t.length>0&&(t=t[0],t.innerHTML="Cube Engine Whiteboard - www.getcube.cn");var r=e.getElementsByTagName("defs");null!==r&&r.length>0?r=r[0]:(r=document.createElement("defs"),e.appendChild(r));var i=['<marker id="_cube_arrow_0" markerUnits="strokeWidth" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto" viewBox="0 0 20 20"><path d="M2,2 L10,6 L2,10 L6,6 L2,2 z" fill="" /></marker>','<marker id="_cube_arrow_1" markerUnits="strokeWidth" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto" viewBox="0 0 20 20"><path d="M2,2 L10,6 L2,10 L6,6 L2,2 z" fill="" /></marker>','<marker id="_cube_arrow_2" markerUnits="strokeWidth" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto" viewBox="0 0 20 20"><path d="M2,2 L10,6 L2,10 L6,6 L2,2 z" fill="" /></marker>','<marker id="_cube_arrow_3" markerUnits="strokeWidth" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto" viewBox="0 0 20 20"><path d="M2,2 L10,6 L2,10 L6,6 L2,2 z" fill="" /></marker>','<marker id="_cube_arrow_4" markerUnits="strokeWidth" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto" viewBox="0 0 20 20"><path d="M2,2 L10,6 L2,10 L6,6 L2,2 z" fill="" /></marker>'];r.innerHTML=i.join(""),i=null}},{key:"_matcheArrow",value:function(e){for(var t=0;t<this.arrowMarkerColors.length;++t)if(this.arrowMarkerColors[t]==e)return this.arrowMatchTimestamps[t]=Date.now(),"#_cube_arrow_"+t;for(var r=0;r<this.arrowMarkerColors.length;++r)if(this.arrowMarkerColors[r].length<2){var i="_cube_arrow_"+r,n=this.paperDom.getElementById(i);return null===n?(this.arrowMarkerColors[r]="",this.arrowMatchTimestamps[r]=0,"#_cube_arrow_default"):(this.arrowMarkerColors[r]=e,this.arrowMatchTimestamps[r]=Date.now(),n=n.getElementsByTagName("path")[0],n.setAttribute("fill",e),"#"+i)}for(var o=-1,a=Number.MAX_VALUE,s=0;s<this.arrowMatchTimestamps.length;++s){var u=this.arrowMatchTimestamps[s];u<a&&(a=u,o=s)}if(o<0)return"#_cube_arrow_default";this.arrowMarkerColors[o]=e,this.arrowMatchTimestamps[o]=Date.now();var l="_cube_arrow_"+o,h=this.paperDom.getElementById(l);return null===h&&null===(h=document.getElementById(l))?"#_cube_arrow_default":(h=h.getElementsByTagName("path")[0],h.setAttribute("fill",e),"#"+l)}},{key:"_centerBgImage",value:function(e){var t=.5*(this.width-e.width),r=.5*(this.height-e.height);this.bgDom.style.paddingLeft=parseInt(t)+"px",this.bgDom.style.paddingTop=parseInt(r)+"px"}},{key:"_replayRecord",value:function(e,t,r){e.type===m.RectEntity.Name?(m.RectEntity.restore(this.paper,e,r,this),(void 0===t||t)&&this.record(e.type,e.set,e.raw,!1)):e.type===f.EllipseEntity.Name?(f.EllipseEntity.restore(this.paper,e,r,this),(void 0===t||t)&&this.record(e.type,e.set,e.raw,!1)):e.type===c.ArrowEntity.Name?(c.ArrowEntity.restore(this.paper,e,this,r),(void 0===t||t)&&this.record(e.type,e.set,e.raw,!1)):e.type===p.PencilEntity.Name?(p.PencilEntity.restore(this.paper,e,r,this),(void 0===t||t)&&this.record(e.type,e.set,e.raw,!1)):e.type===g.TextEntity.Name&&(g.TextEntity.restore(this.paper,e,r,this),(void 0===t||t)&&this.record(e.type,e.set,e.raw,!1))}},{key:"_replayVGCommand",value:function(e){var t=null,r=null;this.sessionName!==e.from&&(t=e.from),void 0!==e.group&&""!==e.group&&(r=e.group);var i=null;if("rect"===e.name)i=this.loadVGCommand(e,t),null===t&&this.record(e.name.toString(),i,{param:e.param,attr:e.attr});else if("ellipse"===e.name)i=this.loadVGCommand(e,t),null===t&&this.record(e.name.toString(),i,{param:e.param,attr:e.attr});else if("arrow"===e.name)i=this.loadVGCommand(e,t),null===t&&this.record(e.name.toString(),i,{param:e.param,attr:e.attr});else if("path"===e.name)i=this.loadVGCommand(e,t,r),null===t&&this.record(e.name.toString(),i,{param:e.param,attr:e.attr});else if("text"===e.name)i=this.loadVGCommand(e,t,r),null===t&&this.record(e.name.toString(),i,{param:e.param,attr:e.attr});else if("slide"===e.name)null===t?this.workAsSlide(e.param,!0):this.loadVGCommand(e,t,r);else if("undo"===e.name)null===t?this.undo(!0):this.loadVGCommand(e,t,r);else if("redo"===e.name)null===t?this.redo(!0):this.loadVGCommand(e,t,r);else if("bgimage"===e.name){var n=new d.BackgroundImageEntity(e.param,!0);this.selectEntity(n)}else Logger.w("CubeWhiteboard","Unknown replay VG command: "+e.name)}},{key:"onClick",value:function(e){if(null!==this.curEntity)this.curEntity.onClick(e);else{this.viewport.onClick(e);var t=this.getSlide();t&&t.onClick(e)}}},{key:"onMouseMove",value:function(e){y.Utils.isAndroid||y.Utils.isIPhone||(null!==this.curEntity?this.curEntity.onMouseMove(e):this.viewport.onMouseMove(e))}},{key:"onMouseDown",value:function(e){null!==this.curEntity?this.curEntity.onMouseDown(e):this.viewport.onMouseDown(e)}},{key:"onMouseUp",value:function(e){null!==this.curEntity?this.curEntity.onMouseUp(e):this.viewport.onMouseUp(e)}},{key:"onTouchMove",value:function(e){null!==this.curEntity?this.curEntity.onTouchMove(e):this.viewport.onTouchMove(e)}},{key:"onTouchStart",value:function(e){null!==this.curEntity?this.curEntity.onTouchStart(e):this.viewport.onTouchStart(e)}},{key:"onTouchEnd",value:function(e){null!==this.curEntity?this.curEntity.onTouchEnd(e):this.viewport.onTouchEnd(e)}},{key:"onKeyPress",value:function(e){null!==this.curEntity?this.curEntity.onKeyPress(e):this.viewport.onKeyPress(e);var t=this.getSlide();t&&t.onKeyPress(e)}},{key:"adjustSize",value:function(){var e=parseInt(this.dom.offsetWidth),t=parseInt(this.dom.offsetHeight);this.resize(e,t),this._syncSize(),this.viewport.adaptView()}},{key:"_syncSize",value:function(){var e={whiteboardId:this.name,boardSize:{width:this.width,height:this.height},paperSize:{width:this.paperWidth,height:this.paperHeight}};this.triggerChange(e)}},{key:"selectEntity",value:function(e){var t=this;if(e.exclusive){null!==this.curEntity&&(this.curEntity.dispose(),this.curEntity=null),e.board=this,this.curEntity=e,null!==this.defaultColor&&e.color&&(e.color=this.defaultColor),null!==this.defaultBorderColor&&e.borderColor&&(e.borderColor=this.defaultBorderColor),this.defaultWeight>0&&void 0!==e.weight&&(e.weight=this.defaultWeight),this.defaultBorderWidth>0&&void 0!==e.borderWidth&&(e.borderWidth=this.defaultBorderWidth);var r=setTimeout(function(){clearTimeout(r),null!==t.curEntity&&t.curEntity.onDraw(t.paper)},30)}else{e.board=this;var i=setTimeout(function(){clearTimeout(i),e.onDraw(t.paper),t.exMap.put(e.name,e)},30)}}},{key:"unselect",value:function(e){if(void 0!==e&&this.exMap.containsKey(e.name)){var t=this.exMap.get(e.name);return this.exMap.remove(e.name),void t.dispose()}null!==this.curEntity&&this.curEntity.exclusive&&(this.curEntity.dispose(),this.curEntity=null)}},{key:"undo",value:function(e){if(0===this.pastRecords.length)return!1;var t=this.pastRecords.pop();this.undoRecords.push(t),this.viewport.unmanage(t.set),void 0===t.set.forEach?(t.set._custom&&(t.set._custom.remove(),t.set._custom=null),t.set.remove()):t.set.forEach(function(e){e.remove()});var r=this.getSlide();if(r&&r.popNote(),null!=this.recorder&&this.recorder.isRecording()&&this.recorder._notifyOperation({name:"undo",time:Date.now()}),!e){var i={whiteboardId:this.name,command:{name:"undo",param:t.sn}};this.triggerChange(i)}return!0}},{key:"redo",value:function(e){if(0===this.undoRecords.length)return!1;var t=this.undoRecords.pop();this.pastRecords.push(t),t.type===m.RectEntity.Name?m.RectEntity.restore(this.paper,t):t.type===f.EllipseEntity.Name?f.EllipseEntity.restore(this.paper,t):t.type===c.ArrowEntity.Name?c.ArrowEntity.restore(this.paper,t,this):t.type===p.PencilEntity.Name?p.PencilEntity.restore(this.paper,t):t.type===g.TextEntity.Name?g.TextEntity.restore(this.paper,t):Logger.e("CubeWhiteboard#redo","Unknown command type: "+t.type);var r=this.getSlide();if(r&&r.appendNote(t),null!=this.recorder&&this.recorder.isRecording()&&this.recorder._notifyOperation({name:"redo",time:Date.now()}),!e){var i={whiteboardId:this.name,command:{name:"redo",param:t.sn}};null!==r&&(i.command.page=t.cursor+1),this.triggerChange(i)}return!0}},{key:"erase",value:function(e,t){if(this.pastRecords.length>0)for(var r=0;r<this.pastRecords.length;++r){var i=this.pastRecords[r];void 0===i.set.forEach?(i.set._custom&&(i.set._custom.remove(),i.set._custom=null),i.set.remove()):i.set.forEach(function(e){e.remove()})}if(this.remoteRecordMap.size()>0)for(var n=this.remoteRecordMap.values(),o=0;o<n.length;++o)for(var a=n[o],s=0;s<a.length;++s){var u=a[s];u.el.remove()}this.pastRecords.splice(0,this.pastRecords.length),this.undoRecords.splice(0,this.undoRecords.length),this.cmdSnCursor=0;for(var l=0;l<this.arrowMarkerColors.length;++l)this.arrowMarkerColors[l]="",this.arrowMatchTimestamps[l]=0;if(this.remoteRecordMap.clear(),this.remoteHistoryMap.clear(),void 0===t||t){t=!0;var h=this.getSlide();h&&h.clearNote()}else t=!1;if(null!=this.recorder&&this.recorder.isRecording()&&this.recorder._notifyOperation({name:"erase",time:Date.now()}),!e){var c={whiteboardId:this.name,command:{name:"erase",param:t}};this.triggerChange(c)}return!0}},{key:"cleanup",value:function(e){this.exMap.clear(),this.pastRecords.splice(0,this.pastRecords.length),this.undoRecords.splice(0,this.undoRecords.length),this.cmdSnCursor=0;for(var t=0;t<this.arrowMarkerColors.length;++t)this.arrowMarkerColors[t]="",this.arrowMatchTimestamps[t]=0;if(this.remoteRecordMap.clear(),this.remoteHistoryMap.clear(),null!==this.remoteSlide&&(this.remoteSlide.dispose(),this.remoteSlide=null),null!==this.bgImage&&(this.bgImage.remove(),this.bgImage=null),null!=this.paper&&this.paper.clear(),this.adjustSize(),this.viewport.reset(),this._fix(),this.hideMask(),this.listener.onCleanup(this),!e){var r={whiteboardId:this.name,command:{name:"cleanup",param:0}};this.triggerChange(r)}return!0}},{key:"zoom",value:function(e){y.Utils.getElementChildren(this.paperDom).length<=2||this.viewport.zoom(e)}},{key:"resetView",value:function(e){!this.getSlide()&&(this.remoteWidth<=0||e)?this.viewport.reset():this.viewport.adaptView()}},{key:"setRemoteSize",value:function(e,t){this.remoteWidth=e,this.remoteHeight=t}},{key:"syncBoardSize",value:function(e){e.width>this.remoteWidth&&this.setRemoteSize(e.width,e.height),this.viewport.adaptView()}},{key:"numPaperElements",value:function(){return y.Utils.getElementChildren(this.paperDom).length-2}},{key:"getExEntity",value:function(e){return this.exMap.get(e)}},{key:"showMask",value:function(){this.maskDom.style.display="block"}},{key:"hideMask",value:function(){this.maskDom.style.display="none"}},{key:"exportContent",value:function(e){var t=null,r=this.getSlide();if(r){t={slide:{origin:r.getDocName().toString(),alias:r.file.alias.toString(),size:r.file.size,pages:[]}};var i=null;void 0!==e&&(e instanceof Array?i=e:e instanceof Number&&(i=[e])),null===i&&(i=[r.currentPage()]);for(var n=0;n<i.length;++n){var o=i[n],a=r.exportPage(o);null!==a&&t.slide.pages.push(a)}}else{t={records:[]};for(var s=0;s<this.pastRecords.length;++s){var u=this.pastRecords[s],l={sn:u.sn,type:u.type,raw:u.raw,time:u.time};t.records.push(l)}}return t}},{key:"importContent",value:function(e){var t=this;if(this.numPaperElements()>0)return this.cleanup(!0),setTimeout(function(){t.importContent(e)},150),!0;if(void 0!==e.slide){for(var r={account:"",origin:e.slide.origin,alias:e.slide.alias,size:e.slide.size,urls:[]},i=e.slide.pages,n=0;n<i.length;++n){var o=i[n];r.urls.push(o.url)}this.workAsSlide(r,!0),setTimeout(function(){var e=i[0].notes;if(void 0!==e)for(var r=0;r<e.length;++r)t._replayRecord(e[r]);for(var n=t.getSlide(),o=0;o<i.length;++o){var a=i[o].notes;if(void 0!==a)for(var s=0;s<a.length;++s)n.appendNote(o+1,a[s])}},500)}else if(void 0!==e.records)for(var a=0;a<e.records.length;++a){var s=e.records[a];this._replayRecord(s)}else Logger.e("CubeWhiteboard#importContent","Data format error!");return!0}},{key:"record",value:function(e,t,r,i){var n=this.cmdSnCursor++,o=Date.now(),a={sn:n,type:e,set:t,raw:r,time:o};if(this.pastRecords.push(a),void 0===i||i){var s=this.getSlide();s&&s.appendNote(a)}return null!==this.recorder&&this.recorder._notifyRecord(a),n}},{key:"setTransparency",value:function(e){this.transparent!==e&&(this.transparent=e,e?(this.paperDom.style.backgroundColor="",this.bgDom.style.backgroundColor=""):(this.paperDom.style.backgroundColor="#fefefe",this.bgDom.style.backgroundColor="#efefef"))}},{key:"setBackgroundImage",value:function(e,t){var r=this,i=this.bgDom,n=i.getElementsByTagName("img")[0];if(void 0===n||null===n){var o=document.createElement("img");return i.appendChild(o),o.onload=function(e){t.call(null,o),r._centerBgImage(o)},o.src=e,o}return n.setAttribute("src",""),n.onload=function(e){t.call(null,n),r._centerBgImage(n)},n.setAttribute("src",e),n}},{key:"setBackgroundColor",value:function(e){this.paperDom.style.backgroundColor=e,this.bgDom.style.backgroundColor=e}},{key:"loadRecordData",value:function(e,t){void 0!==t&&t&&this.cleanup(!0);for(var r=e.commands,i=this,n=0;n<r.length;++n){var o=r[n];null==o.page?this._replayVGCommand(o):(1===o.page&&this._replayVGCommand(o),function(e){setTimeout(function(){var t=i.getSlide();if(t){var r={sn:e.sn,type:e.name,set:null,raw:{param:e.param,attr:e.attr},page:e.page};t.appendNote(r)}},60)}(o))}}},{key:"loadVGCommand",value:function(e,t,r){var i=void 0;if("slide"===e.name){if(null!==this.remoteSlide&&(this.remoteSlide.from=t,r&&(this.remoteSlide.group=r),this.remoteSlide.file.origin===e.param.origin)){var n=e.attr;return void((Math.abs(n.cursor-this.remoteSlide.cursor)>0||"="===n.page)&&this.remoteSlide.gotoPage(n.cursor+1))}if(this.exMap.containsKey(d.BackgroundImageEntity.Name)){var o=this.exMap.get(d.BackgroundImageEntity.Name);o.dispose(),this.exMap.remove(d.BackgroundImageEntity.Name),o=null}this.cleanup(!0),this.remoteSlide=new v.SlideEntity(e.param,!0),this.remoteSlide.from=t,r&&(this.remoteSlide.group=r),this.remoteSlide.cursor=e.attr.cursor,this.selectEntity(this.remoteSlide)}else if("undo"===e.name){var a=null;a=r?t+"_"+r:t;var s=this.remoteRecordMap.get(a);if(s){for(var u=parseInt(e.param),l=[],h=s.length-1;h>=0;--h){var y=s[h];if(!(y.sn>=u))break;l.push(y)}if(l.length>0){var b=this.remoteHistoryMap.get(a);b||(b=[],this.remoteHistoryMap.put(a,b));for(var k=0;k<l.length;++k){var w=l[k];b.push(w);var C=s.indexOf(w);C>=0&&s.splice(C,1),w.el.remove()}}}var E=this.getSlide();E&&E.popNote()}else if("redo"===e.name){var _=null;_=r?t+"_"+r:t;var S=this.remoteHistoryMap.get(_);if(S){for(var x=parseInt(e.param),P=[],T=S.length-1;T>=0;--T){var I=S[T];if(!(I.sn<=x))break;P.push(I)}if(P.length>0){var W=this.remoteRecordMap.get(_);W||(W=[],this.remoteRecordMap.put(_,W));for(var M=0;M<P.length;++M){var R=P[M];W.push(R);var L=S.indexOf(R);if(L>=0&&S.splice(L,1),e.page){var O=this.getSlide();O&&O.appendNote(R)}var j=R.type;j===m.RectEntity.Name?m.RectEntity.restore(this.paper,R):j===f.EllipseEntity.Name?f.EllipseEntity.restore(this.paper,R):j===c.ArrowEntity.Name?c.ArrowEntity.restore(this.paper,R,this):j===p.PencilEntity.Name?p.PencilEntity.restore(this.paper,R):j===g.TextEntity.Name?g.TextEntity.restore(this.paper,R):Logger.e("CubeWhiteboard#_processVGRedo","Unknown command type: "+j)}}}}else if("erase"===e.name)this.erase(!0);else if("cleanup"===e.name)this.cleanup(!0);else if("bgimage"===e.name){var N=new d.BackgroundImageEntity(e.param,!0);this.selectEntity(N)}else{var D=void 0;if("rect"===e.name?D=m.RectEntity:"ellipse"===e.name?D=f.EllipseEntity:"arrow"===e.name?D=c.ArrowEntity:"path"===e.name?D=p.PencilEntity:"text"===e.name&&(D=g.TextEntity),null!==D){if(i=D.draw(this.paper,e,this),null===t)return i;var A=null;if(A=void 0!==r&&null!=r?t+"_"+r:t,this.remoteRecordMap.containsKey(A)){var F=this.remoteRecordMap.get(A);F.push({sn:e.sn,type:D.Name,el:i,raw:{param:e.param,attr:e.attr}})}else{var z=[{sn:e.sn,type:D.Name,el:i,raw:{param:e.param,attr:e.attr}}];this.remoteRecordMap.put(A,z)}return i}Logger.w("CubeWhiteboard","Unknown VG command: "+e.name)}}},{key:"remove",value:function(e){if(0!==this.pastRecords.length){for(var t=null,r=-1,i=this.pastRecords.length-1;i>=0;--i){var n=this.pastRecords[i];if(n.sn===e){t=n,r=i;break}}null!==t&&(this.pastRecords.splice(r,1),this.undoRecords.push(t),this.viewport.unmanage(t.set),void 0===t.set.forEach?(t.set._custom&&(t.set._custom.remove(),t.set._custom=null),t.set.remove()):t.set.forEach(function(e){e.remove()}))}}},{key:"resize",value:function(e,t){if(null!==this.paper){if(this.paperWidth>0&&this.paperHeight>0){var r=e-this.paperWidth,i=t-this.paperHeight;this.paper.setSize(this.paperWidth,this.paperHeight),this.paperDom.style.left=parseInt(.5*r)+"px",this.paperDom.style.top=parseInt(.5*i)+"px"}else this.paper.setSize(e,t),this.paperDom.style.left="0px",this.paperDom.style.top="0px";this.width=e,this.height=t,null!==this.curEntity&&this.curEntity.onResize(e,t);var n=this.getSlide();n&&n.onResize(e,t),null!==this.remoteSlide&&this.remoteSlide.onResize(e,t),this.maskDom.style.width=e+"px",this.maskDom.style.height=t+"px",this.bgDom.style.width=e+"px",this.bgDom.style.height=t+"px";var o=this.bgDom.getElementsByTagName("img");null!==o&&void 0!==(o=o[0])&&null!==o&&this._centerBgImage(o)}}},{key:"workAsSlide",value:function(e,t){var r=!t||void 0;if(void 0===e.urls||void 0===e.origin)return Logger.w("CubeWhiteboard","Invalid sharing file"),!1;if(this.getSlide()&&(null!==this.recorder&&this.recorder.isRecording()||null!==this.player&&this.player.isPlaying()))return this.listener.onFailed(C.StateCode.OpenSlideFailed),!1;if(this.exMap.containsKey(d.BackgroundImageEntity.Name)){var i=this.exMap.get(d.BackgroundImageEntity.Name);i.dispose(),this.exMap.remove(d.BackgroundImageEntity.Name),i=null}this.cleanup(!0);var n=new v.SlideEntity(e);return n.from=this.sessionName,r&&(n.isFirstSharing=!0),this.selectEntity(n),this.listener.onSlideOpened(n),!0}},{key:"getSlide",value:function(){return this.exMap.get(v.SlideEntity.Name)}},{key:"getZoomRatio",value:function(){return this.viewport.getRatio()}},{key:"getRecorder",value:function(){return null===this.recorder&&(this.recorder=new b.WhiteboardRecorder(this)),this.recorder}},{key:"getPlayer",value:function(){return null===this.player&&(this.player=new k.WhiteboardPlayer(this)),this.player}},{key:"onSlideChanged",value:function(e,t){this.viewport.adaptView(),this.listener.onSlideChanged(e),null!==this.recorder&&this.recorder.isRecording()&&this.recorder._notifyOperation({name:"slide",page:e.currentPage(),time:Date.now()})}},{key:"triggerChange",value:function(e){this.listener.onChange(e)}}]),t}(u.WhiteboardCoreService)},function(e,t,r){var i=r(3),n=r(15),o=r(14),a=r(5),s=r(13),u=r(4),l=r(0),h=r(6),c=r(7),d=r(8),f=r(9),p=r(10),m=r(11),v=r(2),g=r(12);!function(e){e.CubeWhiteboardCoreListener=i.WhiteboardCoreListener,e.CubeWhiteboardCoreServiceWorker=n.WhiteboardCoreServiceWorker,e.CubeWhiteboardRecorderListener=o.WhiteboardRecorderListener,e.CubeWhiteboardRecorder=a.WhiteboardRecorder,e.CubeWhiteboardPlayerListener=s.WhiteboardPlayerListener,e.CubeWhiteboardPlayer=u.WhiteboardPlayer,e.GraphicsEntity=l.GraphicsEntity,e.SlideNote=h.SlideNote,e.ArrowEntity=c.ArrowEntity,e.BackgroundImageEntity=d.BackgroundImageEntity,e.EllipseEntity=f.EllipseEntity,e.PencilEntity=p.PencilEntity,e.RectEntity=m.RectEntity,e.SlideEntity=v.SlideEntity,e.TextEntity=g.TextEntity}(window)},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.WhiteboardCoreService=function(){function e(){i(this,e)}return n(e,[{key:"setListener",value:function(e){}},{key:"load",value:function(e,t){}},{key:"adjustSize",value:function(){}},{key:"selectEntity",value:function(e){}},{key:"unselect",value:function(e){}},{key:"undo",value:function(e){}},{key:"redo",value:function(e){}},{key:"erase",value:function(e,t){}},{key:"cleanup",value:function(e){}},{key:"zoom",value:function(e){}},{key:"resetView",value:function(e){}},{key:"setRemoteSize",value:function(e,t){}},{key:"syncBoardSize",value:function(e){}},{key:"numPaperElements",value:function(){}},{key:"getExEntity",value:function(e){}},{key:"showMask",value:function(){}},{key:"hideMask",value:function(){}},{key:"exportContent",value:function(e){}},{key:"importContent",value:function(e){}},{key:"record",value:function(e,t,r,i){}},{key:"setTransparency",value:function(e){}},{key:"setBackgroundImage",value:function(e,t){}},{key:"setBackgroundColor",value:function(e){}},{key:"loadRecordData",value:function(e,t){}},{key:"loadVGCommand",value:function(e,t,r){}},{key:"remove",value:function(e){}},{key:"resize",value:function(e,t){}},{key:"workAsSlide",value:function(e,t){}},{key:"getSlide",value:function(){}},{key:"getZoomRatio",value:function(){}},{key:"getRecorder",value:function(){}},{key:"getPlayer",value:function(){}},{key:"unload",value:function(){}}]),e}()},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.StateCode={OpenSlideFailed:1600}},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Viewport=void 0;var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=r(1);t.Viewport=function(){function e(t){i(this,e),this.wb=t,this.width=t.paperWidth,this.height=t.paperHeight,this.enabled=!0,this.down=!1,this.bboxPadding=4,this.zoomRatio=-1,this.posX=0,this.posY=0,this.tempX=0,this.tempY=0,this.elements=[]}return n(e,[{key:"manage",value:function(e,t){var r=this;o.Utils.unselectable(t.node),this.elements.indexOf(t)>=0||(t.sn=e,this.elements.push(t),t.click(function(e){if(null==t._custom||void 0===t._custom){var i=r.wb.paper,n=t.getBBox();t._custom={list:[],remove:function(){for(var e=0;e<this.list.length;++e)this.list[e].remove();this.list.splice(0,this.list.length)}};var o=i.rect(n.x-r.bboxPadding,n.y-r.bboxPadding,n.width+r.bboxPadding+r.bboxPadding,n.height+r.bboxPadding+r.bboxPadding);o.attr("stroke","#1AA0E6"),o.attr("stroke-dasharray","."),t._custom.list.push(o);var a=i.circle(n.x-r.bboxPadding,n.y,10),s=function e(i){t._custom.remove(),t._custom=null,r.wb.remove(t.sn),a.unclick(e)};a.click(s),a.attr("fill","#1AA0E6"),a.attr("stroke","#1AA0E6"),t._custom.list.push(a);var u=n.x-5-r.bboxPadding,l=n.y-5,h=n.x+5-r.bboxPadding,c=n.y+5,d=i.path("M"+u+","+l+" L"+h+","+c+" Z");d.attr("stroke","#FFF"),d.attr("stroke-width",2),t._custom.list.push(d),u=n.x+5-r.bboxPadding,l=n.y-5,h=n.x-5-r.bboxPadding,c=n.y+5,d=i.path("M"+u+","+l+" L"+h+","+c+" Z"),d.attr("stroke","#FFF"),d.attr("stroke-width",2),t._custom.list.push(d)}}))}},{key:"unmanage",value:function(e){var t=this.elements.indexOf(e);t<0||(this.elements.splice(t,1),void 0!==e._custom&&null!=e._custom&&(e._custom.remove(),e._custom=null))}},{key:"reset",value:function(){this.posX=0,this.posY=0,this.width=this.wb.paperWidth,this.height=this.wb.paperHeight,this.wb.paper.setViewBox(this.posX,this.posY,this.width,this.height,!0),this.zoomRatio=1,this.elements.splice(0,this.elements.length)}},{key:"adaptView",value:function(){var e=null,t=null,r=this.wb.getSlide(),i=this.wb.width,n=this.wb.height;if(0!=i&&0!=n){var o=!1;if(null==r){if(this.wb.remoteWidth<=0)return;this.wb.remoteWidth>i&&(o=!0)}if(o){var a=this.wb.remoteWidth,s=this.wb.remoteHeight,u=.5*(this.wb.paperWidth-a),l=.5*(this.wb.paperHeight-s),h=a,c=s;e={x:u,y:l},t={width:h,height:c}}else{if(null==r)return;if(null==(e=r.getPosition())){var d=this;return void setTimeout(function(){d.adaptView()},40)}if(t=r.getSize(),i>=t.width&&n>=t.height)return}var f=t.width/i,p=t.height/n;if(f>p){var m=f,v=parseInt(Math.round(m*this.wb.paperWidth))+1,g=.5*(i*m-this.wb.paperWidth*m)+e.x;this.posX=parseInt(g),this.posY=0,this.width=v,this.height=this.wb.paperHeight,this.zoomRatio=i/t.width}else{var m=p,y=parseInt(Math.round(m*this.wb.paperHeight))+1,b=.5*(n*m-this.wb.paperHeight*m)+e.y;this.posX=0,this.posY=parseInt(b),this.width=this.wb.paperWidth,this.height=y,this.zoomRatio=n/t.height}this.wb.paper.setViewBox(this.posX,this.posY,this.width,this.height,!0)}}},{key:"getRatio",value:function(){if(this.zoomRatio>0)return this.zoomRatio;var e=this.wb.paperWidth/this.width,t=this.wb.paperHeight/this.height;return Math.abs(e-1)<Math.abs(t-1)?(this.zoomRatio=t,t):(this.zoomRatio=e,e)}},{key:"zoom",value:function(e){if(!(e<=0)){var t=this.wb.paperWidth/e,r=this.wb.paperHeight/e;this.posX=parseInt(.5*(this.wb.paperWidth-t)),this.posY=parseInt(.5*(this.wb.paperHeight-r)),this.width=t,this.height=r,this.wb.paper.setViewBox(this.posX,this.posY,this.width,this.height,!0),this.zoomRatio=e}}},{key:"fireDown",value:function(e){if(this.enabled&&0!=this.wb.numPaperElements()){this.down=!0;var t=void 0===e.touches?o.Utils.getMousePos(e):o.Utils.getTouchPos(e);this.tempX=t.x,this.tempY=t.y}}},{key:"fireUp",value:function(e){this.enabled&&(this.down=!1)}},{key:"fireMove",value:function(e){if(this.enabled&&this.down){var t=void 0===e.touches?o.Utils.getMousePos(e):o.Utils.getTouchPos(e);if(!isNaN(parseInt(t.x))&&!isNaN(parseInt(t.y))){var r=this.tempX-t.x,i=this.tempY-t.y;this.posX+=parseInt(r),this.posY+=parseInt(i),this.wb.paper.setViewBox(this.posX,this.posY,this.width,this.height,!0),this.tempX=t.x,this.tempY=t.y}}}},{key:"onClick",value:function(e){if("svg"==e.target.tagName)for(var t=0;t<this.elements.length;++t){var r=this.elements[t];void 0!==r._custom&&null!=r._custom&&(r._custom.remove(),r._custom=null)}}},{key:"onMouseMove",value:function(e){this.fireMove(e)}},{key:"onMouseDown",value:function(e){this.fireDown(e)}},{key:"onMouseUp",value:function(e){this.fireUp(e)}},{key:"onTouchMove",value:function(e){this.fireMove(e)}},{key:"onTouchStart",value:function(e){this.fireDown(e)}},{key:"onTouchEnd",value:function(e){this.fireUp(e)}},{key:"onKeyPress",value:function(e){}},{key:"_detectCollision",value:function(e,t){}}]),e}()},function(e,t,r){function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();t.HashMap=function(){function e(){i(this,e),this._stack={},this._size=0}return n(e,[{key:"put",value:function(e,t){this.containsKey(e)||this._size++,this._stack[e]=t}},{key:"get",value:function(e){return this._stack[e]}},{key:"containsKey",value:function(e){return this._stack.hasOwnProperty(e)}},{key:"containsValue",value:function(e){for(var t in this._stack)if(this._stack.hasOwnProperty(t)&&this._stack[t]===e)return!0;return!1}},{key:"remove",value:function(e){return!!this.containsKey(e)&&(this._size--,delete this._stack[e])}},{key:"keySet",value:function(){return Object.keys(this._stack)}},{key:"values",value:function(){return Object.values(this._stack)}},{key:"isEmpty",value:function(){return 0===this._size}},{key:"size",value:function(){return this._size}},{key:"clear",value:function(){this._size=0,this._stack={}}}]),e}()}])},77:function(e,t,r){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardServiceWorker=void 0;var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=r(128),u=r(23),l=r(50),h=r(129),c=r(1);t.WhiteboardServiceWorker=function(e){function t(e,r,o){i(this,t);var a=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,u.WhiteboardListener,CELLET.Whiteboard));return a.session=e.session,a.permission=CubePermission.WRITE,a.offline=!1,a.queryWBCallback=null,a.queryWBErrorCallback=null,a.querySharedCallback=null,a.querySharedErrorCallback=null,a.sharedList=null,a.inviteName=null,a.remoteSizeName=null,a.passiveList=[],a.currentWhiteboard=new HashMap,a.choiceFileInfoMap=new HashMap,a}return o(t,e),a(t,[{key:"updateResourcePath",value:function(){this.core.setResourcePath(this.engine.resourcePath+"/whiteboard")}},{key:"onStartup",value:function(){}},{key:"createWhiteboard",value:function(e,t,r){var i=new l.Whiteboard(this.engine,t,e,r,this),n=/^[\u4e00-\u9fa5a-zA-Z0-9]*$/;return console.log('Boolean "name"  ===>'+n.test(t)),n.test(t)?(i.whiteboardId=i.whiteboardId.toString(),i.name=t,i.isShared=!1,this.currentWhiteboard.put(i.whiteboardId,i),this.delegate.onCreate(i,e),console.log(this.currentWhiteboard.get(i.whiteboardId)),this.load(i)):Logger.e("CubeWhiteboard#createWhiteboard","create Whiteboard failed!"),i}},{key:"removeWhiteboard",value:function(e){if(this.currentWhiteboard.containsKey(e)){var t=this.currentWhiteboard.get(e);t.isShared=!1,t.shares=[],this.sharedList=null,this.currentWhiteboard.remove(e),this.delegate.onRemove(t),t.core.unload(t)}else Logger.d("CubeWhiteboard","Whiteboard is Exist or already removed ")}},{key:"load",value:function(e,t,r){e.core.load(t,r)}},{key:"setTransparency",value:function(e,t){e.core.setTransparency(t)}},{key:"adjustSize",value:function(e){e.core.adjustSize()}},{key:"_syncSize",value:function(e){e.core._syncSize()}},{key:"_processSyncSize",value:function(e,t,r){e.core.syncBoardSize(r)}},{key:"resize",value:function(e,t,r){e.core.resize(t,r)}},{key:"shareWith",value:function(e){if(null==this.session||null==this.session.name)return!1;if(!nucleus.talkService.isCalled(CELLET.Whiteboard))return!1;if(!this.offline){var t=this.currentWhiteboard.get(e);t.core.setRemoteSize(-1,-1);var r=null;console.log("Share is whiteboardId ===>"+e),null!==e.name&&(r=t.name.toString(),console.log("Share is whiteboardName ===>"+r));var i={whiteboardId:e,name:r},n=new ActionDialect;return n.setAction(CubeConst.ActionShare),n.appendParam("param",i),nucleus.talkService.talk(CELLET.Whiteboard,n)}}},{key:"inviteWhiteboard",value:function(e,t){for(var r=/^[0-9]*$/,i=0;i<t.length;i++)if(!r.test(t[i]))return void Logger.e("CubeWhiteboard#createWhiteboard","Invited  can only be Number types!");if(null==this.session||null==this.session.name)return!1;var n=this.currentWhiteboard.get(e),o=this;o.sharedList=t;for(var a=0;a<o.sharedList.length;a++)if(o.sharedList[a]==o.session.name)return!1;if(!o.offline&&o.isSharing(e)){if(nucleus.talkService.isCalled(CELLET.Whiteboard)){o.adjustSize(n);var s={whiteboardId:e,invited:o.sharedList},u=new ActionDialect;return u.setAction(CubeConst.ActionInviteWB),u.appendParam("param",s),nucleus.talkService.talk(CELLET.Whiteboard,u)}}else Logger.e("CubeWhiteboard#inviteWhiteboard","Don't Share,InviteWhiteboard failed!")}},{key:"rejectWhiteboard",value:function(e){if(!this.offline){this.inviteName=null;var t=this.engine.session.name,r={whiteboardId:e,from:t},i=new ActionDialect;return i.setAction(CubeConst.ActionRejectWE),i.appendParam("param",r),nucleus.talkService.talk(CELLET.Whiteboard,i)}}},{key:"revokeSharing",value:function(e){if(!this.offline){var t=this.currentWhiteboard.get(e);t.isShared=!1,this.sharedList=null,this.inviteName=null,this.currentWhiteboard.put(e,t),t.core.setRemoteSize(-1,-1);var r={whiteboardId:e},i=new ActionDialect;return i.setAction(CubeConst.ActionRevoke),i.appendParam("param",r),nucleus.talkService.talk(CELLET.Whiteboard,i)}}},{key:"queryById",value:function(e){if(null!=this.session){var t=this,r=null;return t.currentWhiteboard.containsKey(e)?(r=this.currentWhiteboard.get(e),t.delegate.onQueryById(r)):Logger.d("CubeWhiteboard","Whiteboard is Exist"),r}}},{key:"setPermission",value:function(e){this.permission=e}},{key:"isSharing",value:function(e){var t=this.currentWhiteboard.get(e);return nucleus.talkService.isCalled(CELLET.Whiteboard)&&null!=this.session&&null!=e&&t.isShared}},{key:"queryRecords",value:function(e,t,r,i){var n={whiteboardId:e,start:t};this.queryWBCallback=r,void 0!==i&&(this.queryWBErrorCallback=i);var o=new ActionDialect;return o.setAction(CubeConst.ActionQueryWB),o.appendParam("param",n),nucleus.talkService.talk(CELLET.Whiteboard,o)}},{key:"querySharedRecords",value:function(e,t,r,i){this.querySharedCallback=r,void 0!==i&&(this.querySharedErrorCallback=i);var n={shared:e,start:t},o=new ActionDialect;return o.setAction(CubeConst.ActionQueryShared),o.appendParam("param",n),nucleus.talkService.talk(CELLET.Whiteboard,o)}},{key:"loadRecordData",value:function(e,t,r){null!=this.session&&e.core.loadRecordData(t,r)}},{key:"unselect",value:function(e,t){e.core.unselect(t)}},{key:"selectEntity",value:function(e,t){if(this.permission!=CubePermission.WRITE)return Logger.e("CubeWhiteboard#selectEntity","You don't have permission to write on the whiteboard!"),void this.delegate.onFailed(this,CubeStateCode.NotHavePermission);e.core.selectEntity(t)}},{key:"setOffline",value:function(e){this.offline=e}},{key:"isOffline",value:function(){return this.offline}},{key:"remove",value:function(e){this.core.remove(e)}},{key:"undo",value:function(e,t){return this.permission!=CubePermission.WRITE?(Logger.e("CubeWhiteboard#undo","You don't have permission to write on the whiteboard!"),!1):(e.core.undo(t),!0)}},{key:"redo",value:function(e,t){return this.permission!=CubePermission.WRITE?(Logger.e("CubeWhiteboard#redo","You don't have permission to write on the whiteboard!"),!1):(e.core.redo(t),!0)}},{key:"erase",value:function(e,t,r){return this.permission!=CubePermission.WRITE?(Logger.e("CubeWhiteboard#erase","You don't have permission to write on the whiteboard!"),!1):(e.core.erase(t,r),!0)}},{key:"cleanup",value:function(e,t){return this.permission!=CubePermission.WRITE?(Logger.e("CubeWhiteboard#cleanup","You don't have permission to write on the whiteboard!"),!1):(e.core.cleanup(t),!0)}},{key:"getZoomRatio",value:function(e){return e.core.getZoomRatio()}},{key:"zoom",value:function(e,t){e.core.zoom(t)}},{key:"resetView",value:function(e){e.core.resetView(null===this.sharedList)}},{key:"numPaperElements",value:function(e){return e.core.numPaperElements()}},{key:"getSlide",value:function(e){return e.core.getSlide()}},{key:"shareAsSlide",value:function(e,t){return this.workAsSlide(e,t)}},{key:"workAsSlide",value:function(e,t,r){return void 0==t?(this.delegate.onFailed(e,CubeStateCode.CubeStateLoadFileFailed),void Logger.e("CubeWhiteboard#workAsSlide","File Info is undefined!")):e.core.workAsSlide(t,r)}},{key:"getExEntity",value:function(e,t){e.core.getExEntity(t)}},{key:"exportMessage",value:function(e){var t=new CubeWhiteboardMessage(e);return t.fillContent(this.exportContent()),t}},{key:"importMessage",value:function(e){var t=e.content;return void 0!==t&&null!=t&&this.importContent(JSON.parse(t))}},{key:"exportContent",value:function(e,t){return e.core.exportContent(t)}},{key:"importContent",value:function(e,t){return this.permission!=CubePermission.WRITE?(Logger.e("CubeWhiteboard#importContent","You don't have permission to write on the whiteboard!"),!1):e.core.importContent(t)}},{key:"getRecorder",value:function(e){return e.core.getRecorder()}},{key:"getPlayer",value:function(e){return e.core.getPlayer()}},{key:"querySharedList",value:function(e,t){if(null==this.session.name)return!1;var r=_CUBE_SERVICE+"/sharing/list.js?name="+this.session.name+"&t="+Date.now();return Ajax.newRequest(r).send(function(r){if(200==r.getStatus()){var i=JSON.parse(r.getData());if(200==i.state){var n=i.data;e.call(null,n)}else t.call(null,i.state)}else t.call(null,r.getStatus())}),!0}},{key:"searchSharedFile",value:function(e,t,r){if(null==this.session.name)return!1;var i=window.utils.isSecure?_CUBE_HTTPS_SERVICE:_CUBE_HTTP_SERVICE;return i+="/sharing/search.js?name="+this.session.name+"&key="+encodeURI(e),Ajax.newRequest(i).send(function(e){if(200==e.getStatus()){var i=JSON.parse(e.getData());if(200==i.state){var n=i.data;t.call(null,n)}else r.call(null,i.state)}else r.call(null,e.getStatus())}),!0}},{key:"deleteSharedFile",value:function(e,t,r){if(null==this.session.name)return!1;var i=window.utils.isSecure?_CUBE_HTTPS_SERVICE:_CUBE_HTTP_SERVICE;return i+="/sharing/delete.js?name="+this.session.name+"&file="+encodeURI(e),Ajax.newRequest(i).send(function(e){if(200==e.getStatus()){var i=JSON.parse(e.getData());if(200==i.state){var n=i.data;t.call(null,n)}else r.call(null,i.state)}else r.call(null,e.getStatus())}),!0}},{key:"setBackgroundImage",value:function(e,t,r){return e.core.setBackgroundImage(t,r)}},{key:"setBackgroundColor",value:function(e,t){e.core.setBackgroundColor(t)}},{key:"record",value:function(e,t,r,i,n){return e.core.record(t,r,i,n)}},{key:"onRegisterStateChanged",value:function(e){if(e.regState==CubeRegistrationState.Ok){if(this.session=e,null!=this.sharedList){var t=this,r={whiteboardId:t.name,name:t.sharedList},i=new ActionDialect;i.setAction(CubeConst.ActionShare),i.appendParam("param",r),nucleus.talkService.talk(CELLET.Whiteboard,i)}}else this.session=null}},{key:"onDialogue",value:function(e,t){if(e==CubeConst.ActionVGCmd){if(Logger.d("CubeWhiteboard","VG Command received."),this.offline)return;var r=t.getParam("data"),i=this.currentWhiteboard.get(r.whiteboardId);if(this._processVGCommand(r),null!=r.command.page){var n=this.getSlide(i);if(n){var o=r.command,a={sn:o.sn,type:o.name,set:null,raw:{param:o.param,attr:o.attr},page:o.page};n.appendNote(a)}}}else if(e==CubeConst.ActionRestrain){if(Logger.d("CubeWhiteboard","Restrain"),null==this.sharedList)return void Logger.d("CubeWhiteboard","Invalid restrain");if(this.offline)return;var r=t.getParam("data"),s=this.currentWhiteboard.get(r.whiteboardId),u=r.from;if(this.sharedList.indexOf(u)<0)return void Logger.d("CubeWhiteboard","Invalid restrain");this.remoteSizeName!=u&&this._syncSize(s),void 0!==r.boardSize&&(this.remoteSizeName=u.toString(),this._processSyncSize(r.paperSize,r.boardSize))}else if(e==CubeConst.ActionQueryWBAck){var l=t.getParam("state");200==l.code?null!=this.queryWBCallback&&this.queryWBCallback.call(null,this,t.getParam("data")):null!=this.queryWBErrorCallback&&(this.queryWBErrorCallback.call(null,this,l.code),this.queryWBErrorCallback=null)}else if(e==CubeConst.ActionQuerySharedAck){var l=t.getParam("state");200==l.code?null!=this.querySharedCallback&&this.querySharedCallback.call(null,this,t.getParam("data")):null!=this.querySharedErrorCallback&&(this.querySharedErrorCallback.call(null,this,l.code),this.querySharedErrorCallback=null)}else if(e==CubeConst.ActionShareAck){var h=t.getParam("state"),c=t.getParam("data"),d=c.whiteboard,f=this.currentWhiteboard.get(d.whiteboardId);200==h.code?(Logger.i("CubeWhiteboard","Shared ok."),f.shares=d.shares,this.delegate.onShared(d,c.from),f.isShared=!0,this.currentWhiteboard.put(c.whiteboardId,f),this._syncSize(f)):(Logger.e("CubeWhiteboard","Shared failed!"),this.sharedList=null,this.delegate.onFailed(d,h.code))}else if(e==CubeConst.ActionShare){var p=t.getParam("data"),m=p.whiteboard,v=this.currentWhiteboard.get(m.whiteboardId);v.whiteboardId==m.whiteboardId&&v.shares.push(p.from),this.passiveList.indexOf(p.from)<0&&this.passiveList.push(p.from),this.delegate.onPassiveShared(m,p.from)}else if(e==CubeConst.ActionRevokeAck){var g=t.getParam("state"),y=t.getParam("data"),b=y.whiteboard,k=this.currentWhiteboard.get(y.whiteboardId);b.whiteboardId==k.whiteboardId&&(k.shares=[]),200==g.code?(Logger.i("CubeWhiteboard","Revoked ok."),this.delegate.onRevoked(b,y.from)):(Logger.e("CubeWhiteboard","Revoked failed."),this.delegate.onFailed(b,g.code))}else if(e==CubeConst.ActionRevoke){var w=t.getParam("data"),C=w.whiteboard,E=this.currentWhiteboard.get(C.whiteboardId),_=E.shares.indexOf(w.from);_>=0&&E.shares.splice(_,1);var _=this.passiveList.indexOf(w.from);_>=0&&this.passiveList.splice(_,1),this.delegate.onRevoked(C,w.from)}else if(e==CubeConst.ActionInviteWBAck){var S=t.getParam("state"),x=t.getParam("data"),P=x.whiteboard,T=this.currentWhiteboard.get(P.whiteboardId);200==S.code?(Logger.i("CubeCallService#ActionInviteWBAck","InviteWhiteboard ok."),this._syncSize(T),this.delegate.onWhiteboardInviteResponded(P,[x.success],[x.failure])):1602==S.code?this.delegate.onFailed(P,CubeStateCode.WhiteboardNotExist):(this.delegate.onFailed(P,S.code),Logger.w("CubeCallService#ActionInviteWBAck","A state code that has no effect : "+S.code))}else if(e==CubeConst.ActionInviteWB){var I=t.getParam("data"),W=I.whiteboard,M=I.from;this.inviteName=W.name,this.delegate.onWhiteboardInvite(W,M)}else if(e==CubeConst.ActionRejectWEAck){var R=t.getParam("state"),L=t.getParam("data"),O=L.whiteboard,j=L.from;200==R.code?(Logger.i("CubeWhiteboard#RejectWhiteboard","Reject success."),this.delegate.onReject(O,j)):1602==R.code?this.delegate.onFailed(O,CubeStateCode.WhiteboardNotExist):(this.delegate.onFailed(O,R.code),Logger.w("CubeCallService#ActionInviteWBAck","A state code that has no effect : "+R.code))}else if(e==CubeConst.ActionRejectWE){Logger.i("CubeWhiteboard#RejectWhiteboard","Peer Reject Whiteboard.");var N=t.getParam("data"),D=N.whiteboard,A=N.from;this.delegate.onReject(D,A)}}},{key:"_processVGCommand",value:function(e){var t=e.from,r=null;void 0!==e.group&&""!=e.group&&(r=e.group,Logger.d("CubeWhiteboard","Group shared - group: "+e.group+" and from: "+e.from));var i=this.currentWhiteboard.get(e.whiteboardId);if(i.shares.indexOf(t)<0){if(null==r)return void Logger.d("CubeWhiteboard","No shared source from: "+t);if(i.shares.indexOf(r)<0)return void Logger.d("CubeWhiteboard","No shared source from group: "+r)}this.loadVGCommand(i,e.command,t,r)}},{key:"loadVGCommand",value:function(e,t,r,i){return e.core.loadVGCommand(t,r,i)}},{key:"shareFile",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{onChoice:function(){},onChange:function(){},onCompleted:function(){},onError:function(){}};this._clearUploadFileCache();var r=-1!==window.location.protocol.indexOf("https"),i="http://e1.shixinyun.com:8080";r&&(i="https://e1.shixinyun.com:9443");var n="__CUBE_WB_FILE_"+Date.now(),o=document.createElement("iframe");o.name=n+"_IFRAME",o.id=n+"_IFRAME",o.className="__CUBE_WB_FILE_CONTAINER";var a=document.createElement("form");a.id=n+"_FORM",a.method="POST",a.enctype="multipart/form-data",a.target=n+"_IFRAME",a.action=i+h.Action.UploadFile+"?name="+this.engine.accName;var s=document.createElement("input");s.id=n+"_FILE",s.name="uploadfile",s.type="file",s.setAttribute("accept",".jpeg, .jpg, .png, .bmp, .gif, .doc, .docx, .ppt, .pptx, .pdf, .mp4, .mp3, .ogg, .wav"),a.appendChild(s),o.appendChild(a),document.body.appendChild(o),this.choiceFileInfoMap.put(n,{upload:!1,id:n});var u=document.getElementById(n+"_FILE");u.onchange=function(){if(u.files&&u.files.length>0){var r=document.getElementById(n+"_FORM");if(r)return"function"==typeof t.onChoice&&t.onChoice(u.files[0]),r.submit(),e._checkFileProgress(t,n),!0}e._clearUploadFileCache(n)},u.click()}},{key:"_clearUploadFileCache",value:function(e){var t=function(e){var t=document.getElementById(e+"_IFRAME");t&&t.parentNode.removeChild(t)};if("string"==typeof e)t(e);else{var r=this.choiceFileInfoMap.values(),i=!0,n=!1,o=void 0;try{for(var a,s=r[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var u=a.value;u.upload||t(u.id)}}catch(e){n=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(n)throw o}}}}},{key:"_checkFileProgress",value:function(){function e(){$.ajax({url:m+h.Action.FileProcess+"?t="+Date.now(),type:"POST",data:{},jsonp:"callbackparam",jsonpCallback:"jsonp_callback",timeout:1e4,dataType:"jsonp",success:function(r){if(200===r.state){var i=r.data,n=i.bytesread,o=i.contentlength,a=i.state;if(200===a){f.onChange(0,n,o);if(i.converting)t();else{var s=i.file;f.onCompleted(s)}}else 100===a||0===a?(f.onChange(0,n,o),d=setTimeout(function(){e()},2e3)):f.onError(new c.CubeError(window.CubeStateCode.WhiteboardUploadFailed,"Upload file to whiteboard failed!"))}},cache:!1,contentType:!1,processData:!1,error:function(){f.onError(new c.CubeError(window.CubeStateCode.WhiteboardUploadFailed,"Upload file to whiteboard failed!"))}})}function t(){$.ajax({url:m+h.Action.ConvertProcess+"?t="+Date.now(),type:"POST",data:{},jsonp:"callbackparam",jsonpCallback:"jsonp_callback",timeout:1e4,dataType:"jsonp",success:function(e){if(200===e.state){var r=e.data.conversion,i=(e.data.name,e.data.filename,e.data.state);console.log("File conversion: "+r),200===i?r===o?setTimeout(function(){t()},2e3):r===a?setTimeout(function(){t()},2e3):r===s?setTimeout(function(){t()},2e3):r===u?f.onCompleted(e.data.file):r===l?f.onError(new c.CubeError(window.CubeStateCode.WhiteboardConvertFailed,"Convert file to whiteboard failed!")):setTimeout(function(){t()},2e3):f.onError(new c.CubeError(window.CubeStateCode.WhiteboardConvertFailed,"Convert file to whiteboard failed!"))}},ache:!1,contentType:!1,processData:!1,error:function(){f.onError(new c.CubeError(window.CubeStateCode.WhiteboardConvertFailed,"Convert file to whiteboard failed!"))}})}var r=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{onChange:function(){},onCompleted:function(){},onError:function(){}},n=arguments[1],o=0,a=1,s=2,u=8,l=16,d=0,f={onChange:function(e,t,r){"function"==typeof i.onChange&&i.onChange(e,t,r)},onCompleted:function(e){r._clearUploadFileCache(n),"function"==typeof i.onCompleted&&i.onCompleted(e)},onError:function(e){r._clearUploadFileCache(n),i.onError(e)}};"function"!=typeof window.jsonp_callback&&(window.jsonp_callback=function(e){});var p=-1!==window.location.protocol.indexOf("https"),m="http://e1.shixinyun.com:8080";p&&(m="https://e1.shixinyun.com:9443"),setTimeout(e,1e3)}}]),t}(s.WhiteboardService)}});
//# sourceMappingURL=cube-whiteboard.js.map