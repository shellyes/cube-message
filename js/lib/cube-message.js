!function(e){function t(s){if(n[s])return n[s].exports;var i=n[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=104)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MessageType={Text:"text",Custom:"custom",File:"file",Image:"image",Voice:"voice",Video:"video",Whiteboard:"whiteboard",WhiteboardClip:"whiteboardclip",Card:"card",History:"history",Location:"location",RichContent:"richcontent",UnKnown:"unKnown"}},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});t.CubeError=function e(t,n){s(this,e),this.code=t,this.message=n}},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEntity=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),r=n(55),a=(n(0),n(12));t.MessageEntity=function(){function e(t){s(this,e),this.sn=e.generateSerialNumber(),this.type=t,this.customData=_cube_timestamp++,this.status=r.MessageStatus.CREATE,this.direction=a.MessageDirection.None,this.receipted=!1,this.receiver=null,this.sender=null,this.group=null,this.sendTime=0,this.receiveTime=0,this.timestamp=0,this.pulled=!1,this.traceless=!1,this.fromDevice=null,this.receivedDevices=null,this.receiptedDevices=null,this.anonymous=!1,this.sync=0,this.tos=null,this.header=new HashMap}return i(e,[{key:"setHeader",value:function(e,t){this.header.put(e,t)}},{key:"getHeader",value:function(e){return this.header.get(e)}},{key:"getSN",value:function(){return this.sn}},{key:"getType",value:function(){return this.type}},{key:"getReceiver",value:function(){return this.receiver}},{key:"getSender",value:function(){return this.sender}},{key:"getSendTime",value:function(){return this.sendTime}},{key:"getReceiveTime",value:function(){return this.receiveTime}},{key:"getTimestamp",value:function(){return this.timestamp}},{key:"hasPulled",value:function(){return this.pulled}},{key:"isGroupMessage",value:function(){return null!=this.group}},{key:"setTraceless",value:function(e){this.traceless=e}},{key:"getTraceless",value:function(){return this.traceless}},{key:"getStatus",value:function(){return this.status}},{key:"getFromDevice",value:function(){return this.fromDevice}},{key:"getReceivedDevices",value:function(){return this.receivedDevices}},{key:"getDirection",value:function(){return this.direction}},{key:"isReceipted",value:function(){return this.receipted}},{key:"setAnonymous",value:function(e){this.anonymous=e}},{key:"setDisplayName",value:function(e){this.sender.displayName=e}},{key:"setSyncType",value:function(e){this.sync=e}},{key:"setOnlyReceivers",value:function(e){this.tos=e}},{key:"toJSON",value:function(){for(var e={},t=this.header.keySet(),n=0;n<t.length;++n){var s=t[n],i=this.header.get(s);null!=i&&(e[s]=i)}var r={sn:this.sn,type:this.type,from:this.sender,to:this.receiver,header:e,sync:this.sync,traceless:this.traceless,time:{send:this.sendTime,receive:this.receiveTime,timestamp:this.timestamp},anonymous:this.anonymous};return this.tos&&(r.tos=this.tos),r}}],[{key:"generateSerialNumber",value:function(){(null==this.gCounts||this.gCounts>=99)&&(this.gCounts=0),++this.gCounts;var e=[],t=new Date,n=t.getDate(),s=t.getHours(),i=t.getMinutes(),r=t.getSeconds();e.push(window.cube._cube_token),e.push(n>9?n:"0"+n),e.push(s>9?s:"0"+s),e.push(i>9?i:"0"+i),e.push(r>9?r:"0"+r),e.push(this.gCounts>9?this.gCounts:"0"+this.gCounts);var a=e.join("");return e.splice(0,e.length),e=null,a=Number(a)}}]),e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.StateCode={Ok:200,Accepted:202,NoContent:204,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UnsupportedMediaType:415,ExpectationFailed:417,TooManyRequests:429,RequestSendFailed:477,TemporarilyUnavailable:480,BusyHere:486,RequestTerminated:487,ServerInternalError:500,GatewayTimeout:504,GetLicenseFail:500,BusyEverywhere:600,Declined:603,DoesNotExistAnywhere:604,ConnectionFailed:700,SignalingStartError:701,TransportError:702,ICEConnectionFailed:703,ParamError:704,CreateSessionDescriptionFailed:705,SetSessionDescriptionFailed:706,RTCInitializeFailed:707,DuplicationException:710,WorkerStateException:711,CallTimeout:712,NotFoundConference:713,UnexpectedCanceled:714,IncorrectState:801,NetworkNotReachable:809,ContentTooLong:810,BlockOversize:811,FormatError:812,ContentError:813,OutOfLimit:814,NoReceiver:815,RecallTimeout:816,NullMessage:817,MessageExpire:818,LostAssets:820,UploadFailed:823,ProcessFailed:825,LoadFileFailed:828,AnswerByOther:900,CancelByOther:901,Unknown:0,InitFailed:1001,LoadLicenseFailed:1002,LicenseOutDate:1003,UnRegister:1004,LicenseServerError:1005,LicenseUpdateError:1006,ReLoginTimeout:1007,RecallError:1100,ForwardError:1101,VoiceClipTooShort:1102,VideoClipTooShort:1103,MessageNotExist:1104,MessageTimeout:1105,ReceiptError:1106,QueryNOData:1107,DispatchFailed:1108,OutDateMessage:1109,FileMessageDownloadFailed:1110,FileMessageDownloadTimeout:1111,NotFoundReceiptMessage:1114,SetTopError:1117,FileNotExistOnServer:1200,FileUploadError:1201,FileDataFormatError:1202,RenamedFailed:1203,CubeStateLoadFileFailed:1204,DeleteFailed:1205,MkdirFailed:1206,FileUsedByOther:1207,GroupAddMasterFailed:1300,GroupRemoveMasterFailed:1301,GroupDestory:1302,GroupNotExist:1303,AlreadyInCalling:1400,ConferenceExist:1500,OverMaxNumber:1501,ConferenceRejectByOther:1502,ConferenceJoinFromOther:1503,ConferenceJoinFailed:1506,ConferenceRejectFailed:1507,ConferenceClosed:1508,ConferenceSipInviteFailed:1551,ConferenceTimeout:1552,ExportWhiteboardFailed:1600,ImportWhiteboardFailed:1601,WhiteboardNotExist:1602,WhiteboardUploadFailed:1603,WhiteboardConvertFailed:1604,CameraOpenFailed:1700,ActiveAudioSessionFailed:1701,MicphoneOpenFailed:1702,VideoConvertFailed:1703,AudioRecorderInitialFailed:1704,AudioRecorderPrepareFailed:1705,AudioPlayDecodeFailed:1706,NotSupportUserMedia:1707,LiveStartFailed:1800,LiveNotExist:1801,NotHavePermission:1e4}},,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.FileMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0),l=n(54),c=n(1),f=n(56),p=n(110),d=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(p);t.FileMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.File));return n.file=null,n.domId=null,n.formFile=null,n.accept="",n.customPostMethod=null,n.customPostParam={},n.pause=!1,n.receiver={name:e},n.fileStatus=l.FileMessageStatus.None,n.key=null,_CUBE_DOMAIN="192.168.1.6",_CUBE_PORT=7070,n.server=new CubeRequest(window.utils.isSecure?"https":"http://"+_CUBE_DOMAIN+":"+_CUBE_PORT),n}return r(t,e),a(t,[{key:"getFileStatus",value:function(){return this.fileStatus}},{key:"getFile",value:function(){return this.file}},{key:"chooseFile",value:function(e){var t=this,n=this._buildForm();n.onchange=function(){if(null!=n.files&&n.files.length>0){var s=n.files[0];t.formFile=s,t.calculate(s,function(n){t.file={modified:0,name:s.name,size:s.size,md5:n},null!=e&&e(s)})}},n.click()}},{key:"setFileByFileList",value:function(e){var t=this;if(null!=e&&e.length>0){this._buildForm().files=e;var n=e[0];return t.calculate(n,function(e){t.file={modified:0,name:n.name,size:n.size,md5:e}}),!0}return!1}},{key:"setFormFile",value:function(e,t){var n=this;return window.FormData&&(this.formFile=e,n.calculate(e,function(s){return n.file={modified:0,name:e.name,size:e.size,md5:s},n.formFile.md5=s,null!=t&&t(e),!0})),!1}},{key:"setMd5",value:function(e){this.file.md5=e}},{key:"calculate",value:function(e,t){function n(){var t=o*r,n=t+r>=e.size?e.size:t+r;s.readAsBinaryString(i.call(e,t,n))}var s=new FileReader,i=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice,r=2097152,a=Math.ceil(e.size/r),o=0,u=new d.default;s.onload=function(e){u.appendBinary(e.target.result),o++,o<a?n():t(u.end())},n()}},{key:"_buildForm",value:function(){this.domId="_cube_file_msg_"+this.customData,this.customPostParam={data:{sn:this.sn,cube:this.receiver.name,file:null},action:this._getServerAction(f.FileAction.StartUpload)};var e=this._getFileFormInfo(),t=e.data,n=document.createElement("div");return n.id=this.domId,n.style.display="none",n.innerHTML='<form id="_form'+this.domId+'" method="POST" enctype="multipart/form-data" action="'+e.action+'" target="_frame'+this.domId+'"><input type="hidden" name="size" value=""/><input type="hidden" name="md5" value=""/><input type="hidden" name="cube" value="'+t.cube+'"/><input type="hidden" name="sn" value="'+t.sn+'"/><input type="file" name="file" accept="'+this.accept+'"/></form><iframe name="_frame'+this.domId+'"></iframe>',document.body.appendChild(n),n.getElementsByTagName("input")[4]}},{key:"_cancel",value:function(){if(this._canceled=!0,null!=this.domId){var e=document.getElementById(this.domId);if(null!=e)return document.body.removeChild(e),!0}return!1}},{key:"_postData",value:function(e,t){var n=this;if(e.type==u.MessageType.Image&&t){if(null!=this.customPostMethod&&"function"==typeof this.customPostMethod)this.customPostMethod(this._getFileRichFormInfo(e));else{var s=new CubeRequest(""),i=this._getFileRichFormInfo(e);delete i.data.file,s.sendFile(i.action,{name:"file",value:this.formFile},i.data,function(e,n){if("function"==typeof t&&t(e,n),e)throw e})}return!0}var r=this,a=this.server,o={sn:e.sn,cube:e.receiver.name,fileName:e.file.name};r.pause=!1,r.key=e.file.key,r.customPostParam={data:{sn:this.sn,cube:this.receiver.name,size:e.file.size,md5:e.file.md5,file:null},action:this._getServerAction(f.FileAction.StartUpload)},e.file.key&&(r.customPostParam.data={sn:this.sn,cube:this.receiver.name,size:e.file.size,md5:e.file.md5,key:e.file.key,file:null},o.key=e.file.key),a.sendFile(f.FileAction.GetProgress,{},o,function(t,s){var i=s.state.code,o={md5:e.file.md5,cube:e.receiver.name,sn:e.sn,size:e.file.size};if(t&&Logger.e("FileMessage#GetProgress"," File GetProgress Message Error"),200==i){if(null!=n.customPostMethod&&"function"==typeof n.customPostMethod)n.customPostParam.start=s.data.current,n.customPostParam.end=s.data.total,n.customPostParam.action=n._getServerAction(f.FileAction.ResumeUpload),n.customPostMethod(n._getFileFormInfo());else{var u=n.formFile,l=s.data.current,c=s.data.total,p=u.slice(l,c);p.name=u.name;var d=new FileReader;d.readAsBinaryString(p),d.onload=function(e){a.sendFile(f.FileAction.ResumeUpload,{name:"file",value:p},o,function(e,t){if(e)throw e})}}cube.getMessageService().delegate.onResumed(e)}else 404==i&&r._customPostMethod()})}},{key:"_customPostMethod",value:function(){if(null!=this.customPostMethod&&"function"==typeof this.customPostMethod)this.customPostMethod(this._getFileFormInfo());else if(null!=this.formFile){var e=new CubeRequest(""),t=this._getFileFormInfo();delete t.data.file,e.sendFile(t.action,{name:"file",value:this.formFile},t.data,function(e){if(e)throw e})}else{var n=this._getFileFormInfo().data,s=document.getElementById("_form"+this.domId);null!=s?(s.action=this._getFileFormInfo().action,s.getElementsByTagName("input")[0].value=n.size,s.getElementsByTagName("input")[1].value=n.md5,s.submit()):Logger.e("FileMessage#_postData","Send File Message Error, No files selected")}}},{key:"_getServerAction",value:function(e){var t=window.location.protocol;return 0!=t.indexOf("http")&&(t="http:"),_CUBE_DOMAIN="192.168.1.6",_CUBE_PORT=7070,t+"//"+_CUBE_DOMAIN+":"+_CUBE_PORT+e}},{key:"_getFileFormInfo",value:function(){return this.customPostParam}},{key:"_getFileRichFormInfo",value:function(e){return{data:{receiver:window.cube.accName+","+e.file.md5,file:null},action:this._getServerAction(f.FileAction.RichMessageUpload)}}},{key:"_notifyAck",value:function(e){var t=!1,n=-1,s=Date.now(),i=0,r=0,a=0,o=this,u=function u(){if(!o._canceled&&!o.pause){var l=Date.now()-s;if(!t&&l<6e4&&setTimeout(function(){u()},5e3),t)if(null!=o.domId){var p=document.getElementById(o.domId);null!=p&&document.body.removeChild(p)}else null!=o.formFile&&(o.formFile=null);else{if(l>=6e4){if(n>0){if(e(new c.CubeError(n,"Upload file timeout")),null!=o.domId){var d=document.getElementById(o.domId);null!=d&&document.body.removeChild(d)}else null!=o.formFile&&(o.formFile=null);return}s=Date.now(),setTimeout(function(){u()},5e3)}var g={sn:o.sn,cube:o.receiver.name,fileName:o.file.name};o.file.key&&(g.key=o.file.key),o.server.sendFile(f.FileAction.GetProgress,{},g,function(s,u){if(200==u.state.code){var l=u.data;i!==parseInt(l.current)?(a=0,i=parseInt(l.current)):a++,r=parseInt(l.total),i===r?(e(!1,i,r),t=!0):a>10?(e(new c.CubeError(CubeStateCode.RequestTimeout,"Upload file timeout")),n=CubeStateCode.RequestTimeout,o._cancel()):e(!1,i,r)}else e(new c.CubeError(u.state.code,u.state.dec)),n=u.state.code,o._cancel()})}}};setTimeout(function(){u()},2e3)}},{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=e.file,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},,,,,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.TextMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0);t.TextMessage=function(e){function t(e,n){s(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.Text));return r.receiver={name:e},r.content=null,void 0!==n&&(r.content=n),r}return r(t,e),a(t,[{key:"getContent",value:function(){return this.content}},{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.content=this.content,e.contentKey=this.contentKey,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name,e.content);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device?e.device:"",n.receivedDevices=e.pulledDevices?e.pulledDevices:"",n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.ImageMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(5),u=n(0),l=n(2);t.ImageMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.type=u.MessageType.Image,n.accept=".jpeg, .jpg, .png, .bmp, .gif",n}return r(t,e),a(t,[{key:"setFileByFileList",value:function(e){if(null!=e&&e.length>0){var t=e[0],n=t.name.split("."),s=n[n.length-1].toLowerCase();if("jpeg"==s||"jpg"==s||"png"==s||"bmp"==s||"gif"==s){return this._buildForm().files=e,this.file={modified:0,name:t.name,size:t.size},!0}}return!1}},{key:"getFile",value:function(){return this.file}},{key:"toJSON",value:function(){var e=l.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=void 0!==e.file?e.file:null,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.FileMessage)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MessageDirection={None:"none",Received:"received",Sent:"sent"}},,,,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.CardMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=(n(5),n(0)),u=n(2);t.CardMessage=function(e){function t(e,n,r,a,u){s(this,t);var l=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return l.type=o.MessageType.Card,l.receiver={name:e},l.title=n,l.icon=r,l.content=a,l.cardContents=[],l.traceless=!1,l.pulled=!1,l.secret=!1,l.group="",l.device=cube.deviceInfo,l}return r(t,e),a(t,[{key:"setCardContents",value:function(e){this.cardContents=e}},{key:"setCardContent",value:function(e,t,n,s){this.cardContents.push({name:e,icon:t,url:n,desc:s})}},{key:"getCardContent",value:function(){return this.cardContents[0]}},{key:"toJSON",value:function(){var e=u.MessageEntity.prototype.toJSON.call(this);return e.content=this.content,e.cardContents=this.cardContents,e.title=this.title,e.icon=this.icon,e.traceless=this.traceless,e.pulled=this.pulled,e.secret=this.secret,e.group=this.group,e.device=this.device,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name,e.title,e.icon,e.content,e.desc);if(n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,void 0!==e.header)for(var s in e.header)n.setHeader(s,e.header[s]);return n.sn=e.sn,n.pulled=e.pulled,n.device=e.device,n.receipted=e.receipted,n.cardContents=e.cardContent?[e.cardContent]:e.cardContents,n}}]),t}(u.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.CustomMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0);t.CustomMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.Custom));return n.receiver={name:e},n.body=null,n.expires=0,n}return r(t,e),a(t,[{key:"setBody",value:function(e){this.body=e}},{key:"getBody",value:function(){return this.body}},{key:"setExpires",value:function(e){this.expires=e}},{key:"getExpires",value:function(){return this.expires}},{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.expires=this.expires,null!=this.body&&(e.body=this.body),e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);if(n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,void 0!==e.header)for(var s in e.header)n.setHeader(s,e.header[s]);return void 0!==e.body&&n.setBody(e.body),n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(2),u=n(0);t.WhiteboardMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.Whiteboard));return n.receiver={name:e},n.content=null,n.domId=null,n.file=null,n.finish=null,n.completeCb=null,n}return r(t,e),a(t,[{key:"fillContent",value:function(e){this.content=JSON.stringify(e),this.file={modified:0,name:Date.now()+".cwb",size:this.content.length}}},{key:"getFile",value:function(){return this.file}},{key:"_buildForm",value:function(){this.domId="_cube_wb_msg_"+this.customData;var e=document.createElement("div");return e.id=this.domId,e.style.display="none",e.innerHTML='<form id="_form'+this.domId+'" method="POST" enctype="multipart/form-data" action="'+this._getServerAction()+'" target="_frame'+this.domId+'"><input type="hidden" name="filename" value="'+this.file.name+'"/><input type="hidden" name="receiver" value="'+this.receiver.name+'"/><input type="hidden" name="sender" value="'+this.sender.name+'"/><input type="hidden" name="sendTime" value="'+this.sendTime+'"/><input type="hidden" name="content" value=\''+this.content+"'/></form><iframe name=\"_frame"+this.domId+'"></iframe>',document.body.appendChild(e),e}},{key:"_postData",value:function(){var e=this._buildForm(),t=e.getElementsByTagName("iframe")[0],n=this;t.onload=function(){setTimeout(function(){n.finish=!0,null!=n.completeCb&&n.completeCb(!1,n.content.length,n.content.length),n._clear()},1e3)};var s=document.getElementById("_form"+this.domId);null!=s?s.submit():Logger.e("CubeWhiteboardMessage#_postData","Send content error")}},{key:"_notifyAck",value:function(e){this.finish?e(!1,this.content.length,this.content.length):this.completeCb=complete}},{key:"_fetchData",value:function(e,t){var n=window.utils.isSecure?"https":"http",s=n+"://"+_CUBE_DOMAIN+":"+_CUBE_PORT+"/message/read/cwb/?receiver="+this.receiver.name+"&sn="+this.sn,i=this;Ajax.newRequest(s).method("GET").send(function(n){200==n.getStatus()?(i.content=n.getData().toString(),e.call(null,i)):t.call(null,i,n.getStatus())})}},{key:"_getServerAction",value:function(){var e=window.location.protocol;return 0!=e.indexOf("http")&&(e="http:"),e+"//"+_CUBE_DOMAIN+":"+_CUBE_PORT+"/message/submit/"}},{key:"_clear",value:function(){if(this.completeCb=null,null!=this.domId){var e=document.getElementById(this.domId);if(null!=e)return document.body.removeChild(e),!0}return!1}},{key:"toJSON",value:function(){var e=o.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=void 0!==e.file?e.file:null,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.VideoMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(5),u=n(0),l=n(2);t.VideoMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.type=u.MessageType.Video,n}return r(t,e),a(t,[{key:"getFile",value:function(){return this.file}},{key:"toJSON",value:function(){var e=l.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=void 0!==e.file?e.file:null,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.FileMessage)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.VoiceMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(5),u=n(0),l=n(2);t.VoiceMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.type=u.MessageType.Voice,n.stopCallback=null,n}return r(t,e),a(t,[{key:"getFile",value:function(){return this.file}},{key:"startRecord",value:function(e){var t=this;cube.utils.getUserMedia(!1,!0,function(n,s){if(n)e(n);else{t.recorder=new MediaRecorder(s),t.audioTrack=s.getAudioTracks()[0];var i=[],r=0;t.recorder.ondataavailable=function(e){i.push(e.data)},t.recorder.onstop=function(e){var n=(Date.now()-r)/1e3;if(!t.canceledRecord){var s=new File(i,"cube_clip_voice"+Date.now()+".ogg",{type:"audio/ogg; codecs=opus"});t.setFormFile(s,function(){t.file.duration=Math.round(n),"function"==typeof t.stopCallback&&t.stopCallback(s)})}i=[],t.canceledRecord=!1},t.recorder.start(),r=Date.now(),e()}})}},{key:"stopRecord",value:function(e){null!=this.recorder&&null!=this.audioTrack&&(this.stopCallback=e,this.recorder.stop(),this.audioTrack.stop(),this.recorder=null,this.audioTrack=null)}},{key:"cancelRecord",value:function(){this.canceledRecord=!0,this.stopRecord()}},{key:"getVoiceFile",value:function(){return this.formFile}},{key:"toJSON",value:function(){var e=l.MessageEntity.prototype.toJSON.call(this);return e.file=this.file,e}}],[{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.file=void 0!==e.file?e.file:null,n.sn=e.sn,n.pulled=e.pulled,n.fromDevice=e.device,n.receivedDevices=e.pulledDevices,n.receipted=e.receipted,n}}]),t}(o.FileMessage)},,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();t.MessageListener=function(e){function t(){return s(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),a(t,[{key:"onSent",value:function(e){}},{key:"onReceived",value:function(e,t){}},{key:"onReceiptedAll",value:function(e,t){}},{key:"onRecalled",value:function(e){}},{key:"onForwarded",value:function(e,t,n){}},{key:"onReceipted",value:function(e){}},{key:"onUploading",value:function(e,t,n){}},{key:"onPaused",value:function(e){}},{key:"onResumed",value:function(e){}},{key:"onUploadCompleted",value:function(e){}},{key:"onMessageSyncBegin",value:function(){}},{key:"onMessagesSyncing",value:function(e){}},{key:"onMessageSyncEnd",value:function(){}},{key:"onConcatTop",value:function(e){}},{key:"onContactFailed",value:function(e){}},{key:"onMessageFailed",value:function(e,t){}}]),t}(CubeListener)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.HistoryMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(0),u=n(2);t.HistoryMessage=function(e){function t(e,n){s(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,o.MessageType.History));return r.receiver={name:e},r.sns=n,r}return r(t,e),a(t,[{key:"getMessages",value:function(){return this.sns}},{key:"setMessages",value:function(e){this.sns=e}},{key:"toJSON",value:function(){var e=u.MessageEntity.prototype.toJSON.call(this);return e.sns=this.sns,e}}],[{key:"parse",value:function(e){var n=new t(e.receiver,e.sns);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.histories=e.histories,n.pulled=e.pulled,n.device=e.device,n.receipted=e.receipted,n}}]),t}(u.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.LocationMessage=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(0),u=n(2);t.LocationMessage=function(e){function t(e,n,r,a){s(this,t);var u=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,o.MessageType.Location));return u.receiver={name:e},u.lat=n,u.lng=r,u.address=a,u}return r(t,e),a(t,[{key:"toJSON",value:function(){var e=u.MessageEntity.prototype.toJSON.call(this);return e.lat=this.lat,e.lng=this.lng,e.address=this.address,e}},{key:"setLat",value:function(e){this.lat=e}},{key:"setLng",value:function(e){this.lng=e}},{key:"setAddress",value:function(e){this.address=e}},{key:"getLat",value:function(){return this.lat}},{key:"getLng",value:function(){return this.lng}},{key:"getAddress",value:function(){return this.address}}],[{key:"parse",value:function(e){var n=new t(e.receiver,e.lat,e.lng,e.name);return n.receiver.displayName=e.to.displayName,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.histories=e.histories,n.pulled=e.pulled,n.device=e.device,n.receipted=e.receipted,n}}]),t}(u.MessageEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.RichContentMessage=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),u=n(0),l=n(2),c=(n(10),n(11));n(12),t.RichContentMessage=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u.MessageType.RichContent));return n.receiver={name:e},n.messages=new Array,n.md5=0,n}return r(t,e),o(t,[{key:"addMessage",value:function(e){this.messages.push(e)}},{key:"removeMessage",value:function(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t]==e){this.messages.splice(t,1);break}}},{key:"addText",value:function(e){var t={type:"text",content:e};this.messages.push(t)}},{key:"addImage",value:function(e){var t=this;this.md5++;var n=new c.ImageMessage(this.receiver.name);n.setFormFile(e,function(){t.md5--}),this.messages.push(n)}},{key:"getMessages",value:function(){return this.sns}},{key:"setMessages",value:function(e){this.sns=e}},{key:"toJSON",value:function(){var e=l.MessageEntity.prototype.toJSON.call(this);return e.contents=this.messages,e}}],[{key:"upload",value:function(e,n){for(var s=this,i=0,r=0;r<n.messages.length;r++){var o=function(r){if("image"==n.messages[r].type){if(i++,n.md5>0)return s.md5Time=setInterval(function(){t.upload(e,n)},500),{v:void 0};clearInterval(s.md5Time),n.messages[r]._postData(n.messages[r],function(t,s){var a=s.data.file,o={type:"image",file:{url:a.url,width:a.width,height:a.height}};i--,n.messages.splice(r,1,o),0==i&&cube.getMessageService().sendMessage(e,n)})}}(r);if("object"===(void 0===o?"undefined":a(o)))return o.v}}},{key:"parse",value:function(e){var n=new t(e.to.name);return n.receiver.displayName=e.to.displayName,n.anonymous=e.anonymous,n.sender={name:e.from.name,displayName:e.from.displayName},void 0!==e.group&&(n.group=e.group,n.groupName=e.group.name),n.sendTime=e.time.send,n.receiveTime=e.time.receive,n.timestamp=e.time.timestamp,n.sn=e.sn,n.pulled=e.pulled,n.device=e.device,n.receipted=e.receipted,n.messages=e.contents,delete n.md5,n}}]),t}(l.MessageEntity)},,,,,,,,,,,,,function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.FileMessageStatus={None:"none",Downloading:"downloading",Uploading:"uploading",Succeed:"succeed",Failed:"failed"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.MessageStatus={CREATE:"create",FAIL:"fail",INPROGRESS:"inprogress",RECALL:"recall",SUCCESS:"success"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.FileAction={PrepareUpload:"/message/file/broken/prepare/",StartUpload:"/message/file/broken/upload/",PauseUpload:"/message/file/broken/pause/",ResumeUpload:"/message/file/broken/resume/",GetProgress:"/message/file/broken/progress/",RichMessageUpload:"/richmessage/file/upload/"}},,,,,,,,,,,function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageServiceWorker=void 0;var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(105),u=n(38),l=n(106),c=n(55),f=n(54),p=n(0),d=n(2),g=n(10),y=n(5),h=n(18),m=n(17),v=n(16),b=n(39),M=n(40),S=n(41),_=n(12),C=n(11),k=n(20),w=n(19),T=n(56),O=n(109);n(3),t.MessageServiceWorker=function(e){function t(e){s(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,u.MessageListener,CELLET.Messaging));return n.msgQueue=new O.MessageQueue(n,n.delegate),n.queryHistoryCallback={},n.meassgeCallback=[],n.pendingMessageList=[],n.dbService=new l.DBMessageService(e),n.callback=new Map,n._msgSizeThreshold=2048,n.lastTimestamp=0,n.session=null,n.notifyTimer=0,n.remainingTimer=0,n.lastSessionName=null,n.syncMessages=[],n}return r(t,e),a(t,[{key:"sendMessage",value:function(e,t){if("string"!=typeof this.session.name)return"string"!=typeof t&&(t.status=c.MessageStatus.FAIL,t.fileStatus&&(t.fileStatus=f.FileMessageStatus.Failed)),!1;if(t.type===p.MessageType.RichContent)for(var n=0;n<t.messages.length;n++)if("image"===t.messages[n].type&&t.md5>0)return S.RichContentMessage.upload(e,t),!0;for(var s=e,i=Date.now();i<=this.lastTimestamp;)i+=1;if(this.lastTimestamp=i,"string"==typeof e)if("string"==typeof t){if(s=new g.TextMessage(e,t),s.content.length>this._msgSizeThreshold)return this.delegate.onMessageFailed(CubeStateCode.ContentTooLong,s),!1}else{if(!(t instanceof d.MessageEntity))return!1;s=t}return s.sender=s.sender?s.sender:{name:this.session.name,displayName:this.session.displayName},s.sendTime=this.lastTimestamp,s.fromDevice=this.engine.getDeviceInfo(),s.direction=_.MessageDirection.Sent,this.msgQueue.enqueue(s),this.engine.registered?this._handleSendMessage(s):(this.pendingMessageList.push(s),!0)}},{key:"_handleSendMessage",value:function(e){if(!nucleus.talkService.isCalled(CELLET.Messaging))return!1;var t=this.engine.connect.send(CELLET.Messaging,CubeConst.ActionPush,e.toJSON());return this.dbService.storageMessage(e),t?(e.status=c.MessageStatus.INPROGRESS,e.fileStatus&&(e.fileStatus=c.MessageStatus.Uploading),!0):(e.status=c.MessageStatus.FAIL,e.fileStatus&&(e.fileStatus=c.MessageStatus.Failed),this.msgQueue.dequeue(e.sn),!1)}},{key:"recallMessage",value:function(e){return null!=this.session&&null!=this.session.name&&this.engine.connect.send(CELLET.Messaging,CubeConst.ActionRecall,{sn:e})}},{key:"forwardMessage",value:function(e,t){if(null==this.session||null==this.session.name)return!1;var n={sns:e,receivers:t};return this.engine.connect.send(CELLET.Messaging,CubeConst.ActionForward,n)}},{key:"cancelMessage",value:function(e){return!!this.msgQueue.read(e.sn)&&("function"==typeof e._cancel&&e._cancel(),this.msgQueue.dequeue(e.sn),!0)}},{key:"receiptMessages",value:function(e){return null!=this.session&&null!=this.session.name&&null!=e&&(this.dbService.storageOffline("offline",e),this.engine.connect.send(CELLET.Messaging,CubeConst.ActionReceipt,{sns:e}))}},{key:"receiptAllMessages",value:function(e){var t=this;if(null==this.session||null==this.session.name)return!1;var n=function(e){return t.engine.connect.send(CELLET.Messaging,CubeConst.ActionReceiptAll,{sn:parseInt(e)})},s=this;this.dbService.querySyncMessage(function(i,r){var a=r[0].offlineAll?r[0].offlineAll:[];0!=a.length&&t.engine.registered?t.dbService.queryMessageBySns(a,function(e,t){if(!e){for(var i=a,r=0,o=0;o<t.length;o++)t[o].receiveTime>=r&&(r=t[o].receiveTime,i=t[o].sn);n(i.toString()),s.dbService.storageOffline("offlineAll",[i])}}):(n(e),a.push(e),s.dbService.storageOffline("offlineAll",a))})}},{key:"receiptOfflineMessages",value:function(){var e=this;if(null==this.session||null==this.session.name)return!1;Logger.i("CubeMessageService","syc begin !!!!"),this.dbService.queryAllMessage(function(t,n){if(!t){for(var s=0,i=[],r=0;r<n.length;++r)n[r].timestamp>=s&&(s=n[r].timestamp),n[r]&&0==n[r].receipted&&i.push(n[r].sn);e.syncMessage(s);var a=function(t){return e.engine.connect.send(CELLET.Messaging,CubeConst.ActionReceiptOffline,{sns:t})};if(i.length>1e3)for(var o=0;o<i.length/1e3;o++)a(i.slice(1e3*o,1e3*o+999));else a(i)}})}},{key:"queryHistory",value:function(e,t,n,s,i){if(null==this.session||null==this.session.name)return!1;if(void 0===s)return!1;if(n<=0)return!1;this.queryHistoryCallback[e]={callback:s},void 0!==i&&(this.queryHistoryCallback[e].error=i);var r={conversation:e,timestamp:t,max:n,type:"history"};return this.engine.connect.send(CELLET.Messaging,CubeConst.ActionHistory,r)}},{key:"syncMessage",value:function(e){if(null==e)return!1;var t=this,n=window.utils.isSecure?"https":"http",s=n+"://"+_CUBE_DOMAIN+":"+_CUBE_PORT+"/message/sync/",i={order:"descending",tag:window.nucleus.tag,name:this.engine.accName,token:"CubeTeam@AdminForEver",syncTimestamp:e};this.delegate.onMessageSyncBegin(),this.engine.triggerCubeEngineState(CubeState.Busy),Logger.i("CubeMessageService","syncMessage Request begin "),Ajax.newRequest(s).method("POST").content(i).send(function(e){Logger.i("CubeMessageService","syncMessage Request end");var n=JSON.parse(e.data);200==n.state.code||t.syncMessages.length?t._handleSyncMessage(n):1113!=n.state.code||t.syncMessages.length||(t.delegate.onMessageSyncEnd(),t.engine.triggerCubeEngineState(CubeState.Ready),Logger.d("CubeMessageService","Not Message Sync"))})}},{key:"_handleSyncMessage",value:function(e){for(var t=this,n=!1,s=e.data.message,i=[],r=[],a=function(){t.delegate.onMessageSyncEnd(),t.engine.triggerCubeEngineState(CubeState.Ready)},o=function(e,t){for(var n=0;n<e.length;n++)t(e[n].sns)},u=0;u<s.length;u++)s.length&&500==s[u].sns.length&&(n=!0);n?(o(s,function(e){i=i.concat(e.slice(0,22)),t.syncMessages=t.syncMessages.concat(e.slice(22))}),t.syncMessageBySns(i),t.syncMessage(e.data.syncTimestamp)):t.syncMessages.length?(o(s,function(e){t.syncMessages=t.syncMessages.concat(e)}),t.syncMessageBySns(t.syncMessages,function(){a()})):(o(s,function(e){i=i.concat(e.slice(0,22)),r=r.concat(e.slice(22))}),t.syncMessageBySns(i,function(){t.syncMessageBySns(r,function(){a()})}))}},{key:"syncMessageBySns",value:function(e,t){var n=this,s=window.utils.isSecure?"https":"http",i=s+"://"+_CUBE_DOMAIN+":"+_CUBE_PORT+"/message/pull/",r={tag:window.nucleus.tag,sns:JSON.stringify(e),token:"CubeTeam@AdminForEver"};Logger.i("CubeMessageService","syncMessageBySns Request begin "),Ajax.newRequest(i).method("POST").content(r).send(function(e){Logger.i("CubeMessageService","syncMessageBySns Request end");var s=JSON.parse(e.data);if(200==s.state.code){for(var i=new Object,r=0;r<s.data.length;r++){i[s.data[r].name]=new Array;for(var a=0;a<s.data[r].messages.length;a++)!function(e){var t=s.data[r].messages[e],a=n._parseMessageJson(t);null!=a&&(n.msgQueue.dequeue(a.sn),a.type==p.MessageType.Text||a.type==p.MessageType.Custom||a.type==p.MessageType.Card?(a.status=t.recall?c.MessageStatus.RECALL:c.MessageStatus.SUCCESS,n.dbService.storageMessage(a)):(a.type!=p.MessageType.File&&a.type!=p.MessageType.Image||(a.sender.name!=n.session.name?a.fileStatus=f.FileMessageStatus.None:a.fileStatus=f.FileMessageStatus.Succeed),a.status=t.recall?c.MessageStatus.RECALL:c.MessageStatus.INPROGRESS,a.type===p.MessageType.Whiteboard?void 0!==a._fetchData&&a._fetchData(function(e){e.status=t.recall?c.MessageStatus.RECALL:c.MessageStatus.SUCCESS,n.dbService.storageMessage(e)},function(e,t){e.status=c.MessageStatus.FAIL,n.delegate.onMessageFailed(t,e)}):n.dbService.storageMessage(a)),i[s.data[r].name].push(a))}(a)}n.delegate.onMessagesSyncing(i),"function"==typeof t&&t()}else n.delegate.onMessageSyncEnd(),n.engine.triggerCubeEngineState(CubeState.Ready),Logger.d("CubeMessageService","No PullMessage")})}},{key:"queryTopConcats",value:function(e){var t=window.utils.isSecure?"https":"http",n=t+"://"+_CUBE_DOMAIN+":"+_CUBE_PORT+"/recent/message/top/list/",s={tag:window.nucleus.tag,master:this.engine.accName,token:"CubeTeam@AdminForEver"};Ajax.newRequest(n).method("POST").content(s).send(function(t){var n=JSON.parse(t.data),s=n.data.recents;200==n.state.code&&e(s)})}},{key:"pauseMessage",value:function(e){var t=this,n=new CubeRequest(window.utils.isSecure?"https":"http://"+_CUBE_DOMAIN+":"+_CUBE_PORT);this.dbService.queryMessageBySns([e],function(e,s){var i=s[0],r={md5:i.file.md5,sn:i.sn,cube:i.receiver.name,fileName:i.file.name},a=t.msgQueue.read(i.sn);void 0!==a.pause&&(a.pause=!0),n.sendFile(T.FileAction.PauseUpload,{},r,function(n,s){if(200==s.state.code&&t.delegate.onPaused(i),e)throw e})})}},{key:"resumeMessage",value:function(e,t){var n=this;this.dbService.queryMessageBySns([e],function(e,s){var i=s[0],r=function(e){void 0!==e.pause&&(e.formFile=t,e.sn=i.sn,e.pause=!1,e._postData(i),n._handleNotifyAck(e))};if(e)Logger.e("SearchMessageBySns","Search Message Error");else if(i.file){var a=n.msgQueue.read(i.sn);if(null!==a)r(a);else{var o=new y.FileMessage(i.receiver);n.msgQueue.dequeue(i.sn),r(o)}}})}},{key:"setTop",value:function(e,t,n){this.callback.set("setTopCallback",n);var s={name:e,top:t?1:0};return this.engine.connect.send(CELLET.Messaging,CubeConst.ActionUpdateTop,s)}},{key:"onRegisterStateChanged",value:function(e){var t=this,n=this;if(this.session=e,this.engine.registered){if(this.dbService.startup(),null==this.lastSessionName||this.lastSessionName==this.session.name)for(var s=0;s<this.pendingMessageList.length;s++){var i=this.pendingMessageList[s];this._handleSendMessage(i)}this.syncCount=0,this.pendingMessageList=[],this.lastSessionName=this.session.name,this.receiptOfflineMessages(),this.dbService.storageSyncMessage({name:n.session.name,offline:[],offlineAll:[]},function(){t.dbService.querySyncMessage(function(e,t){var s=t[0];s&&0!=s.length&&(0!=s.offline.length&&n.receiptMessages(s.offline),0!=s.offlineAll.length&&n.receiptAllMessages(s.offlineAll[0]))})})}else this.dbService.shutdown()}},{key:"onDialogue",value:function(e,t){switch(e){case CubeConst.ActionPushAck:this._processPushAck(t);break;case CubeConst.ActionNotify:this._processNotify(t);break;case CubeConst.ActionPullAck:this._processPullAck(t);break;case CubeConst.ActionRecall:this._processRecall(t);break;case CubeConst.ActionRecallAck:this._processRecallAck(t);break;case CubeConst.ActionReceipt:this._processReceipt(t);break;case CubeConst.ActionReceiptAck:this._processReceiptAck(t);break;case CubeConst.ActionReceiptAll:this._processReceiptAll(t);break;case CubeConst.ActionReceiptAllAck:this._processReceiptAllAck(t);break;case CubeConst.ActionReceiptOfflineAck:this._processReceiptOfflineAck(t);break;case CubeConst.ActionSearchMsgAck:this._processMessageBySnAck(t);break;case CubeConst.ActionSearchMsgsAck:this._processMessagesBySnAck(t);break;case CubeConst.ActionForwardAck:this._processForwardAck(t);break;case CubeConst.ActionHistoryAck:this._processHistoryAck(t);break;case CubeConst.ActionUpdateTop:this._processUpdateTop(t);break;case CubeConst.ActionUpdateTopAck:this._processUpdateTopAck(t)}}},{key:"_processPushAck",value:function(e){var t=this,n=e.getParamAsString("state"),s=e.getParamAsString("data");s||Logger.i("CubeMessageService nucleus dialect error",JSON.stringify(s));var i=this._parseMessageJson(s),r=this.msgQueue.read(s.sn);200===n.code?r?(void 0!==r._notifyAck?(i.file=r.file=Object.assign(i.file,r.file),i.fileStatus=f.FileMessageStatus.Uploading,i.status=c.MessageStatus.INPROGRESS,r._postData(i),t._handleNotifyAck(r)):(i.status=c.MessageStatus.SUCCESS,this.msgQueue.dequeue(r.sn)),this.delegate.onSent(i),this.dbService.storageMessage(i)):this.delegate.onMessageFailed(CubeStateCode.Declined,i):1112===n.code?(i.file.path=r.file.path,i.status=c.MessageStatus.SUCCESS,i.fileStatus=f.FileMessageStatus.Succeed,this.delegate.onSent(i),this.msgQueue.dequeue(r.sn),this.delegate.onUploadCompleted(i)):(r&&this.msgQueue.dequeue(r.sn),this.delegate.onMessageFailed(n.code,i))}},{key:"_handleNotifyAck",value:function(e){var t=this;e._notifyAck(function(n,s,i){n?(e.status=c.MessageStatus.FAIL,e.fileStatus=f.FileMessageStatus.Failed,t.msgQueue.dequeue(e.sn),Logger.e("CubeMessageService","Process file progress error: "+n.code),t.delegate.onMessageFailed(CubeStateCode.RequestTimeout,e)):s===i?(e.status=c.MessageStatus.SUCCESS,e.fileStatus=f.FileMessageStatus.Succeed,t.msgQueue.dequeue(e.sn),t.delegate.onUploadCompleted(e)):(e.status=c.MessageStatus.INPROGRESS,e.fileStatus=f.FileMessageStatus.Uploading,t.delegate.onUploading(e,s,i))})}},{key:"_processNotify",value:function(e){var t=this;this.notifyTimer>0&&clearTimeout(this.notifyTimer),this.notifyTimer=setTimeout(function(){clearTimeout(t.notifyTimer),t.notifyTimer=0,t.engine.connect.send(CELLET.Messaging,CubeConst.ActionPull,{time:Date.now()})},100)}},{key:"_processPullAck",value:function(e){var t=this,n=e.getParamAsString("data");n||Logger.i("CubeMessageService nucleus dialect error",JSON.stringify(n));for(var s=n.messages,i=void 0!==n.remaining?n.remaining:0,r=0;r<s.length;++r){var a=s[r],o=this._parseMessageJson(a);null!=o&&(o.status=c.MessageStatus.SUCCESS,o.type==p.MessageType.Text||o.type==p.MessageType.Custom||o.type==p.MessageType.Card?(this.delegate.onReceived(o),this.dbService.storageMessage(o)):(o.status=c.MessageStatus.INPROGRESS,o.type===p.MessageType.Whiteboard?void 0!==o._fetchData&&function(){var e=t;o._fetchData(function(t){t.status=c.MessageStatus.SUCCESS,e.delegate.onReceived(t),e.dbService.storageMessage(t)},function(t,n){t.status=c.MessageStatus.FAIL,e.delegate.onMessageFailed(n,t)})}():(o.fileStatus&&(o.sender.name!=this.session.name?o.fileStatus=f.FileMessageStatus.None:o.fileStatus=f.FileMessageStatus.Succeed),this.delegate.onReceived(o),this.dbService.storageMessage(o))))}var u=function(){clearTimeout(t.remainingTimer),t.remainingTimer=0};i>0?(this.remainingTimer>0&&u(),this.remainingTimer=setTimeout(function(){u();var e=new ActionDialect;e.setAction(CubeConst.ActionPull),e.appendParam("time",Date.now()),nucleus.talkService.talk(CELLET.Messaging,e)},2e3)):u()}},{key:"_processRecall",value:function(e){var t=e.getParamAsString("data"),n=this._parseMessageJson(t);null!=n?(n.fileStatus&&(n.fileStatus=f.FileMessageStatus.Succeed),n.status=c.MessageStatus.RECALL,this.delegate.onRecalled(n)):this.delegate.onMessageFailed(CubeStateCode.RecallError)}},{key:"_processRecallAck",value:function(e){if(200==e.getParamAsString("state").code){var t=e.getParamAsString("data"),n=this._parseMessageJson(t);null!=n?(n.status=c.MessageStatus.RECALL,n.fileStatus&&(n.fileStatus=f.FileMessageStatus.Succeed),this.delegate.onRecalled(n)):this.delegate.onMessageFailed(CubeStateCode.RecallError)}else this.delegate.onMessageFailed(CubeStateCode.RecallError)}},{key:"_processReceipt",value:function(e){var t=e.getParamAsString("data"),n=e.getParamAsString("state");if(null==t||0==t.sns.length)return!1;200==n.code&&this._handReceipt(t,t.device)}},{key:"_processReceiptAck",value:function(e){this.dbService.storageOffline("offline",[]),this._processReceipt(e)}},{key:"_handReceipt",value:function(e,t){var n=this;this.dbService.queryMessageBySns(e.sns,function(s,i){if(!s){for(var r=0;r<i.length;++r)i[r]&&(i[r].receipted=!0,i[r].receiptedDevices=t,e.messages=i,e.sns[r]=i[r].sn,n.dbService.storageMessage(i[r]));delete e.device,delete e.name,delete e.receiptTimestamp,null!=e&&0!=i.length&&n.delegate.onReceipted(e,t)}})}},{key:"_processReceiptAll",value:function(e){var t=e.getParamAsString("data");if(200==e.getParamAsString("state").code){if(null==t||null==t.sn)return!1;this._handleReceiptAll(t,t.device)}else this.delegate.onMessageFailed(CubeStateCode.ReceiptError)}},{key:"_processReceiptAllAck",value:function(e){this.dbService.storageOffline("offlineAll",[]),this._processReceiptAll(e)}},{key:"_handleReceiptAll",value:function(e,t){var n=this;this.dbService.queryAllMessage(function(s,i){if(!s){var r=void 0;e.messages=new Array,e.sns=new Array;for(var a=0;a<i.length;++a)if(i[a]&&i[a].sn==e.sn){r=i[a];for(var o=0;o<i.length;++o)i[o]&&i[o].sendTime<=r.sendTime&&(r.groupName?r.groupName==i[o].groupName:r.sender.name==i[o].sender.name&&!i[o].groupName)&&!i[o].receipted&&(i[o].receipted=!0,i[o].receiptedDevices=t,e.messages.push(i[o]),e.sns.push(i[o].sn),n.dbService.storageMessage(i[o]));delete e.sn,delete e.device,delete e.name,delete e.receiptTimestamp}null!=e&&0!=e.messages.length&&n.delegate.onReceiptedAll(e,t)}})}},{key:"_processReceiptOfflineAck",value:function(e){var t=this,n=this;if(200==e.getParamAsString("state").code)for(var s=e.getParamAsString("data"),i=0;i<s.receipts.length;i++)!function(e){var i=s.receipts[e].device;t.dbService.queryMessageBySns(s.receipts[e].sns,function(e,t){if(!e){var s={},r=0;if(0==t.length)return!1;s.sns=[];for(var a=0;a<t.length;a++)t[a].anonymous?s.sns.push(t[a].sn):t[a].receiveTime>=r&&(r=t[a].receiveTime,s.sn=t[a].sn);0!=s.sns.length&&n._handReceipt(s,i),s.sn&&n._handleReceiptAll(s,i)}})}(i)}},{key:"_processForwardAck",value:function(e){if(200==e.getParamAsString("state").code){var t=e.getParamAsString("data"),n=t.source,s=t.messages,i=t.failures,r=this._parseMessageJson(n),a=[],o=[];if(void 0!==s)for(var u=0;u<s.length;++u){var l=this._parseMessageJson(s[u]);null!=l&&(this._fixMessage(l,n),a.push(l))}if(void 0!==i)for(var c=0;c<i.length;++c){var f=this._parseMessageJson(i[c]);null!=f&&(this._fixMessage(f,n),o.push(f))}this.delegate.onForwarded(r,a,o)}else this.delegate.onMessageFailed(CubeStateCode.ForwardError)}},{key:"_processHistoryAck",value:function(e){var t=e.getParamAsString("state"),n=e.getParamAsString("data"),s=n.conversation,i=n.timestamp;if(200==t.code){for(var r=[],a=n.messages,o=0;o<a.length;++o){var u=a[o],l=this._parseMessageJson(u);r.push(l)}void 0!==this.queryHistoryCallback[s]&&(this.queryHistoryCallback[s].callback.call(null,s,i,r),delete this.queryHistoryCallback[s])}else void 0!==s&&void 0!==this.queryHistoryCallback[s]&&void 0!==this.queryHistoryCallback[s].error&&(this.queryHistoryCallback[s].error.call(null,t.code,s,i),delete this.queryHistoryCallback[s])}},{key:"_processMessageBySnAck",value:function(e){var t=e.getParamAsString("state"),n=e.getParamAsString("data"),s=this.meassgeCallback.shift();if(200==t.code&&null!=n){var i=this._parseMessageJson(n);i.type!=p.MessageType.Text&&i.type!=p.MessageType.Custom&&i.type!=p.MessageType.Card||(this.dbService.storageMessage(i),s(!1,i))}}},{key:"_processMessagesBySnAck",value:function(e){var t=e.getParamAsString("state"),n=e.getParamAsString("data"),s=this.meassgeCallback.shift(),i=new Array;if(200==t.code){if(null!=n){n.msgs.sort(function(e,t){return t.time.timestamp-e.time.timestamp});for(var r=0;r<n.msgs.length;++r){var a=this._parseMessageJson(n.msgs[r]);i.push(a),a.status=c.MessageStatus.SUCCESS,this.dbService.storageMessage(a)}s(!1,i.reverse())}}else s(!1,[])}},{key:"_processUpdateTop",value:function(e){var t=(e.getParamAsString("state"),e.getParamAsString("data"));null!=t&&this.delegate.onConcatTop(t)}},{key:"_processUpdateTopAck",value:function(e){var t=e.getParamAsString("state"),n=e.getParamAsString("data");200==t.code&&null!=n&&this.callback.get("setTopCallback")(n)}},{key:"_parseMessageJson",value:function(e){var t=null;return e||Logger.i("CubeMessageService _parseMessageJson json error",JSON.stringify(e)),e.type==p.MessageType.Text?t=g.TextMessage.parse(e):e.type==p.MessageType.Image?t=C.ImageMessage.parse(e):e.type==p.MessageType.Voice?t=k.VoiceMessage.parse(e):e.type==p.MessageType.Video?t=w.VideoMessage.parse(e):e.type==p.MessageType.Whiteboard?t=h.WhiteboardMessage.parse(e):e.type==p.MessageType.File?t=y.FileMessage.parse(e):e.type==p.MessageType.Custom?t=m.CustomMessage.parse(e):e.type==p.MessageType.Card?t=v.CardMessage.parse(e):e.type==p.MessageType.History?t=b.HistoryMessage.parse(e):e.type==p.MessageType.Location?t=M.LocationMessage.parse(e):e.type==p.MessageType.RichContent?t=S.RichContentMessage.parse(e):Logger.w("CubeMessageService","Error message json format: "+JSON.stringify(e)),null!=t&&(t.anonymous=e.anonymous,t.direction=this.engine.accName==t.sender.name?_.MessageDirection.Sent:_.MessageDirection.Received),t}},{key:"_fixMessage",value:function(e,t){if(t.type==p.MessageType.Text)e.content=t.content;else if(t.type==p.MessageType.Image)e.file=t.file;else if(t.type==p.MessageType.Voice)e.file=t.file;else if(t.type==p.MessageType.Video)e.file=t.file;else if(t.type==p.MessageType.Whiteboard)e.file=t.file;else if(t.type==p.MessageType.File)e.file=t.file;else if(t.type==p.MessageType.Card)e.content=t.content;else if(t.type==p.MessageType.History)e.content=t.content;else if(t.type==p.MessageType.Custom){if(void 0!==t.header)for(var n in t.header)e.setHeader(n,t.header[n]);void 0!==t.body&&e.setBody(t.body)}else Logger.w("CubeMessageService","Error message json format: "+JSON.stringify(t));return e}}]),t}(o.MessageService)},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";var s=n(67),i=n(38),r=n(11),a=n(19),o=n(20),u=n(16),l=n(17),c=n(5),f=n(10),p=n(18),d=n(39),g=n(41),y=n(40),h=n(0);!function(e){e.CubeMessageServiceWorker=s.MessageServiceWorker,e.CubeMessageListener=i.MessageListener,e.CubeImageMessage=r.ImageMessage,e.CubeVideoMessage=a.VideoMessage,e.CubeVoiceMessage=o.VoiceMessage,e.CubeCardMessage=u.CardMessage,e.CubeCustomMessage=l.CustomMessage,e.CubeFileMessage=c.FileMessage,e.CubeTextMessage=f.TextMessage,e.CubeHiststory=d.HistoryMessage,e.CubeWhiteboardMessage=p.WhiteboardMessage,e.CubeRichContentMessage=g.RichContentMessage,e.CubeLocationMessage=y.LocationMessage,e.CubeMessageType=h.MessageType}(window)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();t.MessageService=function(e){function t(){return s(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return r(t,e),a(t,[{key:"sendMessage",value:function(e,t){}},{key:"recallMessage",value:function(e){}},{key:"forwardMessage",value:function(e,t){}},{key:"queryHistory",value:function(e,t,n,s,i){}},{key:"queryMessageBySns",value:function(e,t){}},{key:"cancelMessage",value:function(e){}},{key:"receiptMessages",value:function(e){}},{key:"receiptAllMessages",value:function(e){}},{key:"setTop",value:function(e,t,n){}},{key:"syncMessages",value:function(e){}},{key:"pauseMessage",value:function(e,t){}},{key:"resumeMessage",value:function(e){}}]),t}(CubeService)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.DBMessageService=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),r=n(107),a=n(108),o=n(0),u=n(12),l=n(10),c=n(5),f=n(18),p=n(11),d=n(20),g=n(19),y=n(16),h=n(17);t.DBMessageService=function(){function e(t){s(this,e),this.engine=t,this.dbm=null}return i(e,[{key:"startup",value:function(){this.dbm=new CubeDBManager("CubeMessageDataBase_"+this.engine.accName),this.dbm.loadEntity(r.CubeDBMessage),this.dbm.loadEntity(a.CubeDBSyncMessage),this.dbm.connect(function(){})}},{key:"shutdown",value:function(){this.dbm&&this.dbm.disconnect(function(){}),this.dbm=null}},{key:"storageMessage",value:function(e){var t=this;if(!this.dbm)return void setTimeout(function(){t.storageMessage(e)},500);var n=e.toJSON();e.fileStatus&&(n.fileStatus=e.fileStatus);var s=new r.CubeDBMessage(e.sn,e.sn,JSON.stringify(e.getSender()),JSON.stringify(e.getReceiver()),e.group?JSON.stringify(e.group):null,e.type,e.timestamp,e.getStatus(),JSON.stringify(e.getFromDevice()),JSON.stringify(e.getReceivedDevices()),e.isReceipted()?1:0,e.anonymous?1:0,JSON.stringify(n));this.dbm.setEntity(s,function(e){})}},{key:"storageSyncMessage",value:function(e,t){var n=this,s=this;if(!this.dbm)return void setTimeout(function(){n.storageSyncMessage(e)},500);this.querySyncMessage(function(n,i){var r=i[0];r&&r.offline&&(e.offline=r.offline),r&&r.offlineAll&&(e.offlineAll=r.offlineAll);var o=new a.CubeDBSyncMessage(e.name,e.name,null,null,e.offline,e.offlineAll);s.dbm.setEntity(o,function(e){t()})})}},{key:"storageOffline",value:function(e,t,n){var s=this,i=this;if(!this.dbm)return this.startup(),this.storageOffline(e,t),void setTimeout(function(){s.shutdown()},500);this.querySyncMessage(function(s,r){var o=r[0];for(var u in o)u==e&&(o[e]=t);var l=new a.CubeDBSyncMessage(o.name,o.name,o.Messages,o.syncTimestamp,o.offline,o.offlineAll);i.dbm.setEntity(l,function(e){"function"==typeof n&&n(e)})})}},{key:"querySyncMessage",value:function(e){var t=this;if(!this.dbm)return this.startup(),this.querySyncMessage(e),void setTimeout(function(){t.shutdown()},500);var n=new a.CubeDBSyncMessage;this.dbm.getEntitysByColumn(n,"name",this.engine.accName,function(t,n){t?e(t):n?e(!1,n):e(!1,null)})}},{key:"queryMessageBySns",value:function(e,t){var n=this,s=new r.CubeDBMessage(e);this.dbm.getEntitysByColumns(s,"id",e,function(e,s){if(e)t(e);else if(s&&s.length>0){for(var i=[],r=0;r<s.length;++r)n._parseMessage(s[r])&&i.push(n._parseMessage(s[r]));t(!1,i)}else t(!1,null)})}},{key:"queryAllMessage",value:function(e){var t=this,n=new r.CubeDBMessage;this.dbm.getAllEntity(n,function(n,s){if(n)e(n);else if(s){for(var i=[],r=0;r<s.length;++r)t._parseMessage(s[r])&&i.push(t._parseMessage(s[r]));e(!1,i)}else e(!1,null)})}},{key:"queryMessageByColumn",value:function(e,t,n){var s=this,i=new r.CubeDBMessage;this.dbm.getEntitysByColumn(i,e,t,function(e,t){if(e)n(e);else if(t){for(var i=[],r=0;r<t.length;++r)s._parseMessage(t[r])&&i.push(s._parseMessage(t[r]));n(!1,i)}else n(!1,null)})}},{key:"_parseMessage",value:function(e){var t=void 0;if(void 0==e)return!1;var n=e.receiver?JSON.parse(e.receiver):null,s=JSON.parse(e.sender),i=e.groupInfo?JSON.parse(e.groupInfo):null,r=JSON.parse(e.json);if(e.type===o.MessageType.Text)t=new l.TextMessage(n.name,r.content);else if(e.type===o.MessageType.File)t=new c.FileMessage(n.name),t.file=r.file;else if(e.type===o.MessageType.Image)t=new p.ImageMessage(n.name),t.file=r.file;else if(e.type===o.MessageType.Voice)t=new d.VoiceMessage(n.name),t.file=r.file;else if(e.type===o.MessageType.Video)t=new g.VideoMessage(n.name),t.file=r.file;else if(e.type===o.MessageType.Whiteboard)t=new f.WhiteboardMessage(n.name),t.file=r.file;else if(e.type===o.MessageType.Card)t=new y.CardMessage(n.name,r.title,r.icon,r.url),t.file=r.file;else if(e.type===o.MessageType.Custom){if(t=new h.CustomMessage(n.name),void 0!==r.header)for(var a in r.header)t.setHeader(a,r.header[a]);void 0!==r.body&&t.setBody(r.body)}return t?(t.sn=e.sn,t.sender=s,t.receiver=n,null!==i&&(t.group=i,t.groupName=i.name),t.sendTime=r.time.send,t.receiveTime=r.time.receive,t.timestamp=r.time.timestamp,t.traceless=r.traceless,t.status=e.status,t.fromDevice=e.fromDevice?JSON.parse(e.fromDevice):"",t.receivedDevices=e.receivedDevices?JSON.parse(e.receivedDevices):"",t.direction=this.engine.accName===t.sender?u.MessageDirection.Sent:u.MessageDirection.Received,t.receipted=1===e.receipted,t.anonymous=!!r.anonymous,t.fileStatus&&(t.fileStatus=r.fileStatus),t):void 0}}]),e}()},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});t.CubeDBMessage=function(e){function t(e,n,r,a,o,u,l,c,f,p,d,g,y){s(this,t);var h=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"CubeDBMessage"));return h.sn=n,h.sender=r,h.receiver=a,h.groupInfo=o,h.type=u,h.sendTimestamp=l,h.status=c,h.fromDevice=f,h.receivedDevices=p,h.json=y,h.receipted=d,h.anonymous=g,h}return r(t,e),t}(CubeDBEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});t.CubeDBSyncMessage=function(e){function t(e,n,r,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];s(this,t);var l=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"CubeDBSyncMessage"));return l.Messages=r,l.name=n,l.syncTimestamp=a,l.offline=o,l.offlineAll=u,l}return r(t,e),t}(CubeDBEntity)},function(e,t,n){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();t.MessageQueue=function(){function e(t,n){s(this,e),this.list=[],this.fileList=[],this.timeout=18e4,this.tick=null,this.delegate=n,this.worker=t}return i(e,[{key:"read",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t)for(var n=0;n<this.worker.pendingMessageList.length;n++){var s=this.worker.pendingMessageList[n];s.sn===e&&this.worker.pendingMessageList.splice(n,1)}for(var i=0;i<this.list.length;i++){var r=this.list[i];if(r.sn===e)return t&&this.list.splice(i,1),r}var a=!0,o=!1,u=void 0;try{for(var l,c=this.fileList[Symbol.iterator]();!(a=(l=c.next()).done);a=!0){var f=l.value;if(f.sn===e)return f}}catch(e){o=!0,u=e}finally{try{!a&&c.return&&c.return()}finally{if(o)throw u}}return null}},{key:"enqueue",value:function(e){var t=this;if(e._notifyAck)this.fileList.push(e);else{var n=e.sn;this.list.push(e),this.list.length<=1&&(this.tick=setTimeout(function(){t.check(n)},this.timeout))}}},{key:"dequeue",value:function(e){this.read(e,!0),0===this.list.length&&clearTimeout(this.tick)}},{key:"check",value:function(e){var t=this,n=this.read(e,!0);if(n&&this.delegate.onMessageFailed(CubeStateCode.RequestTimeout,n),this.list.length>0){var s=this.list[0],i=this.timeout-(Date.now()-s.sendTime);this.tick=setTimeout(function(){t.check(s.sn)},i>0?i:0)}}}]),e}()},function(e,t,n){"use strict";var s,i,r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(a){if("object"===r(t))e.exports=a();else{s=a,void 0!==(i="function"==typeof s?s.call(t,n,t,e):s)&&(e.exports=i)}}(function(e){function t(e,t){var n=e[0],s=e[1],i=e[2],r=e[3];n+=(s&i|~s&r)+t[0]-680876936|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[1]-389564586|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[2]+606105819|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[3]-1044525330|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[4]-176418897|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[5]+1200080426|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[6]-1473231341|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[7]-45705983|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[8]+1770035416|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[9]-1958414417|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[10]-42063|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[11]-1990404162|0,s=(s<<22|s>>>10)+i|0,n+=(s&i|~s&r)+t[12]+1804603682|0,n=(n<<7|n>>>25)+s|0,r+=(n&s|~n&i)+t[13]-40341101|0,r=(r<<12|r>>>20)+n|0,i+=(r&n|~r&s)+t[14]-1502002290|0,i=(i<<17|i>>>15)+r|0,s+=(i&r|~i&n)+t[15]+1236535329|0,s=(s<<22|s>>>10)+i|0,n+=(s&r|i&~r)+t[1]-165796510|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[6]-1069501632|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[11]+643717713|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[0]-373897302|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[5]-701558691|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[10]+38016083|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[15]-660478335|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[4]-405537848|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[9]+568446438|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[14]-1019803690|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[3]-187363961|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[8]+1163531501|0,s=(s<<20|s>>>12)+i|0,n+=(s&r|i&~r)+t[13]-1444681467|0,n=(n<<5|n>>>27)+s|0,r+=(n&i|s&~i)+t[2]-51403784|0,r=(r<<9|r>>>23)+n|0,i+=(r&s|n&~s)+t[7]+1735328473|0,i=(i<<14|i>>>18)+r|0,s+=(i&n|r&~n)+t[12]-1926607734|0,s=(s<<20|s>>>12)+i|0,n+=(s^i^r)+t[5]-378558|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[8]-2022574463|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[11]+1839030562|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[14]-35309556|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[1]-1530992060|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[4]+1272893353|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[7]-155497632|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[10]-1094730640|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[13]+681279174|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[0]-358537222|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[3]-722521979|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[6]+76029189|0,s=(s<<23|s>>>9)+i|0,n+=(s^i^r)+t[9]-640364487|0,n=(n<<4|n>>>28)+s|0,r+=(n^s^i)+t[12]-421815835|0,r=(r<<11|r>>>21)+n|0,i+=(r^n^s)+t[15]+530742520|0,i=(i<<16|i>>>16)+r|0,s+=(i^r^n)+t[2]-995338651|0,s=(s<<23|s>>>9)+i|0,n+=(i^(s|~r))+t[0]-198630844|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[7]+1126891415|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[14]-1416354905|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[5]-57434055|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[12]+1700485571|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[3]-1894986606|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[10]-1051523|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[1]-2054922799|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[8]+1873313359|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[15]-30611744|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[6]-1560198380|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[13]+1309151649|0,s=(s<<21|s>>>11)+i|0,n+=(i^(s|~r))+t[4]-145523070|0,n=(n<<6|n>>>26)+s|0,r+=(s^(n|~i))+t[11]-1120210379|0,r=(r<<10|r>>>22)+n|0,i+=(n^(r|~s))+t[2]+718787259|0,i=(i<<15|i>>>17)+r|0,s+=(r^(i|~n))+t[9]-343485551|0,s=(s<<21|s>>>11)+i|0,e[0]=n+e[0]|0,e[1]=s+e[1]|0,e[2]=i+e[2]|0,e[3]=r+e[3]|0}function n(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return n}function s(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n}function i(e){var s,i,r,a,o,u,l=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(s=64;s<=l;s+=64)t(c,n(e.substring(s-64,s)));for(e=e.substring(s-64),i=e.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s=0;s<i;s+=1)r[s>>2]|=e.charCodeAt(s)<<(s%4<<3);if(r[s>>2]|=128<<(s%4<<3),s>55)for(t(c,r),s=0;s<16;s+=1)r[s]=0;return a=8*l,a=a.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(a[2],16),u=parseInt(a[1],16)||0,r[14]=o,r[15]=u,t(c,r),c}function r(e){var n,i,r,a,o,u,l=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(n=64;n<=l;n+=64)t(c,s(e.subarray(n-64,n)));for(e=n-64<l?e.subarray(n-64):new Uint8Array(0),i=e.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n=0;n<i;n+=1)r[n>>2]|=e[n]<<(n%4<<3);if(r[n>>2]|=128<<(n%4<<3),n>55)for(t(c,r),n=0;n<16;n+=1)r[n]=0;return a=8*l,a=a.toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(a[2],16),u=parseInt(a[1],16)||0,r[14]=o,r[15]=u,t(c,r),c}function a(e){var t,n="";for(t=0;t<4;t+=1)n+=g[e>>8*t+4&15]+g[e>>8*t&15];return n}function o(e){var t;for(t=0;t<e.length;t+=1)e[t]=a(e[t]);return e.join("")}function u(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function l(e,t){var n,s=e.length,i=new ArrayBuffer(s),r=new Uint8Array(i);for(n=0;n<s;n+=1)r[n]=e.charCodeAt(n);return t?r:i}function c(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function f(e,t,n){var s=new Uint8Array(e.byteLength+t.byteLength);return s.set(new Uint8Array(e)),s.set(new Uint8Array(t),e.byteLength),n?s:s.buffer}function p(e){var t,n=[],s=e.length;for(t=0;t<s-1;t+=2)n.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,n)}function d(){this.reset()}var g=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];return"5d41402abc4b2a76b9719d911017c592"!==o(i("hello"))&&function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function t(e,t){return e=0|e||0,e<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(n,s){var i,r,a,o,u=this.byteLength,l=t(n,u),c=u;return s!==e&&(c=t(s,u)),l>c?new ArrayBuffer(0):(i=c-l,r=new ArrayBuffer(i),a=new Uint8Array(r),o=new Uint8Array(this,l,i),a.set(o),r)}}(),d.prototype.append=function(e){return this.appendBinary(u(e)),this},d.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var s,i=this._buff.length;for(s=64;s<=i;s+=64)t(this._hash,n(this._buff.substring(s-64,s)));return this._buff=this._buff.substring(s-64),this},d.prototype.end=function(e){var t,n,s=this._buff,i=s.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)r[t>>2]|=s.charCodeAt(t)<<(t%4<<3);return this._finish(r,i),n=o(this._hash),e&&(n=p(n)),this.reset(),n},d.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},d.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},d.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},d.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},d.prototype._finish=function(e,n){var s,i,r,a=n;if(e[a>>2]|=128<<(a%4<<3),a>55)for(t(this._hash,e),a=0;a<16;a+=1)e[a]=0;s=8*this._length,s=s.toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(s[2],16),r=parseInt(s[1],16)||0,e[14]=i,e[15]=r,t(this._hash,e)},d.hash=function(e,t){return d.hashBinary(u(e),t)},d.hashBinary=function(e,t){var n=i(e),s=o(n);return t?p(s):s},d.ArrayBuffer=function(){this.reset()},d.ArrayBuffer.prototype.append=function(e){var n,i=f(this._buff.buffer,e,!0),r=i.length;for(this._length+=e.byteLength,n=64;n<=r;n+=64)t(this._hash,s(i.subarray(n-64,n)));return this._buff=n-64<r?new Uint8Array(i.buffer.slice(n-64)):new Uint8Array(0),this},d.ArrayBuffer.prototype.end=function(e){var t,n,s=this._buff,i=s.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)r[t>>2]|=s[t]<<(t%4<<3);return this._finish(r,i),n=o(this._hash),e&&(n=p(n)),this.reset(),n},d.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},d.ArrayBuffer.prototype.getState=function(){var e=d.prototype.getState.call(this);return e.buff=c(e.buff),e},d.ArrayBuffer.prototype.setState=function(e){return e.buff=l(e.buff,!0),d.prototype.setState.call(this,e)},d.ArrayBuffer.prototype.destroy=d.prototype.destroy,d.ArrayBuffer.prototype._finish=d.prototype._finish,d.ArrayBuffer.hash=function(e,t){var n=r(new Uint8Array(e)),s=o(n);return t?p(s):s},d})}]);
//# sourceMappingURL=cube-message.js.map