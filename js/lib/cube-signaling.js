!function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=116)}({116:function(e,t,n){"use strict";var i=n(73),r=n(45),a=n(21),o=n(22),s=n(44),c=n(71),l=n(72),d=n(70),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(d),p=n(46),h=n(47);!function(e){if(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,(window.utils.isIE||window.utils.isSafari)&&window.utils.isDesktop){var t=document.createElement("script");t.setAttribute("src","http://"+_CUBE_DOMAIN+"/libs/adapter-min.js"),t.onload=function(e){AdapterJS.webRTCReady(function(e){Logger.d("CubeEngine","WebRTC Plugin Ready!")})},document.body.appendChild(t)}e.CubeCallServiceWorker=i.CallServiceWorker,e.CubeCallListener=r.CallListener,e.CubeCallDirection=a.CallDirection,e.CubeSignalingState=o.SignalingState,e.CubeVideoSize=s.VideoSize,e.CubeMediaProbe=c.MediaProbe,e.CubeMediaServiceWorker=l.MediaServiceWorker,e.webrtcAdapter=u,e.CubeCall=p.Call,e.CubeCallSession=h.CallSession}(window)},117:function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.MediaService=function(){function e(){i(this,e)}return r(e,[{key:"addMediaProbe",value:function(e){}},{key:"removeMediaProbe",value:function(e){}},{key:"closeVoice",value:function(){}},{key:"closeVideo",value:function(){}},{key:"openVoice",value:function(){}},{key:"openVideo",value:function(){}},{key:"isVoiceEnabled",value:function(){}},{key:"isVideoEnabled",value:function(){}},{key:"setVolume",value:function(e){}},{key:"getVolume",value:function(){}},{key:"mute",value:function(){}},{key:"getLocalVideoSize",value:function(){}},{key:"getRemoteVideoSize",value:function(){}},{key:"getCapturedCameraImage",value:function(e){}},{key:"capture",value:function(e,t){}},{key:"queryRecordArchives",value:function(e,t,n,i){}},{key:"loadArchive",value:function(e,t,n,i){}},{key:"hasLocalRecorded",value:function(){}},{key:"isLocalRecording",value:function(){}},{key:"startLocalRecording",value:function(e){}},{key:"stopLocalRecording",value:function(e){}},{key:"replayLocalRecording",value:function(e,t){}},{key:"getLocalRecorder",value:function(){}},{key:"hasRemoteRecorded",value:function(){}},{key:"isRemoteRecording",value:function(){}},{key:"startRemoteRecording",value:function(e){}},{key:"stopRemoteRecording",value:function(e){}},{key:"getRemoteRecorder",value:function(){}},{key:"changeVideoElement",value:function(e,t){}}]),e}()},118:function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.CallService=function(e){function t(){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),o(t,[{key:"setAutoAnswer",value:function(e){}},{key:"answerCall",value:function(){}},{key:"makeCall",value:function(e,t,n){}},{key:"terminateCall",value:function(){}},{key:"reply",value:function(e,t,n){}},{key:"changeMediaDevice",value:function(e){}}]),t}(CubeService)},119:function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.CallServiceDelegate=void 0;var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(22);t.CallServiceDelegate=function(e){function t(e,n){i(this,t);var a=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.engine=n,a.startTime=0,a}return a(t,e),o(t,[{key:"didInvite",value:function(e,t,n,i){if(Logger.d("CubeCallServiceDelegate","onNewCall"),this.engine.session.callDirection=t,this.engine.session.callState=s.SignalingState.Invite,this.engine.session.callTime=0,null!=this.engine.session.callPeer&&this.engine.session.callPeer.name==n||(this.engine.session.setCallPeer(new CubePeer(n)),null!=e.targetData&&(this.engine.session.callPeer.displayName=e.targetData.displayName)),this.onNewCall(t,this.engine.session,i),this.engine.session.isConferenceCall()){var r=this.engine.getConferenceService().getConference();null!=r&&this.engine.responder.start(r.host,!1)}else this.engine.responder.start(_CUBE_DOMAIN,!0);e.localVideo.style.visibility="visible"}},{key:"didRinging",value:function(e,t){Logger.d("CubeCallServiceDelegate","onCallRinging"),this.engine.session.callPeer.displayName=e.targetData.displayName,this.engine.session.callState=s.SignalingState.Ringing,this.onCallRinging(this.engine.session)}},{key:"didIncall",value:function(e,t,n,i){Logger.d("CubeCallServiceDelegate","onCallConnected"),this.startTime=Date.now(),this.engine.session.callState=s.SignalingState.Incall,this.onCallConnected(this.engine.session),e.remoteVideo.style.visibility="visible"}},{key:"didEnd",value:function(e,t,n){Logger.d("CubeCallServiceDelegate","onCallEnded",t),this.engine.responder.stop(),this.engine.session.callState!=s.SignalingState.End&&(this.engine.session.callState=s.SignalingState.End,this.engine.session.callTime=0==this.startTime?0:Date.now()-this.startTime,this.engine.session.callPeer=null,null!=e.videoCloseHandler&&e.videoCloseHandler.call(null,e),this.onCallEnded(this.engine.session,n),e.localVideo&&(e.localVideo.style.visibility="hidden"),e.localVideo&&(e.remoteVideo.style.visibility="hidden"))}},{key:"didProgress",value:function(e,t){Logger.d("CubeCallServiceDelegate","onInProgress"),this.engine.session.callState=s.SignalingState.Progress,this.onInProgress(this.engine.session)}},{key:"didFailed",value:function(e,t,n){Logger.d("CubeCallServiceDelegate","onCallFailed"),this.engine.session.callState=s.SignalingState.None,this.engine.session.callPeer=null,this.onCallFailed(this.engine.session,n),e.localVideo.style.visibility="hidden",e.remoteVideo.style.visibility="hidden",this.engine.responder.stop()}},{key:"didReverseCall",value:function(e,t){Logger.d("CubeCallServiceDelegate","onReverseCall"),this.onReverseCall(this.engine.session)}}]),t}(CubeDelegate)},21:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.CallDirection={Outgoing:"outgoing",Incoming:"incoming"}},22:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.SignalingState={None:0,Progress:1,Invite:2,Ringing:3,Incall:4,End:5}},44:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.VideoSize={SQCIF:{width:128,height:96},QQVGA:{width:160,height:120},QVGA:{width:320,height:240},CIF:{width:352,height:288},VGA:{width:640,height:480},SVGA:{width:800,height:600},HD:{width:960,height:720},XGA:{width:1024,height:768},SXGA:{width:1280,height:1024},UXGA:{width:1600,height:1200},WQVGA:{width:400,height:240},WCIF:{width:512,height:288},WVGA:{width:800,height:480},WSVGA:{width:1024,height:600},WHD:{width:1280,height:720},WXGA:{width:1280,height:768},WUXGA:{width:1920,height:1200},W432P:{width:768,height:432},W480P:{width:768,height:480}}},45:function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.CallListener=function(e){function t(){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,e),o(t,[{key:"onNewCall",value:function(e,t,n){}},{key:"onInProgress",value:function(e){}},{key:"onCallRinging",value:function(e){}},{key:"onCallConnected",value:function(e){}},{key:"onCallHold",value:function(e){}},{key:"onCallEnded",value:function(e,t){}},{key:"onCallFailed",value:function(e,t){}},{key:"onReverseCall",value:function(e){}}]),t}(CubeListener)},46:function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.Call=function(){function e(){i(this,e),this.cubeId=null,this.displayName=null,this.isVideo=!0,this.sdp=null,this.ices=[],this.candidates=[]}return r(e,[{key:"setCubeId",value:function(e){this.cubeId=e}},{key:"getCubeId",value:function(){return this.cubeId}},{key:"setDisplayName",value:function(e){this.displayName=e}},{key:"getDisplayName",value:function(){return this.displayName}},{key:"setSdp",value:function(e){this.sdp=e}},{key:"getSdp",value:function(){return this.sdp}},{key:"setIces",value:function(e){this.ices=e}},{key:"getIces",value:function(){return this.ices}},{key:"setCandidates",value:function(e){this.candidates=e}},{key:"getCandidates",value:function(){return this.candidates}}]),e}()},47:function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.CallSession=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),a=n(21);t.CallSession=function(){function e(){i(this,e),this.caller=null,this.callee=null,this.inviteTimes=0,this.inCallTime=0,this.endCallTime=0,this.isBusy=!1,this.direction=a.CallDirection.Outgoing}return r(e,[{key:"setCaller",value:function(e){this.caller=e}},{key:"getCaller",value:function(){return this.caller}},{key:"setCallee",value:function(e){this.callee=e}},{key:"getCallee",value:function(){return this.callee}},{key:"setInviteTimes",value:function(e){this.inviteTimes=e}},{key:"getInviteTimes",value:function(){return this.inviteTimes}},{key:"setInCallTime",value:function(e){this.inCallTime=e}},{key:"getInCallTime",value:function(){return this.inCallTime}},{key:"setEndCallTime",value:function(e){this.endCallTime=e}},{key:"getEndCallTime",value:function(){return this.endCallTime}}]),e}()},70:function(e,t,n){"use strict";var i,r,a,o,o,s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(n){if("object"===s(t)&&void 0!==e)e.exports=n();else{r=[],i=n,void 0!==(a="function"==typeof i?i.apply(t,r):i)&&(e.exports=a)}}(function(){return function e(t,n,i){function r(s,c){if(!n[s]){if(!t[s]){var l="function"==typeof o&&o;if(!c&&l)return o(s,!0);if(a)return o(s,!0);var d=new Error("Cannot find module '"+s+"'");throw d.code="MODULE_NOT_FOUND",d}var u=n[s]={exports:{}};t[s][0].call(u.exports,function(e){var n=t[s][1][e];return r(n||e)},u,u.exports,e,t,n,i)}return n[s].exports}for(var a="function"==typeof o&&o,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(e,t,n){var i={};i.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},i.localCName=i.generateIdentifier(),i.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},i.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},i.matchPrefix=function(e,t){return i.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},i.parseCandidate=function(e){var t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");for(var n={foundation:t[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1]}return n},i.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),"candidate:"+t.join(" ")},i.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.numChannels=3===t.length?parseInt(t[2],10):1,n},i.writeRtpMap=function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},i.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),uri:t[1]}},i.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+" "+e.uri+"\r\n"},i.parseFmtp=function(e){for(var t,n={},i=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<i.length;r++)t=i[r].trim().split("="),n[t[0].trim()]=t[1];return n},i.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach(function(t){i.push(t+"="+e.parameters[t])}),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},i.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},i.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},i.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substr(t+1,i-t-1),n.value=e.substr(i+1)):n.attribute=e.substr(t+1),n},i.getMid=function(e){var t=i.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},i.getDtlsParameters=function(e,t){var n=i.splitLines(e);n=n.concat(i.splitLines(t));var r=n.filter(function(e){return 0===e.indexOf("a=fingerprint:")})[0].substr(14);return{role:"auto",fingerprints:[{algorithm:r.split(" ")[0].toLowerCase(),value:r.split(" ")[1]}]}},i.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},i.getIceParameters=function(e,t){var n=i.splitLines(e);return n=n.concat(i.splitLines(t)),{usernameFragment:n.filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:n.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},i.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},i.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=i.splitLines(e),r=n[0].split(" "),a=3;a<r.length;a++){var o=r[a],s=i.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){var c=i.parseRtpMap(s),l=i.matchPrefix(e,"a=fmtp:"+o+" ");switch(c.parameters=l.length?i.parseFmtp(l[0]):{},c.rtcpFeedback=i.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(i.parseRtcpFb),t.codecs.push(c),c.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(c.name.toUpperCase())}}}return i.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(i.parseExtmap(e))}),t},i.writeRtpDescription=function(e,t){var n="";n+="m="+e+" ",n+=t.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n+=i.writeRtpMap(e),n+=i.writeFmtp(e),n+=i.writeRtcpFb(e)});var r=0;return t.codecs.forEach(function(e){e.maxptime>r&&(r=e.maxptime)}),r>0&&(n+="a=maxptime:"+r+"\r\n"),n+="a=rtcp-mux\r\n",t.headerExtensions.forEach(function(e){n+=i.writeExtmap(e)}),n},i.parseRtpEncodingParameters=function(e){var t,n=[],r=i.parseRtpParameters(e),a=-1!==r.fecMechanisms.indexOf("RED"),o=-1!==r.fecMechanisms.indexOf("ULPFEC"),s=i.matchPrefix(e,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=s.length>0&&s[0].ssrc,l=i.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");return t.shift(),t.map(function(e){return parseInt(e,10)})});l.length>0&&l[0].length>1&&l[0][0]===c&&(t=l[0][1]),r.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var i={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{ssrc:t}};n.push(i),a&&(i=JSON.parse(JSON.stringify(i)),i.fec={ssrc:t,mechanism:o?"red+ulpfec":"red"},n.push(i))}}),0===n.length&&c&&n.push({ssrc:c});var d=i.matchPrefix(e,"b=");return d.length&&(0===d[0].indexOf("b=TIAS:")?d=parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")&&(d=parseInt(d[0].substr(5),10)),n.forEach(function(e){e.maxBitrate=d})),n},i.parseRtcpParameters=function(e){var t={},n=i.matchPrefix(e,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];n&&(t.cname=n.value,t.ssrc=n.ssrc);var r=i.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=r.length>0,t.compound=0===r.length;var a=i.matchPrefix(e,"a=rtcp-mux");return t.mux=a.length>0,t},i.parseMsid=function(e){var t,n=i.matchPrefix(e,"a=msid:");if(1===n.length)return t=n[0].substr(7).split(" "),{stream:t[0],track:t[1]};var r=i.matchPrefix(e,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return r.length>0?(t=r[0].value.split(" "),{stream:t[0],track:t[1]}):void 0},i.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},i.writeMediaSection=function(e,t,n,r){var a=i.writeRtpDescription(e.kind,t);if(a+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var o="msid:"+r.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+o,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),a},i.getDirection=function(e,t){for(var n=i.splitLines(e),r=0;r<n.length;r++)switch(n[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[r].substr(2)}return t?i.getDirection(t):"sendrecv"},i.getKind=function(e){return i.splitLines(e)[0].split(" ")[0].substr(2)},i.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.exports=i},{}],2:[function(e,t,n){!function(){var n=e("./utils"),i=n.log,r=n.browserDetails;t.exports.browserDetails=r,t.exports.extractVersion=n.extractVersion,t.exports.disableLog=n.disableLog;var a=e("./chrome/chrome_shim")||null,o=e("./edge/edge_shim")||null,s=e("./firefox/firefox_shim")||null,c=e("./safari/safari_shim")||null;switch(r.browser){case"chrome":if(!a||!a.shimPeerConnection)return void i("Chrome shim is not included in this adapter release.");i("adapter.js shimming chrome."),t.exports.browserShim=a,a.shimGetUserMedia(),a.shimMediaStream(),n.shimCreateObjectURL(),a.shimSourceObject(),a.shimPeerConnection(),a.shimOnTrack(),a.shimGetSendersWithDtmf();break;case"firefox":if(!s||!s.shimPeerConnection)return void i("Firefox shim is not included in this adapter release.");i("adapter.js shimming firefox."),t.exports.browserShim=s,s.shimGetUserMedia(),n.shimCreateObjectURL(),s.shimSourceObject(),s.shimPeerConnection(),s.shimOnTrack();break;case"edge":if(!o||!o.shimPeerConnection)return void i("MS edge shim is not included in this adapter release.");i("adapter.js shimming edge."),t.exports.browserShim=o,o.shimGetUserMedia(),n.shimCreateObjectURL(),o.shimPeerConnection(),o.shimReplaceTrack();break;case"safari":if(!c)return void i("Safari shim is not included in this adapter release.");i("adapter.js shimming safari."),t.exports.browserShim=c,c.shimOnAddStream(),c.shimGetUserMedia();break;default:i("Unsupported browser!")}}()},{"./chrome/chrome_shim":3,"./edge/edge_shim":5,"./firefox/firefox_shim":8,"./safari/safari_shim":10,"./utils":11}],3:[function(e,t,n){var i=e("../utils.js").log,r=e("../utils.js").browserDetails,a={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"!==("undefined"==typeof window?"undefined":s(window))||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){var t=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(n){var i=new Event("track");i.track=n.track,i.receiver={track:n.track},i.streams=[e.stream],t.dispatchEvent(i)}),e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}})},shimGetSendersWithDtmf:function(){if("object"===("undefined"==typeof window?"undefined":s(window))&&window.RTCPeerConnection&&!("getSenders"in RTCPeerConnection.prototype)&&"createDTMFSender"in RTCPeerConnection.prototype){RTCPeerConnection.prototype.getSenders=function(){return this._senders};var e=RTCPeerConnection.prototype.addStream,t=RTCPeerConnection.prototype.removeStream;RTCPeerConnection.prototype.addStream=function(t){var n=this;n._senders=n._senders||[],e.apply(n,[t]),t.getTracks().forEach(function(e){n._senders.push({track:e,get dtmf(){return void 0===this._dtmf&&("audio"===e.kind?this._dtmf=n.createDTMFSender(e):this._dtmf=null),this._dtmf}})})},RTCPeerConnection.prototype.removeStream=function(e){var n=this;n._senders=n._senders||[],t.apply(n,[e]),e.getTracks().forEach(function(e){var t=n._senders.find(function(t){return t.track===e});t&&n._senders.splice(n._senders.indexOf(t),1)})}}},shimSourceObject:function(){"object"===("undefined"==typeof window?"undefined":s(window))&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var t=this;if(this._srcObject=e,this.src&&URL.revokeObjectURL(this.src),!e)return void(this.src="");this.src=URL.createObjectURL(e),e.addEventListener("addtrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)}),e.addEventListener("removetrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)})}}))},shimPeerConnection:function(){if(window.RTCPeerConnection){var e=RTCPeerConnection;window.RTCPeerConnection=function(t,n){if(t&&t.iceServers){for(var i=[],r=0;r<t.iceServers.length;r++){var a=t.iceServers[r];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(console.warn("RTCIceServer.url is deprecated! Use urls instead."),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,i.push(a)):i.push(t.iceServers[r])}t.iceServers=i}return new e(t,n)},window.RTCPeerConnection.prototype=e.prototype,Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return e.generateCertificate}})}else window.RTCPeerConnection=function(e,t){return i("PeerConnection"),e&&e.iceTransportPolicy&&(e.iceTransports=e.iceTransportPolicy),new webkitRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}});var t=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(e,n,i){var r=this,a=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof arguments[0]))return t.apply(this,[]);var o=function(e){var t={};return e.result().forEach(function(e){var n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){n[t]=e.stat(t)}),t[n.id]=n}),t},s=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};if(arguments.length>=2){var c=function(e){a[1](s(o(e)))};return t.apply(this,[c,arguments[0]])}return new Promise(function(e,n){t.apply(r,[function(t){e(s(o(t)))},n])}).then(n,i)},r.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=arguments,n=this,i=new Promise(function(i,r){t.apply(n,[e[0],i,r])});return e.length<2?i:i.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),r.version<52&&["createOffer","createAnswer"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"===s(arguments[0])){var n=1===arguments.length?arguments[0]:void 0;return new Promise(function(i,r){t.apply(e,[i,r,n])})}return t.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var n=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}};t.exports={shimMediaStream:a.shimMediaStream,shimOnTrack:a.shimOnTrack,shimGetSendersWithDtmf:a.shimGetSendersWithDtmf,shimSourceObject:a.shimSourceObject,shimPeerConnection:a.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":11,"./getusermedia":4}],4:[function(e,t,n){var i=e("../utils.js").log,r=e("../utils.js").browserDetails;t.exports=function(){var e=function(e){if("object"!==(void 0===e?"undefined":s(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var i="object"===s(e[n])?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);var r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];var a={};"number"==typeof i.ideal?(a[r("min",n)]=i.ideal,t.optional.push(a),a={},a[r("max",n)]=i.ideal,t.optional.push(a)):(a[r("",n)]=i.ideal,t.optional.push(a))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",n)]=i.exact):["min","max"].forEach(function(e){void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,n)]=i[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},t=function(t,n){if(t=JSON.parse(JSON.stringify(t)),t&&t.audio&&(t.audio=e(t.audio)),t&&"object"===s(t.video)){var a=t.video.facingMode;a=a&&("object"===(void 0===a?"undefined":s(a))?a:{ideal:a});var o=r.version<61;if(a&&("user"===a.exact||"environment"===a.exact||"user"===a.ideal||"environment"===a.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode||o)){delete t.video.facingMode;var c;if("environment"===a.exact||"environment"===a.ideal?c=["back","rear"]:"user"!==a.exact&&"user"!==a.ideal||(c=["front"]),c)return navigator.mediaDevices.enumerateDevices().then(function(r){r=r.filter(function(e){return"videoinput"===e.kind});var o=r.find(function(e){return c.some(function(t){return-1!==e.label.toLowerCase().indexOf(t)})});return!o&&r.length&&-1!==c.indexOf("back")&&(o=r[r.length-1]),o&&(t.video.deviceId=a.exact?{exact:o.deviceId}:{ideal:o.deviceId}),t.video=e(t.video),i("chrome: "+JSON.stringify(t)),n(t)})}t.video=e(t.video)}return i("chrome: "+JSON.stringify(t)),n(t)},n=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},a=function(e,i,r){t(e,function(e){navigator.webkitGetUserMedia(e,i,function(e){r(n(e))})})};navigator.getUserMedia=a;var o=function(e){return new Promise(function(t,n){navigator.getUserMedia(e,t,n)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:o,enumerateDevices:function(){return new Promise(function(e){var t={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(n){e(n.map(function(e){return{label:e.label,kind:t[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),navigator.mediaDevices.getUserMedia){var c=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(e){return t(e,function(e){return c(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(n(e))})})}}else navigator.mediaDevices.getUserMedia=function(e){return o(e)};void 0===navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){i("Dummy mediaDevices.addEventListener called.")}),void 0===navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){i("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":11}],5:[function(e,t,n){var i=e("../utils").browserDetails,r=e("./rtcpeerconnection_shim");t.exports={shimGetUserMedia:e("./getusermedia"),shimPeerConnection:function(){if(window.RTCIceGatherer&&(window.RTCIceCandidate||(window.RTCIceCandidate=function(e){return e}),window.RTCSessionDescription||(window.RTCSessionDescription=function(e){return e}),i.version<15025)){var e=Object.getOwnPropertyDescriptor(MediaStreamTrack.prototype,"enabled");Object.defineProperty(MediaStreamTrack.prototype,"enabled",{set:function(t){e.set.call(this,t);var n=new Event("enabled");n.enabled=t,this.dispatchEvent(n)}})}window.RTCPeerConnection=r(i.version)},shimReplaceTrack:function(){!window.RTCRtpSender||"replaceTrack"in RTCRtpSender.prototype||(RTCRtpSender.prototype.replaceTrack=RTCRtpSender.prototype.setTrack)}}},{"../utils":11,"./getusermedia":6,"./rtcpeerconnection_shim":7}],6:[function(e,t,n){t.exports=function(){var e=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}},t=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(n){return t(n).catch(function(t){return Promise.reject(e(t))})}}},{}],7:[function(e,t,n){function i(e){var t=e.filter(function(e){return"audio"===e.kind}),n=e.filter(function(e){return"video"===e.kind});for(e=[];t.length||n.length;)t.length&&e.push(t.shift()),n.length&&e.push(n.shift());return e}function r(e,t){var n=!1;return e=JSON.parse(JSON.stringify(e)),e.filter(function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var r="string"==typeof i;return r&&(i=[i]),i=i.filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||n?0===e.indexOf("stun:")&&t>=14393:(n=!0,!0)}),delete e.url,e.urls=r?i[0]:i,!!i.length}return!1})}var a=e("sdp");t.exports=function(e){var t=function(t){var n=this,i=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){n[e]=i[e].bind(i)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onicegatheringstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.canTrickleIceCandidates=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return n.localStreams},this.getRemoteStreams=function(){return n.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},t&&t.iceTransportPolicy)switch(t.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=t.iceTransportPolicy}this.usingBundle=t&&"max-bundle"===t.bundlePolicy,t&&t.iceServers&&(this.iceOptions.iceServers=r(t.iceServers,e)),this._config=t||{},this.transceivers=[],this._localIceCandidatesBuffer=[]};return t.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this.dispatchEvent(e),null!==this.onicegatheringstatechange&&this.onicegatheringstatechange(e)},t.prototype._emitBufferedCandidates=function(){var e=this,t=a.splitSections(e.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(n){if(n.candidate&&0!==Object.keys(n.candidate).length)t[n.candidate.sdpMLineIndex+1]+="a="+n.candidate.candidate+"\r\n";else for(var i=1;i<t.length;i++)-1===t[i].indexOf("\r\na=end-of-candidates\r\n")&&(t[i]+="a=end-of-candidates\r\n");if(e.localDescription.sdp=t.join(""),e.dispatchEvent(n),null!==e.onicecandidate&&e.onicecandidate(n),!n.candidate&&"complete"!==e.iceGatheringState){e.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state})&&"complete"!==e.iceGatheringStateChange&&(e.iceGatheringState="complete",e._emitGatheringStateChange())}}),this._localIceCandidatesBuffer=[]},t.prototype.getConfiguration=function(){return this._config},t.prototype.addStream=function(t){if(e>=15025)this.localStreams.push(t);else{var n=t.clone();t.getTracks().forEach(function(e,t){var i=n.getTracks()[t];e.addEventListener("enabled",function(e){i.enabled=e.enabled})}),this.localStreams.push(n)}this._maybeFireNegotiationNeeded()},t.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);t>-1&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())},t.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},t.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},t.prototype._getCommonCapabilities=function(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},r=function(e,t,n,r){var a=i(e.parameters.apt,n),o=i(t.parameters.apt,r);return a&&o&&a.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach(function(i){for(var a=0;a<t.codecs.length;a++){var o=t.codecs[a];if(i.name.toLowerCase()===o.name.toLowerCase()&&i.clockRate===o.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&o.parameters.apt&&!r(i,o,e.codecs,t.codecs))continue;o=JSON.parse(JSON.stringify(o)),o.numChannels=Math.min(i.numChannels,o.numChannels),n.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter(function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var i=0;i<t.headerExtensions.length;i++){var r=t.headerExtensions[i];if(e.uri===r.uri){n.headerExtensions.push(r);break}}}),n},t.prototype._createIceAndDtlsTransports=function(e,t){var n=this,i=new RTCIceGatherer(n.iceOptions),r=new RTCIceTransport(i);i.onlocalcandidate=function(o){var s=new Event("icecandidate");s.candidate={sdpMid:e,sdpMLineIndex:t};var c=o.candidate,l=!c||0===Object.keys(c).length;l?void 0===i.state&&(i.state="completed"):(c.component="RTCP"===r.component?2:1,s.candidate.candidate=a.writeCandidate(c));var d=a.splitSections(n.localDescription.sdp);d[s.candidate.sdpMLineIndex+1]+=l?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",n.localDescription.sdp=d.join("");var u=n._pendingOffer?n._pendingOffer:n.transceivers,p=u.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});switch(n.iceGatheringState){case"new":l||n._localIceCandidatesBuffer.push(s),l&&p&&n._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":n._emitBufferedCandidates(),l||(n.dispatchEvent(s),null!==n.onicecandidate&&n.onicecandidate(s)),p&&(n.dispatchEvent(new Event("icecandidate")),null!==n.onicecandidate&&n.onicecandidate(new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange())}},r.onicestatechange=function(){n._updateConnectionState()};var o=new RTCDtlsTransport(r);return o.ondtlsstatechange=function(){n._updateConnectionState()},o.onerror=function(){o.state="failed",n._updateConnectionState()},{iceGatherer:i,iceTransport:r,dtlsTransport:o}},t.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlssttatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},t.prototype._transceive=function(t,n,i){var r=this._getCommonCapabilities(t.localCapabilities,t.remoteCapabilities);n&&t.rtpSender&&(r.encodings=t.sendEncodingParameters,r.rtcp={cname:a.localCName,compound:t.rtcpParameters.compound},t.recvEncodingParameters.length&&(r.rtcp.ssrc=t.recvEncodingParameters[0].ssrc),t.rtpSender.send(r)),i&&t.rtpReceiver&&("video"===t.kind&&t.recvEncodingParameters&&e<15019&&t.recvEncodingParameters.forEach(function(e){delete e.rtx}),r.encodings=t.recvEncodingParameters,r.rtcp={cname:t.rtcpParameters.cname,compound:t.rtcpParameters.compound},t.sendEncodingParameters.length&&(r.rtcp.ssrc=t.sendEncodingParameters[0].ssrc),t.rtpReceiver.receive(r))},t.prototype.setLocalDescription=function(e){var t,n,i=this;if("offer"===e.type)this._pendingOffer&&(t=a.splitSections(e.sdp),n=t.shift(),t.forEach(function(e,t){var n=a.parseRtpParameters(e);i._pendingOffer[t].localCapabilities=n}),this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===e.type){t=a.splitSections(i.remoteDescription.sdp),n=t.shift();var r=a.matchPrefix(n,"a=ice-lite").length>0;t.forEach(function(e,t){var o=i.transceivers[t],s=o.iceGatherer,c=o.iceTransport,l=o.dtlsTransport,d=o.localCapabilities,u=o.remoteCapabilities;if(!a.isRejected(e)&&!o.isDatachannel){var p=a.getIceParameters(e,n),h=a.getDtlsParameters(e,n);r&&(h.role="server"),i.usingBundle&&0!==t||(c.start(s,p,r?"controlling":"controlled"),l.start(h));var f=i._getCommonCapabilities(d,u);i._transceive(o,f.codecs.length>0,!1)}})}switch(this.localDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}var o=arguments.length>1&&"function"==typeof arguments[1];if(o){var s=arguments[1];window.setTimeout(function(){s(),"new"===i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),i._emitBufferedCandidates()},0)}var c=Promise.resolve();return c.then(function(){o||("new"===i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),window.setTimeout(i._emitBufferedCandidates.bind(i),500))}),c},t.prototype.setRemoteDescription=function(t){var n=this,i={},r=[],o=a.splitSections(t.sdp),s=o.shift(),c=a.matchPrefix(s,"a=ice-lite").length>0,l=a.matchPrefix(s,"a=group:BUNDLE ").length>0,d=a.matchPrefix(s,"a=ice-options:")[0];switch(this.canTrickleIceCandidates=!!d&&d.substr(14).split(" ").indexOf("trickle")>=0,o.forEach(function(o,d){var u=a.splitLines(o),p=a.getKind(o),h=a.isRejected(o),f=u[0].substr(2).split(" ")[2],g=a.getDirection(o,s),m=a.parseMsid(o),v=a.getMid(o)||a.generateIdentifier();if("application"===p&&"DTLS/SCTP"===f)return void(n.transceivers[d]={mid:v,isDatachannel:!0});var y,C,b,w,S,k,T,R,P,E,_,L,A=a.parseRtpParameters(o);h||(_=a.getIceParameters(o,s),L=a.getDtlsParameters(o,s),L.role="client"),R=a.parseRtpEncodingParameters(o);var M=a.parseRtcpParameters(o),O=a.matchPrefix(o,"a=end-of-candidates",s).length>0,D=a.matchPrefix(o,"a=candidate:").map(function(e){return a.parseCandidate(e)}).filter(function(e){return"1"===e.component});if("offer"!==t.type||h)"answer"!==t.type||h||(l&&d>0&&(n._disposeIceAndDtlsTransports(d),n.transceivers[d].iceGatherer=n.transceivers[0].iceGatherer,n.transceivers[d].iceTransport=n.transceivers[0].iceTransport,n.transceivers[d].dtlsTransport=n.transceivers[0].dtlsTransport,n.transceivers[d].rtpSender&&n.transceivers[d].rtpSender.setTransport(n.transceivers[0].dtlsTransport),n.transceivers[d].rtpReceiver&&n.transceivers[d].rtpReceiver.setTransport(n.transceivers[0].dtlsTransport)),y=n.transceivers[d],C=y.iceGatherer,b=y.iceTransport,w=y.dtlsTransport,S=y.rtpSender,k=y.rtpReceiver,T=y.sendEncodingParameters,P=y.localCapabilities,n.transceivers[d].recvEncodingParameters=R,n.transceivers[d].remoteCapabilities=A,n.transceivers[d].rtcpParameters=M,(c||O)&&D.length&&b.setRemoteCandidates(D),l&&0!==d||(b.start(C,_,"controlling"),w.start(L)),n._transceive(y,"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!k||"sendrecv"!==g&&"sendonly"!==g?delete y.rtpReceiver:(E=k.track,m?(i[m.stream]||(i[m.stream]=new MediaStream),i[m.stream].addTrack(E),r.push([E,k,i[m.stream]])):(i.default||(i.default=new MediaStream),i.default.addTrack(E),r.push([E,k,i.default]))));else{var x=l&&d>0?{iceGatherer:n.transceivers[0].iceGatherer,iceTransport:n.transceivers[0].iceTransport,dtlsTransport:n.transceivers[0].dtlsTransport}:n._createIceAndDtlsTransports(v,d);!O||l&&0!==d||x.iceTransport.setRemoteCandidates(D),P=RTCRtpReceiver.getCapabilities(p),e<15019&&(P.codecs=P.codecs.filter(function(e){return"rtx"!==e.name})),T=[{ssrc:1001*(2*d+2)}],"sendrecv"!==g&&"sendonly"!==g||(k=new RTCRtpReceiver(x.dtlsTransport,p),E=k.track,m?(i[m.stream]||(i[m.stream]=new MediaStream,Object.defineProperty(i[m.stream],"id",{get:function(){return m.stream}})),Object.defineProperty(E,"id",{get:function(){return m.track}}),i[m.stream].addTrack(E),r.push([E,k,i[m.stream]])):(i.default||(i.default=new MediaStream),i.default.addTrack(E),r.push([E,k,i.default]))),n.transceivers[d]={iceGatherer:x.iceGatherer,iceTransport:x.iceTransport,dtlsTransport:x.dtlsTransport,localCapabilities:P,remoteCapabilities:A,rtpSender:S,rtpReceiver:k,kind:p,mid:v,rtcpParameters:M,sendEncodingParameters:T,recvEncodingParameters:R},n._transceive(n.transceivers[d],!1,"sendrecv"===g||"sendonly"===g)}}),this.usingBundle=l,this.remoteDescription={type:t.type,sdp:t.sdp},t.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+t.type+'"')}return Object.keys(i).forEach(function(e){var t=i[e];if(t.getTracks().length){n.remoteStreams.push(t);var a=new Event("addstream");a.stream=t,n.dispatchEvent(a),null!==n.onaddstream&&window.setTimeout(function(){n.onaddstream(a)},0),r.forEach(function(e){var i=e[0],r=e[1];if(t.id===e[2].id){var a=new Event("track");a.track=i,a.receiver=r,a.streams=[t],n.dispatchEvent(a),null!==n.ontrack&&window.setTimeout(function(){n.ontrack(a)},0)}})}}),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},t.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._updateSignalingState("closed")},t.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this.dispatchEvent(t),null!==this.onsignalingstatechange&&this.onsignalingstatechange(t)},t.prototype._maybeFireNegotiationNeeded=function(){var e=new Event("negotiationneeded");this.dispatchEvent(e),null!==this.onnegotiationneeded&&this.onnegotiationneeded(e)},t.prototype._updateConnectionState=function(){var e,t=this,n={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach(function(e){n[e.iceTransport.state]++,n[e.dtlsTransport.state]++}),n.connected+=n.completed,e="new",n.failed>0?e="failed":n.connecting>0||n.checking>0?e="connecting":n.disconnected>0?e="disconnected":n.new>0?e="new":(n.connected>0||n.completed>0)&&(e="connected"),e!==t.iceConnectionState){t.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this.dispatchEvent(i),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(i)}},t.prototype.createOffer=function(){var t=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var n;1===arguments.length&&"function"!=typeof arguments[0]?n=arguments[0]:3===arguments.length&&(n=arguments[2]);var r=[],o=0,s=0;if(this.localStreams.length&&(o=this.localStreams.reduce(function(e,t){return e+t.getAudioTracks().length},0),s=this.localStreams.reduce(function(e,t){return e+t.getVideoTracks().length},0)),n){if(n.mandatory||n.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==n.offerToReceiveAudio&&(o=!0===n.offerToReceiveAudio?1:!1===n.offerToReceiveAudio?0:n.offerToReceiveAudio),void 0!==n.offerToReceiveVideo&&(s=!0===n.offerToReceiveVideo?1:!1===n.offerToReceiveVideo?0:n.offerToReceiveVideo)}for(this.localStreams.forEach(function(e){e.getTracks().forEach(function(t){r.push({kind:t.kind,track:t,stream:e,wantReceive:"audio"===t.kind?o>0:s>0}),"audio"===t.kind?o--:"video"===t.kind&&s--})});o>0||s>0;)o>0&&(r.push({kind:"audio",wantReceive:!0}),o--),s>0&&(r.push({kind:"video",wantReceive:!0}),s--);r=i(r);var c=a.writeSessionBoilerplate(),l=[];r.forEach(function(n,i){var r=n.track,o=n.kind,s=a.generateIdentifier(),c=t.usingBundle&&i>0?{iceGatherer:l[0].iceGatherer,iceTransport:l[0].iceTransport,dtlsTransport:l[0].dtlsTransport}:t._createIceAndDtlsTransports(s,i),d=RTCRtpSender.getCapabilities(o);e<15019&&(d.codecs=d.codecs.filter(function(e){return"rtx"!==e.name})),d.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1")});var u,p,h=[{ssrc:1001*(2*i+1)}];r&&(e>=15019&&"video"===o&&(h[0].rtx={ssrc:1001*(2*i+1)+1}),u=new RTCRtpSender(r,c.dtlsTransport)),n.wantReceive&&(p=new RTCRtpReceiver(c.dtlsTransport,o)),l[i]={iceGatherer:c.iceGatherer,iceTransport:c.iceTransport,dtlsTransport:c.dtlsTransport,localCapabilities:d,remoteCapabilities:null,rtpSender:u,rtpReceiver:p,kind:o,mid:s,sendEncodingParameters:h,recvEncodingParameters:null}}),"max-compat"!==this._config.bundlePolicy&&(c+="a=group:BUNDLE "+l.map(function(e){return e.mid}).join(" ")+"\r\n"),c+="a=ice-options:trickle\r\n",r.forEach(function(e,t){var n=l[t];c+=a.writeMediaSection(n,n.localCapabilities,"offer",e.stream),c+="a=rtcp-rsize\r\n"}),this._pendingOffer=l;var d=new RTCSessionDescription({type:"offer",sdp:c});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,d),Promise.resolve(d)},t.prototype.createAnswer=function(){var t=this,n=a.writeSessionBoilerplate();this.usingBundle&&(n+="a=group:BUNDLE "+this.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),this.transceivers.forEach(function(i,r){if(i.isDatachannel)return void(n+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+i.mid+"\r\n");if(t.localStreams.length>0&&t.localStreams[0].getTracks().length>=r){var o;"audio"===i.kind?o=t.localStreams[0].getAudioTracks()[0]:"video"===i.kind&&(o=t.localStreams[0].getVideoTracks()[0]),o&&(e>=15019&&"video"===i.kind&&(i.sendEncodingParameters[0].rtx={ssrc:1001*(2*r+2)+1}),i.rtpSender=new RTCRtpSender(o,i.dtlsTransport))}var s=t._getCommonCapabilities(i.localCapabilities,i.remoteCapabilities);!s.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&i.sendEncodingParameters[0].rtx&&delete i.sendEncodingParameters[0].rtx,n+=a.writeMediaSection(i,s,"answer",t.localStreams[0]),i.rtcpParameters&&i.rtcpParameters.reducedSize&&(n+="a=rtcp-rsize\r\n")});var i=new RTCSessionDescription({type:"answer",sdp:n});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,i),Promise.resolve(i)},t.prototype.addIceCandidate=function(e){if(e){var t=e.sdpMLineIndex;if(e.sdpMid)for(var n=0;n<this.transceivers.length;n++)if(this.transceivers[n].mid===e.sdpMid){t=n;break}var i=this.transceivers[t];if(i){var r=Object.keys(e.candidate).length>0?a.parseCandidate(e.candidate):{};if("tcp"===r.protocol&&(0===r.port||9===r.port))return Promise.resolve();if("1"!==r.component)return Promise.resolve();i.iceTransport.addRemoteCandidate(r);var o=a.splitSections(this.remoteDescription.sdp);o[t+1]+=(r.type?e.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=o.join("")}}else for(var s=0;s<this.transceivers.length;s++)if(this.transceivers[s].iceTransport.addRemoteCandidate({}),this.usingBundle)return Promise.resolve();return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},t.prototype.getStats=function(){var e=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(n){t[n]&&e.push(t[n].getStats())})});var t=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1],n=function(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};return new Promise(function(i){var r=new Map;Promise.all(e).then(function(e){e.forEach(function(e){Object.keys(e).forEach(function(t){e[t].type=n(e[t]),r.set(t,e[t])})}),t&&window.setTimeout(t,0,r),i(r)})})},t}},{sdp:1}],8:[function(e,t,n){var i=e("../utils").browserDetails,r={shimOnTrack:function(){"object"!==("undefined"==typeof window?"undefined":s(window))||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"===("undefined"==typeof window?"undefined":s(window))&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(){if("object"===("undefined"==typeof window?"undefined":s(window))&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){if(i.version<38&&e&&e.iceServers){for(var n=[],r=0;r<e.iceServers.length;r++){var a=e.iceServers[r];if(a.hasOwnProperty("urls"))for(var o=0;o<a.urls.length;o++){var s={url:a.urls[o]};0===a.urls[o].indexOf("turn")&&(s.username=a.username,s.credential=a.credential),n.push(s)}else n.push(e.iceServers[r])}e.iceServers=n}return new mozRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var t=function(e){var t=new Map;return Object.keys(e).forEach(function(n){t.set(n,e[n]),t[n]=e[n]}),t},n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(e,a,o){return r.apply(this,[e||null]).then(function(e){if(i.version<48&&(e=t(e)),i.version<53&&!a)try{e.forEach(function(e){e.type=n[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach(function(t,i){e.set(i,Object.assign({},t,{type:n[t.type]||t.type}))})}return e}).then(a,o)}}}};t.exports={shimOnTrack:r.shimOnTrack,shimSourceObject:r.shimSourceObject,shimPeerConnection:r.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":11,"./getusermedia":9}],9:[function(e,t,n){var i=e("../utils").log,r=e("../utils").browserDetails;t.exports=function(){var e=function(e){return{name:{NotSupportedError:"TypeError",SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},t=function(t,n,a){var o=function(e){if("object"!==(void 0===e?"undefined":s(e))||e.require)return e;var t=[];return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var i=e[n]="object"===s(e[n])?e[n]:{ideal:e[n]};if(void 0===i.min&&void 0===i.max&&void 0===i.exact||t.push(n),void 0!==i.exact&&("number"==typeof i.exact?i.min=i.max=i.exact:e[n]=i.exact,delete i.exact),void 0!==i.ideal){e.advanced=e.advanced||[];var r={};"number"==typeof i.ideal?r[n]={min:i.ideal,max:i.ideal}:r[n]=i.ideal,e.advanced.push(r),delete i.ideal,Object.keys(i).length||delete e[n]}}}),t.length&&(e.require=t),e};return t=JSON.parse(JSON.stringify(t)),r.version<38&&(i("spec: "+JSON.stringify(t)),t.audio&&(t.audio=o(t.audio)),t.video&&(t.video=o(t.video)),i("ff37: "+JSON.stringify(t))),navigator.mozGetUserMedia(t,n,function(t){a(e(t))})},n=function(e){return new Promise(function(n,i){t(e,n,i)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:n,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},r.version<41){var a=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return a().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(r.version<49){var o=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(t){return o(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return e},function(t){return Promise.reject(e(t))})}}navigator.getUserMedia=function(e,n,i){if(r.version<44)return t(e,n,i);console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),navigator.mediaDevices.getUserMedia(e).then(n,i)}}},{"../utils":11}],10:[function(e,t,n){var i={shimOnAddStream:function(){"object"!==("undefined"==typeof window?"undefined":s(window))||!window.RTCPeerConnection||"onaddstream"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){var t=e.streams[0];if(this._streams||(this._streams=[]),!(this._streams.indexOf(t)>=0)){this._streams.push(t);var n=new Event("addstream");n.stream=e.streams[0],this.dispatchEvent(n)}}.bind(this))}})},shimGetUserMedia:function(){navigator.getUserMedia||(navigator.webkitGetUserMedia?navigator.getUserMedia=navigator.webkitGetUserMedia.bind(navigator):navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(navigator.getUserMedia=function(e,t,n){navigator.mediaDevices.getUserMedia(e).then(t,n)}.bind(navigator)))}};t.exports={shimOnAddStream:i.shimOnAddStream,shimGetUserMedia:i.shimGetUserMedia}},{}],11:[function(e,t,n){var i=!0,r={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":s(e))+". Please use a boolean."):(i=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"===("undefined"==typeof window?"undefined":s(window))){if(i)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(e,t,n){var i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)},detectBrowser:function(){var e={};if(e.browser=null,e.version=null,"undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=this.extractVersion(navigator.userAgent,/Firefox\/(\d+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1)}else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e.browser="edge",e.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!navigator.mediaDevices||!navigator.userAgent.match(/AppleWebKit\/(\d+)\./))return e.browser="Not a supported browser.",e;e.browser="safari",e.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1)}return e},shimCreateObjectURL:function(){if("object"===("undefined"==typeof window?"undefined":s(window))&&window.HTMLMediaElement&&"srcObject"in window.HTMLMediaElement.prototype){var e=URL.createObjectURL.bind(URL),t=URL.revokeObjectURL.bind(URL),n=new Map,i=0;URL.createObjectURL&&(URL.createObjectURL=function(t){if("getTracks"in t){var r="polyblob:"+ ++i;return n.set(r,t),console.log("URL.createObjectURL(stream) is deprecated! Use elem.srcObject = stream instead!"),r}return e(t)}),URL.revokeObjectURL=function(e){t(e),n.delete(e)};var r=Object.getOwnPropertyDescriptor(window.HTMLMediaElement.prototype,"src");Object.defineProperty(window.HTMLMediaElement.prototype,"src",{get:function(){return r.get.apply(this)},set:function(e){return this.srcObject=n.get(e)||null,r.set.apply(this,[e])}});var a=HTMLMediaElement.prototype.setAttribute;HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=n.get(arguments[1])||null),a.apply(this,arguments)}}}};t.exports={log:r.log,disableLog:r.disableLog,browserDetails:r.detectBrowser(),extractVersion:r.extractVersion,shimCreateObjectURL:r.shimCreateObjectURL,detectBrowser:r.detectBrowser.bind(r)}},{}]},{},[2])(2)})},71:function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.MediaProbe=function(){function e(){i(this,e)}return r(e,[{key:"onLocalStreamReady",value:function(e){}},{key:"onRemoteStreamReady",value:function(e){}},{key:"onLocalVideoFPS",value:function(e,t,n,i,r){}},{key:"onRemoteVideoFPS",value:function(e,t,n,i,r){}},{key:"onFrameRateWarning",value:function(e,t,n,i){}},{key:"onFrameRateRecovering",value:function(e,t,n,i){}},{key:"onVideoClose",value:function(){}},{key:"onVideoOpen",value:function(){}}]),e}()},72:function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.MediaServiceWorker=void 0;var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(117);t.MediaServiceWorker=function(e){function t(e,n){i(this,t);var a=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));a.worker=e,a.canvas=null,a.timerList=[],a.probes=null,a.frameWarning=!1,a.remoteMaxFrameRate=-1,a.remoteMinFrameRate=120,a.recorderMap=null,a.capturedUri=null,a._autoCaptureTimer=0,a._localCalculateStats=null,a._remoteCalculateStats=null,void 0!==n&&(a.canvas=document.getElementById(n));var o=a;return e.videoCloseHandler=function(){Logger.d("CubeMediaController","Video closed");for(var e=0;e<o.timerList.length;++e){var t=o.timerList[e];clearInterval(t)}if(a.timerList.splice(0,o.timerList.length),null!=o.probes&&a.frameWarning)for(var n=0;n<a.probes.length;++n){var i=a.probes[n];i.onFrameRateRecovering(a,0,0,o.remoteMaxFrameRate)}a.remoteMaxFrameRate=-1,a.remoteMinFrameRate=120,a.frameWarning=!1,a.isLocalRecording()&&a.stopLocalRecording(null)},e.localVideoReady=function(e,t){a._localVideoReady(e,t.videoEnabled)},e.remoteVideoReady=function(e,t){e.volume=1,a._remoteVideoReady(e,t.videoEnabled)},a}return a(t,e),o(t,[{key:"addMediaProbe",value:function(e){null==this.probes?this.probes=[e]:this.probes.push(e)}},{key:"removeMediaProbe",value:function(e){if(null==this.probes)return!1;var t=this.probes.indexOf(e);return t>=0&&(this.probes.splice(t,1),!0)}},{key:"closeVoice",value:function(){return null!=this.worker.localStream&&this.worker.localStream.getAudioTracks().length>0&&(this.worker.localStream.getAudioTracks()[0].enabled=!1,!0)}},{key:"closeVideo",value:function(){return null!=this.worker.localStream&&this.worker.localStream.getVideoTracks().length>0&&(this.worker.localStream.getVideoTracks()[0].enabled=!1,this.worker.consult("video","close"),!0)}},{key:"openVoice",value:function(){return null!=this.worker.localStream&&this.worker.localStream.getAudioTracks().length>0&&(this.worker.localStream.getAudioTracks()[0].enabled=!0,!0)}},{key:"openVideo",value:function(){return null!=this.worker.localStream&&this.worker.localStream.getVideoTracks().length>0&&(this.worker.localStream.getVideoTracks()[0].enabled=!0,this.worker.consult("video","open"),!0)}},{key:"isVoiceEnabled",value:function(){return!(null!=this.worker.localStream&&this.worker.localStream.getAudioTracks().length>0)||this.worker.localStream.getAudioTracks()[0].enabled}},{key:"isVideoEnabled",value:function(){return!(null!=this.worker.localStream&&this.worker.localStream.getVideoTracks().length>0)||this.worker.localStream.getVideoTracks()[0].enabled}},{key:"setVolume",value:function(e){null!=this.worker.remoteVideo&&(this.worker.remoteVideo.volume=e/100)}},{key:"getVolume",value:function(){return parseInt(Math.round(100*this.worker.remoteVideo.volume))}},{key:"mute",value:function(){this.closeVoice()}},{key:"getLocalVideoSize",value:function(){var e=this.worker.localVideo;return{width:e.videoWidth,height:e.videoHeight}}},{key:"getRemoteVideoSize",value:function(){var e=this.worker.remoteVideo;return{width:e.videoWidth,height:e.videoHeight}}},{key:"getCapturedCameraImage",value:function(e){return null==this.capturedUri?null:this.capturedUri+e+"/cube_captured_camera.jpg"}},{key:"capture",value:function(e,t){var n=this.canvas,i=parseInt(this.worker.localVideo.videoWidth),r=parseInt(this.worker.localVideo.videoHeight);n.setAttribute("width",i),n.setAttribute("height",r),n.style.width=i+"px",n.style.height=r+"px";var a=n.getContext("2d");if(this.worker.localStream){a.drawImage(this.worker.localVideo,0,0);var o=n.toDataURL("image/png"),s=this;Ajax.newRequest(_CUBE_SERVICE+"/conference/capture?name="+e).method("POST").content(o).send(function(e){if(200==e.getStatus()){var n=JSON.parse(e.getData());s.capturedUri=n.url,void 0!==t&&null!=t&&t.call(null,n)}})}}},{key:"_startAutoCapture",value:function(e,t){if(null!=this.canvas){var n=this;return n._autoCaptureTimer>0||(n.capture(e,t),n._autoCaptureTimer=setInterval(function(){n.capture(e,t)},9e3),!0)}return!1}},{key:"_stopAutoCapture",value:function(){this._autoCaptureTimer>0&&(clearInterval(this._autoCaptureTimer),this._autoCaptureTimer=0)}},{key:"_localVideoReady",value:function(e,t){if(null!=this.probes){for(var n=0;n<this.probes.length;++n){this.probes[n].onLocalStreamReady(this)}if(t){var i=this,r=0;this._localCalculateStats=this._calculateStats(e,function(e,t,n){if(!i.worker.videoEnabled)return void i._stopCalculate();if(!(++r<5)){r=0;for(var a=0;a<i.probes.length;++a){i.probes[a].onLocalVideoFPS(i,e.videoWidth,e.videoHeight,t,n)}}})}}}},{key:"changeVideoElement",value:function(e,t){e.volume=0,t.volume=this.getVolume()/100,e.src=this.worker.localVideo.src,t.src=this.worker.remoteVideo.src,utils.isIE||utils.isSafari?(window.attachMediaStream(this.worker.localVideo,null),window.attachMediaStream(this.worker.remoteVideo,null)):(this.worker.localVideo.src="",this.worker.remoteVideo.src=""),this.worker.localVideo=e,this.worker.remoteVideo=t,null!=this._localCalculateStats&&this._localCalculateStats.changeElement(e),null!=this._remoteCalculateStats&&this._remoteCalculateStats.changeElement(t)}},{key:"_remoteVideoReady",value:function(e,t){if(null!=this.probes){for(var n=0;n<this.probes.length;++n){this.probes[n].onRemoteStreamReady(this)}if(t){var i=this,r=0;this._remoteCalculateStats=this._calculateStats(e,function(e,t,n){if(!i.worker.videoEnabled)return void i._stopCalculate();if(0==e.videoWidth||0==e.videoHeight)return void i._stopCalculate();if(++r>=5){for(var a=0;a<i.probes.length;++a){var o=i.probes[a];o.onRemoteVideoFPS(i,e.videoWidth,e.videoHeight,t,n)}r=0}if(i.remoteMaxFrameRate<t&&(i.remoteMaxFrameRate=t),i.remoteMinFrameRate>t&&(i.remoteMinFrameRate=t),t<=.4*i.remoteMaxFrameRate&&t<=.4*n){i.frameWarning=!0;for(var a=0;a<i.probes.length;++a){var o=i.probes[a];o.onFrameRateWarning(i,t,n,i.remoteMaxFrameRate)}}else if(i.frameWarning){for(var a=0;a<i.probes.length;++a){var o=i.probes[a];o.onFrameRateRecovering(i,t,n,i.remoteMaxFrameRate)}i.frameWarning=!1,t>=6&&(i.remoteMaxFrameRate=-1)}})}}}},{key:"_stopCalculate",value:function(){if(0!=this.timerList.length){for(var e=0;e<this.timerList.length;++e){var t=this.timerList[e];clearInterval(t)}this.timerList.splice(0,this.timerList.length)}}},{key:"_calculateStats",value:function(e,t){var n=(new Date).getTime(),i=0,r=n,a=n,o=0;return o=window.setInterval(function(){if(void 0===e.webkitDecodedFrameCount&&void 0===e.mozPaintedFrames)return Logger.d("MediaController","Video FPS calcs not supported"),void clearInterval(o);var n=(new Date).getTime(),s=(n-r)/1e3,c=(n-a)/1e3;r=n;var l=0,d=0;void 0!==e.mozPaintedFrames?(l=(e.mozPaintedFrames-i)/s,d=e.mozPaintedFrames/c,i=e.mozPaintedFrames):(l=(e.webkitDecodedFrameCount-i)/s,d=e.webkitDecodedFrameCount/c,i=e.webkitDecodedFrameCount),(l<0||l>60)&&(l=0),t.call(null,e,l.toFixed(),d.toFixed()),(0==parseInt(e.width)&&0==d||null==e.src)&&clearInterval(o)},1e3),this.timerList.push(o),{changeElement:function(t){e=t}}}},{key:"queryRecordArchives",value:function(e,t,n,i){if("undefined"!==i&&i){var r="p"+Date.now();window._cube_cross.addCallback(r,t,n);var a=window._cube_cross.host+"/archive/list.js?name="+e+"&m=window._cube_cross.queryRecordArchives&sn="+r,o=document.createElement("script");return o.setAttribute("id",r),o.setAttribute("name",e.toString()),o.setAttribute("src",a),o.setAttribute("type","text/javascript"),o.onerror=function(){void 0!==n&&n.call(null,e),document.body.removeChild(o)},void document.body.appendChild(o)}utils.requestGet("archive/list?name="+e,function(n){t.call(null,e,n)},function(t){void 0!==n&&n.call(null,e)})}},{key:"loadArchive",value:function(e,t,n,i){var r=n;"string"==typeof n&&(r=document.getElementById(n)),r.src=void 0!==i&&i?window._cube_cross.host+"/archive/read?name="+e+"&file="+t:"archive/read?name="+e+"&file="+t}},{key:"hasLocalRecorded",value:function(){return null!=this.recorderMap&&this.recorderMap.containsKey("LocalVideo")}},{key:"isLocalRecording",value:function(){if(null==this.recorderMap)return!1;var e=this.recorderMap.get("LocalVideo");return null!=e&&e.recording}},{key:"startLocalRecording",value:function(e){return null!=this.worker.localStream&&this.startRecording("LocalVideo",this.worker.localStream,e)}},{key:"stopLocalRecording",value:function(e){return this.stopRecording("LocalVideo",e)}},{key:"replayLocalRecording",value:function(e,t){return this.replayRecording("LocalVideo",e,t)}},{key:"getLocalRecorder",value:function(){return this.getRecorder("LocalVideo")}},{key:"hasRemoteRecorded",value:function(){return null!=this.recorderMap&&this.recorderMap.containsKey("RemoteVideo")}},{key:"isRemoteRecording",value:function(){if(null==this.recorderMap)return!1;var e=this.recorderMap.get("RemoteVideo");return null!=e&&e.recording}},{key:"startRemoteRecording",value:function(e){return null!=this.worker.remoteStream&&this.startRecording("RemoteVideo",this.worker.remoteStream,e)}},{key:"stopRemoteRecording",value:function(e){return this.stopRecording("RemoteVideo",e)}},{key:"getRemoteRecorder",value:function(){return this.getRecorder("RemoteVideo")}},{key:"startRecording",value:function(e,t,n){var i=null,r=null;"string"==typeof t?i=document.getElementById(t):void 0!==t.tagName?i=t:r=t,null==this.recorderMap&&(this.recorderMap=new HashMap);var a=null;return a=void 0!==n&&null!=n?new CubeAdvancedRecorder(i,n):new CubeRecorder(i),this.recorderMap.put(e,a),a.startRecording(r)}},{key:"stopRecording",value:function(e,t){if(null==this.recorderMap)return!1;var n=this.recorderMap.get(e);if(null==n)return!1;var i=0;return n.stopRecording(function(e){null!=t&&(i>0&&clearTimeout(i),i=setTimeout(function(){clearTimeout(i),t.call(null,n)},1e3))})}},{key:"replayRecording",value:function(e,t,n){if(null==this.recorderMap)return!1;var i=this.recorderMap.get(e);if(null==i)return!1;var r=null;r="string"==typeof t?document.getElementById(t):t;var a=null;return a="string"==typeof n?document.getElementById(n):n,i.replay(r,a)}},{key:"getRecorder",value:function(e){return null==this.recorderMap?null:this.recorderMap.get(e)}},{key:"_videoProcess",value:function(e){for(var t=0;t<this.probes.length;++t){var n=this.probes[t];"open"==e?n.onVideoOpen():"close"==e&&n.onVideoClose()}}}]),t}(s.MediaService)},73:function(t,n,i){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0}),n.CallServiceWorker=void 0;var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=i(45),l=i(118),d=i(21),u=i(22),p=(i(44),i(119));i(46),i(47),n.CallServiceWorker=function(t){function n(e,t,i,o){r(this,n);var s=a(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,null,CELLET.Signaling));return s.delegate=new p.CallServiceDelegate(c.CallListener,e),s.localVideo=t,s.localVideo.muted=!0,s.remoteVideo=i,s.bellAudio=o,s.autoAnswer=!1,s.flagTerminated=!1,s.target=null,s.targetData=null,s.direction=null,s.videoEnabled=!0,s.state=u.SignalingState.None,s.sdpCache=null,s.audioBandwidth=70,s.videoBandwidth=512,s.bellAudioPaused=!1,s.isInitiator=!1,s.isStarted=!1,s.isChannelReady=!1,s.hasResponded=!1,s.localStream=null,s.remoteStream=null,s.pc=null,s.localVideoReady=null,s.remoteVideoReady=null,s.videoCloseHandler=null,s.pcConstraints={optional:[{DtlsSrtpKeyAgreement:!0}]},s.sdpConstraints={},s.candidateQueue=[],s.maxVideoSize=null,s.maxFrameRate=15,s.minFrameRate=8,s.iceTimer=0,s.iceTimeout=15e3,s.hangupTimer=0,s.hangupTimeout=5e3,s.replyCallback=null,s.replyTimer=0,s.saveCallSession=new HashMap,s.canAddIceCandidate=!1,s.lastIceServers=null,s._bodyOverflow=null,s._maskDom=null,s._maskHeight=1080,s.localVideo.addEventListener("loadeddata",function(e){"function"==typeof s.localVideoReady&&s.localVideoReady(s.localVideo,s)},!1),s.remoteVideo.addEventListener("loadeddata",function(e){"function"==typeof s.remoteVideoReady&&s.remoteVideoReady(s.remoteVideo,s)},!1),s.bellAudio&&s.bellAudio.addEventListener("loadeddata",function(e){s.bellAudioPaused||s.bellAudio.play()},!1),s}return o(n,t),s(n,[{key:"onStartup",value:function(){this.engine.sspMediaService=new CubeMediaServiceWorker(this)}},{key:"setAutoAnswer",value:function(e){this.autoAnswer=e}},{key:"answerCall",value:function(t){if(this.engine.session.callPeer.name.length<=4&&null!=this.engine.sipService)return this.engine.sipService.answer();if(!this.isChannelReady)return!1;if(this.isInitiator||null==this.sdpCache)return!1;this.flagTerminated=!1;var n=this,i=n._generateMediaConstraints();return"string"==typeof t&&(i.mandatory.chromeMediaSourceId=t),n.checkAndStart()&&(n.delegate.didProgress(n,n.target),n.pc.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:n.sdpCache}),function(){n.canAddIceCandidate=!0,n.drainCandidateQueue(),window.utils.getUserMedia(!!n.videoEnabled&&i,!0,function(e,t){e?(n.isStarted=!1,n.handleUserMediaError(e)):(n.handleUserMedia(t),n.pc.addStream(n.localStream),n.doAnswer())})},function(){n.onSignalingError(e)})),this._showMask(),!0}},{key:"makeCall",value:function(e,t,n){return this.engine.networkConnected&&this.isChannelReady?!(this.hangupTimer>0)&&(!this.engine.session.isCalling()&&(this.flagTerminated=!1,e=e.toString(),this.engine.session.callState=u.SignalingState.Progress,this.engine.session.setCallPeer(new CubePeer(e)),this.invite(e,t))):(this.delegate.didFailed(this,this.target,CubeStateCode.NetworkNotReachable),!1)}},{key:"terminateCall",value:function(){this.flagTerminated=!0;return this.hangup()||!1}},{key:"tryHold",value:function(e,t){}},{key:"_generateMediaConstraints",value:function(){var e=320,t=240;null!=this.maxVideoSize&&(void 0!==this.maxVideoSize.width&&(e=this.maxVideoSize.width),void 0!==this.maxVideoSize.height&&(t=this.maxVideoSize.height)),Logger.d("SignalingWorker","Camera resolution: "+e+"x"+t);var n={mandatory:{maxWidth:e,maxHeight:t,minWidth:160,minHeight:120,maxFrameRate:this.maxFrameRate,minFrameRate:this.minFrameRate}};return window.utils.isFirefox&&(n=parseInt(webrtcAdapter.detectBrowser.result.version)<43?{width:{min:160,max:e},height:{min:120,max:t},frameRate:{min:this.minFrameRate,max:this.maxFrameRate},require:["width","height","frameRate"]}:{width:e,height:t,frameRate:this.minFrameRate}),n}},{key:"invite",value:function(e,t){var n=this;if(!this.isChannelReady)return!1;this.hasResponded=!1,this.lastIceServers=_CUBE_STUN_SERVERS,this.target=e.toString(),this.isInitiator=!0,this.direction=d.CallDirection.Outgoing,this.videoEnabled=!1!==t,this.state=u.SignalingState.Invite,this.delegate.didInvite(this,this.direction,this.target,this.videoEnabled);var i=this._generateMediaConstraints();return"string"==typeof t&&(i.mandatory.chromeMediaSourceId=t),this.checkAndStart()?(this.delegate.didProgress(this,this.target),window.utils.getUserMedia(!!this.videoEnabled&&i,!0,function(e,t){e?(n.isStarted=!1,n.handleUserMediaError(e)):(n.handleUserMedia(t),n.pc.addStream(n.localStream))})):this.delegate.didFailed(this,this.target,CubeStateCode.SignalingStartError),Logger.d("SignalingWorker","Getting user media with constraints"),this._showMask(),!0}},{key:"changeMediaDevice",value:function(e){if(this.videoEnabled){var t=this._generateMediaConstraints();"string"==typeof e&&(t.mandatory.chromeMediaSourceId=e)}}},{key:"hangup",value:function(){if(this.state==u.SignalingState.None)return!1;this.hangupTimer>0&&clearTimeout(this.hangupTimer);var e=this,t=this.target.toString();if(this.hangupTimer=setTimeout(function(){clearTimeout(e.hangupTimer),e.hangupTimer=0,e.delegate.didEnd(e,t,"bye-ack")},this.hangupTimeout),this.state==u.SignalingState.Incall){var n=new ActionDialect;n.setAction(CubeConst.ActionBye),n.appendParam("param",{call:this.target}),nucleus.talkService.talk(CELLET.Signaling,n),this._cleanCall()}else if(this.state==u.SignalingState.Invite||this.state==u.SignalingState.Ringing){var n=new ActionDialect;n.setAction(CubeConst.ActionCancel),n.appendParam("param",{call:this.target}),nucleus.talkService.talk(CELLET.Signaling,n),this._cleanCall()}else{var n=new ActionDialect;n.setAction(CubeConst.ActionBye),n.appendParam("param",{call:this.target}),nucleus.talkService.talk(CELLET.Signaling,n),this._cleanCall()}return this.hasResponded=!1,!0}},{key:"_cleanCall",value:function(){this.canAddIceCandidate=!1,this.iceTimer>0&&(clearTimeout(this.iceTimer),this.iceTimer=0),null!=this.bellAudio&&(this.bellAudioPaused=!0,this.bellAudio.pause());try{utils.isIE||utils.isSafari?(this.localVideo=document.getElementById(this.localVideo.id),window.attachMediaStream(this.localVideo,null)):this.localVideo.src=""}catch(e){Logger.w("SignalingWorker#clean",e.message)}try{utils.isIE||utils.isSafari?(this.remoteVideo=document.getElementById(this.remoteVideo.id),window.attachMediaStream(this.remoteVideo,null)):this.remoteVideo.src=""}catch(e){Logger.w("SignalingWorker#clean",e.message)}if(null!=this.localStream){try{this.localStream.stop()}catch(e){}try{this.localStream.getAudioTracks()[0].stop(),this.localStream.getVideoTracks()[0]&&this.localStream.getVideoTracks()[0].stop()}catch(e){}this.localStream=null}if(null!=this.remoteStream){try{this.remoteStream.getAudioTracks()[0].stop(),this.remoteStream.getVideoTracks()[0]&&this.remoteStream.getVideoTracks()[0].stop()}catch(e){Logger.w("SignalingWorker#clean",e.message)}this.remoteStream=null}if(null!=this.pc){try{"closed"!==this.pc.signalingState&&this.pc.close()}catch(e){Logger.w("SignalingWorker#clean",e.message)}this.pc=null}this.direction=null,this.target=null,this.targetData=null,this.state=u.SignalingState.None,this.isInitiator=!1,this.isStarted=!1,this.sdpCache=null}},{key:"onRegisterStateChanged",value:function(e){e.regState==CubeRegistrationState.Ok?this.isChannelReady=!0:(this.isChannelReady=!1,this.hangup())}},{key:"tryReInvite",value:function(){if(TalkService.getInstance().isCalled(CELLET.Signaling)){var e=new ActionDialect;e.setAction(CubeConst.ActionTryReInvite),nucleus.talkService.talk(CELLET.Signaling,e)}}},{key:"onDialogue",value:function(e,t){e==CubeConst.ActionInviteAck?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionInviteAck),this._processInviteAck(t)):e==CubeConst.ActionInvite?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionInvite),this._processInvite(t)):e==CubeConst.ActionAnswerAck?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionAnswerAck),this._processAnswerAck(t)):e==CubeConst.ActionAnswer?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionAnswer),this._processAnswer(t)):e==CubeConst.ActionByeAck?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionByeAck),this._processByeAck(t)):e==CubeConst.ActionBye?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionBye),this._processBye(t)):e==CubeConst.ActionCancelAck?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionCancelAck),this._processCancelAck(t)):e==CubeConst.ActionCancel?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionCancel),this._processCancel(t)):e==CubeConst.ActionCandidate?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionCandidate),this._processCandidate(t)):e==CubeConst.ActionCandidateAck?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionCandidateAck),this._processCandidateAck(t)):e==CubeConst.ActionConsult?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionConsult),this._processConsult(t)):e==CubeConst.ActionConsultAck?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionConsultAck),this._processConsultAck(t)):e==CubeConst.ActionReply?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionReply),this._processReply(t)):e==CubeConst.ActionReplyAck?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionReplyAck),this._processReplyAck(t)):e==CubeConst.ActionTryReInviteAck?(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionTryReInviteAck),this._processTryReInviteAck(t)):e==CubeConst.ActionReverseCall&&(Logger.d("SignalingWorker#onDialogue",CubeConst.ActionReverseCall),this._processReverseCall(t))}},{key:"setBandwidth",value:function(e,t){this.audioBandwidth=e,this.videoBandwidth=t}},{key:"getLocalVideo",value:function(){return this.localVideo}},{key:"getRemoteVideo",value:function(){return this.remoteVideo}},{key:"consult",value:function(e,t){if(this.state!=u.SignalingState.Incall)return!1;var n=this.engine.session.callPeer.name.toString(),i={ver:1,media:e,operation:t},r=new ActionDialect;return r.setAction(CubeConst.ActionConsult),r.appendParam("param",{peer:n,payload:i}),nucleus.talkService.talk(CELLET.Signaling,r)}},{key:"reply",value:function(e,t,n){if(this.replyTimer>0)return!1;this.replyCallback=n;var i=this;this.replyTimer=setTimeout(function(){clearTimeout(i.replyTimer),i.replyTimer=0,i.replyCallback.call(null,!1,e,null)},t);var r={target:e,originate:Date.now()},a=new ActionDialect;return a.setAction(CubeConst.ActionReply),a.appendParam("param",r),nucleus.talkService.talk(CELLET.Signaling,a)}},{key:"checkAndStart",value:function(){return!this.isStarted&&(!!this.createPeerConnection()&&(this.isStarted=!0,!0))}},{key:"createPeerConnection",value:function(){var e=this;try{var t={iceServers:e.lastIceServers};e.pc=new RTCPeerConnection(t,e.pcConstraints),e.pc.onicecandidate=function(t){e.handleIceCandidate(t)},e.pc.oniceconnectionstatechange=function(t){e.handleIceConnectionStateChange(t)},e.pc.onconnectionstatechange=function(t){e.handleConnectionStateChange(t)},e.pc.onnegotiationneeded=function(){e.isInitiator&&e.doCall()}}catch(t){return Logger.d("SignalingWorker","Failed to create PeerConnection, exception: "+t.message),e.delegate.didFailed(e,e.target,CubeStateCode.RTCInitializeFailed),e._cleanCall(),!1}return e.pc.onaddstream=function(t){e.handleRemoteStreamAdded(t)},e.pc.onremovestream=function(t){e.handleRemoteStreamRemoved(t)},!0}},{key:"doCall",value:function(){Logger.d("SignalingWorker","Creating Offer...");var e=this;e.pc.createOffer(function(t){t.sdp=e._fixSdp(t.sdp),e.setLocalAndSendInvite(t)},function(t){e.onSignalingError(t)},e.sdpConstraints)}},{key:"doAnswer",value:function(){Logger.d("SignalingWorker","Creating Answer...");var e=this;e.pc.createAnswer(function(t){t.sdp=e._fixSdp(t.sdp),e.setLocalAndSendAnswer(t)},function(t){e.onSignalingError(t)},e.sdpConstraints)}},{key:"setLocalAndSendInvite",value:function(t){var n=this;this.pc.setLocalDescription(t,function(){var e=new ActionDialect;e.setAction(CubeConst.ActionInvite),e.appendParam("param",{callee:n.target,sdp:n.pc.localDescription.sdp,ICEServers:_CUBE_ICE_SERVERS}),nucleus.talkService.talk(CELLET.Signaling,e)?n.hasResponded=!0:(n.hasResponded=!1,setTimeout(function(){n.delegate.didFailed(n,n.target,CubeStateCode.SignalingStartError),n._cleanCall()},8e3)),Logger.d("SignalingWorker#setLocalAndSendInvite","Offer:\n"+n.pc.localDescription.sdp)},function(t){Logger.e("SignalingWorker","set local description error: "+t),n.onSignalingError(e)})}},{key:"setLocalAndSendAnswer",value:function(t){var n=this;this.pc.setLocalDescription(t,function(){var e=new ActionDialect;e.setAction(CubeConst.ActionAnswer),e.appendParam("param",{caller:n.target,sdp:n.pc.localDescription.sdp});var t=nucleus.talkService.talk(CELLET.Signaling,e);n.drainCandidateQueue(),t?n.hasResponded=!0:(n.hasResponded=!1,n.delegate.didFailed(n,n.target,CubeStateCode.SignalingStartError),n.hangup()),Logger.d("SignalingWorker#setLocalAndSendAnswer","Answer:\n"+n.pc.localDescription.sdp)},function(t){Logger.e("SignalingWorker","set local description error: "+t),n.onSignalingError(e)})}},{key:"attachMediaStream",value:function(e,t){if((utils.isIE||utils.isSafari)&&window.attachMediaStream)return void window.attachMediaStream(e,t);e.onloadedmetadata=function(t){e.play()},window.URL?e.src=window.URL.createObjectURL(t):e.src=t}},{key:"handleUserMedia",value:function(e){this.localStream=e,this.attachMediaStream(this.localVideo,e),(utils.isIE||utils.isSafari)&&"video"==this.localVideo.tagName.toLowerCase()&&(this.localVideo=document.getElementById(this.localVideo.id)),this.localVideo.muted=!0,this.localVideo.controls=!1,Logger.d("SignalingWorker","Adding local stream."),this._closeMask()}},{key:"handleUserMediaError",value:function(e){var t=this;this._closeMask(),Logger.e("SignalingWorker","Navigator.getUserMedia error"),this.hangup(),window.utils.getUserMedia(!1,!0,function(e,n){e?t.delegate.didFailed(t,t.target,CubeStateCode.MicphoneOpenFailed):(window.utils.closeMediaStream(n),t.delegate.didFailed(t,t.target,CubeStateCode.CameraOpenFailed))})}},{key:"handleIceCandidate",value:function(e){if(e.candidate){var t=new ActionDialect;t.setAction(CubeConst.ActionCandidate),t.appendParam("param",{peer:this.target,candidate:{sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex,sdp:e.candidate.candidate}}),nucleus.talkService.talk(CELLET.Signaling,t)}else Logger.d("SignalingWorker","End of candidates.")}},{key:"handleIceConnectionStateChange",value:function(e){if(null!=this.pc){var t=this.pc.iceConnectionState;null!=t&&void 0!==t&&("failed"==t?(Logger.w("CubeCallService#handleIceConnectionStateChange","Ice connection state change - state is "+t+", hasResponded is "+this.hasResponded),this.hasResponded&&this.hangup(),this.delegate.didFailed(this,this.target,CubeStateCode.ICEConnectionFailed)):"disconnected"!=t&&"closed"!=t||(this.delegate.didEnd(this,this.target,"end"),this._cleanCall()))}}},{key:"handleConnectionStateChange",value:function(e){switch(this.pc.connectionState){case"connected":Logger.d("CallService","State: connected");break;case"disconnected":Logger.d("CallService","State: disconnected");break;case"failed":Logger.d("CallService","State: failed");break;case"closed":Logger.d("CallService","State: closed")}}},{key:"handleRemoteStreamAdded",value:function(e){try{null!=this.bellAudio&&(this.bellAudioPaused=!0,this.bellAudio.pause())}catch(e){}this.iceTimer>0&&(clearTimeout(this.iceTimer),this.iceTimer=0),this.remoteStream=e.stream,this.attachMediaStream(this.remoteVideo,e.stream),(utils.isIE||utils.isSafari)&&"video"==this.remoteVideo.tagName.toLowerCase()&&(this.remoteVideo=document.getElementById(this.remoteVideo.id))}},{key:"handleRemoteStreamRemoved",value:function(e){Logger.d("SignalingWorker","Remote stream removed. Event: "+e),this.iceTimer>0&&(clearTimeout(this.iceTimer),this.iceTimer=0)}},{key:"drainCandidateQueue",value:function(){for(var e=0;e<this.candidateQueue.length;++e){var t=this.candidateQueue[e];this.pc.addIceCandidate(t)}this.candidateQueue.splice(0,this.candidateQueue.length),this.candidateQueue=[]}},{key:"onSignalingError",value:function(e){Logger.w("SignalingWorker#onSignalingError","Failed to create signaling message : "+e.name),this.hasResponded&&(this.delegate.didFailed(this,this.target,CubeStateCode.WorkerStateException),this.hangup())}},{key:"_setBandwidth",value:function(e){return e=e.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+this.audioBandwidth+"\r\n"),e=e.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+this.videoBandwidth+"\r\n"),e=e.replace(/a=mid:sdparta_0\r\n/g,"a=mid:sdparta_0\r\nb=AS:"+this.audioBandwidth+"\r\n"),e=e.replace(/a=mid:sdparta_1\r\n/g,"a=mid:sdparta_1\r\nb=AS:"+this.videoBandwidth+"\r\n")}},{key:"_fixSdp",value:function(e){return this._setBandwidth(e)}},{key:"_processInviteAck",value:function(e){var t=e.getParam("state"),n=t.code;if(n<200||n>299)return Logger.w("CubeCallService#_processInviteAck","In error code is:"+n),this.delegate.didFailed(this,this.target,n),void this._cleanCall();if(200!=n&&Logger.w("CubeCallService#_processInviteAck","A state code that has no effect : "+n),this.direction==d.CallDirection.Outgoing){var i=e.getParam("callee");this.targetData=e.getParam("calleeData"),this.state=u.SignalingState.Ringing,this.delegate.didRinging(this,i),null!=this.bellAudio&&(this.bellAudioPaused=!1,this.bellAudio.loop=!0,this.bellAudio.src=cube.resourcePath+"/sounds/ringbacktone.ogg")}}},{key:"_processInvite",value:function(e){if(this.engine.session.isCalling())return void Logger.d("CallServiceWorker#_processInvite",e.getParam("caller")+"-Peer is calling me");if(this.state==u.SignalingState.None){this.isInitiator=!1,this.direction=d.CallDirection.Incoming,this.state=u.SignalingState.Invite,null!=this.bellAudio&&(this.bellAudioPaused=!1,this.bellAudio.loop=!0,this.bellAudio.src=cube.resourcePath+"/sounds/ringtone.ogg");var t=e.getParam("data"),n=t.caller,i=t.sdp,r=t.ICEServers;this.lastIceServers=null!=r?this.engine._parseICEServers(r):_CUBE_STUN_SERVERS,this.sdpCache=i;var a=!1;i.indexOf("m=video")>=0&&(a=!0),this.videoEnabled=a,this.target=n.toString(),this.targetData=e.getParam("callerData");var o=this;o.autoAnswer&&setTimeout(function(){o.answerCall()},60),this.delegate.didInvite(this,this.direction,this.target,a)}else Logger.e("SignalingWorker#_processInvite","Signaling state error: "+this.state)}},{key:"_processAnswerAck",value:function(e){null!=this.bellAudio&&(this.bellAudioPaused=!0,this.bellAudio.pause());var t=e.getParam("state");if(t.code<200||t.code>299)return this.delegate.didFailed(this,this.target,t.code),void this.hangup();if(200!=t.code&&Logger.w("CubeCallService#_processInviteAck","A state code that has no effect : "+t.code),this.direction==d.CallDirection.Incoming){var n=e.getParam("caller");this.state=u.SignalingState.Incall,this.delegate.didIncall(this,this.direction,n,null)}}},{key:"_processAnswer",value:function(e){if(this.direction==d.CallDirection.Outgoing){var t=e.getParam("callee"),n=e.getParam("sdp"),i=this;i.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:n}),function(){i.canAddIceCandidate=!0,i.drainCandidateQueue()}),this.state=u.SignalingState.Incall,null!=this.bellAudio&&(this.bellAudioPaused=!0,this.bellAudio.pause()),this.delegate.didIncall(this,this.direction,t,n),this.iceTimer>0&&clearTimeout(this.iceTimer),this.iceTimer=setTimeout(function(){clearTimeout(i.iceTimer),i.iceTimer=0,console.log("超时断开"),i.delegate.didFailed(i,i.target,CubeStateCode.ICEConnectionFailed),i.hangup()},this.iceTimeout)}}},{key:"_processByeAck",value:function(e){this.hangupTimer>0&&(clearTimeout(this.hangupTimer),this.hangupTimer=0),this.delegate.didEnd(this,this.target,"bye-ack"),this._cleanCall()}},{key:"_processCancelAck",value:function(e){this.hangupTimer>0&&(clearTimeout(this.hangupTimer),this.hangupTimer=0),this.delegate.didEnd(this,this.target,"cancel-ack"),this._cleanCall()}},{key:"_processBye",value:function(e){this.state!=u.SignalingState.None&&(this.delegate.didEnd(this,this.target,"bye"),this._cleanCall())}},{key:"_processCancel",value:function(e){if(this.state!=u.SignalingState.None){var t=e.getParam("data");if(null===this.engine.session.getCallPeer()||t.call===this.engine.session.getCallPeer().name){var n=e.getParam("reason"),i="cancel";null!==n&&(n.code===CubeStateCode.AnswerByOther?i="answer-by-other":n.code===CubeStateCode.CancelByOther&&(i="cancel-by-other")),this.delegate.didEnd(this,this.target,i),this._cleanCall()}}}},{key:"_processCandidate",value:function(e){var t=e.getParam("candidate"),n=new RTCIceCandidate({sdpMLineIndex:t.sdpMLineIndex,sdpMid:t.sdpMid,candidate:t.sdp});this.canAddIceCandidate?this.pc.addIceCandidate(n):this.candidateQueue.push(n)}},{key:"_processCandidateAck",value:function(e){}},{key:"_processTryReInviteAck",value:function(e){Logger.d("CallServiceWorker#_processTryReInviteAck",e.getParam("state").code)}},{key:"_processReverseCall",value:function(e){var t=this;null!==this.localStream&&(window.utils.closeMediaStream(this.localStream),this.delegate.didEnd(this,this.target,"end"),this._cleanCall());var n=e.getParam("caller"),i=e.getParam("sdp");this.target=n.toString(),this.sdpCache=i,setTimeout(function(){t.answerCall()},60),this.delegate.didReverseCall(this,this.target)}},{key:"_processConsult",value:function(e){var t=e.getParam("peer"),n=e.getParam("payload");if(t===this.engine.session.callPeer.name){if(1===n.ver&&"video"===n.media){if("close"===n.operation)try{this.localStream.getVideoTracks()[0].enabled=!1}catch(e){}else if("open"===n.operation)try{this.localStream.getVideoTracks()[0].enabled=!0}catch(e){}window.cube.getMediaService()._videoProcess(n.operation)}}else Logger.w("SignalingWorker#_processConsult","Session peer error: "+t)}},{key:"_processConsultAck",value:function(e){}},{key:"_processReply",value:function(e){var t=new ActionDialect;t.setAction(CubeConst.ActionReplyAck),t.appendParam("from",this.engine.session.name.toString()),t.appendParam("to",e.getParam("from")),t.appendParam("time",e.getParam("time")),nucleus.talkService.talk(CELLET.Signaling,t)}},{key:"_processReplyAck",value:function(e){var t=Date.now();this.replyTimer>0&&(clearTimeout(this.replyTimer),this.replyTimer=0);var n=e.getParam("time");n.local=t,n.remoteLatency=n.transmit-n.reference,n.localLatency=t-n.originate-(n.transmit-n.receive),null!=this.replyCallback&&this.replyCallback.call(null,!0,e.getParam("from"),n)}},{key:"_showMask",value:function(){this._closeMask(),this._bodyOverflow=document.body.style.overflow;var e=window.innerWidth,t=parseInt(window.innerHeight)+70;if(t>this._maskHeight&&(this._maskHeight=t),document.body.style.overflow="hidden",null==this._maskDom){var n=document.createElement("div");n.id="_cube_mask_",n.style.position="absolute",n.style.styleFloat="left",n.style.cssFloat="left",n.style.left="0px",n.style.top="0px",n.style.width=e+"px",n.style.height=this._maskHeight+"px",n.style.zIndex=9999,n.style.opacity=.6,n.style.mozOpacity=.6,n.style.webkitOpacity=.6,n.style.background="#000";var i=this;n.addEventListener("dblclick",function(e){i._closeMask()},!1),this._maskDom=n}else this._maskDom.style.left="0px",this._maskDom.style.top="0px",this._maskDom.style.width=e+"px",this._maskDom.style.height=this._maskHeight+"px";document.body.appendChild(this._maskDom)}},{key:"_closeMask",value:function(){null!=this._bodyOverflow&&(document.body.removeChild(this._maskDom),document.body.style.overflow=this._bodyOverflow,this._bodyOverflow=null)}},{key:"onConfigure",value:function(e){this.maxVideoSize=e.videoSize,this.minFrameRate=e.frameRate.min,this.maxFrameRate=e.frameRate.max,this.setBandwidth(e.bandwidth.audio,e.bandwidth.video)}}]),n}(l.CallService)}});
//# sourceMappingURL=cube-signaling.js.map